---
title: "Larval Phenoplate Analysis" 
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

# Setup  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("scales" %in% rownames(installed.packages()) == 'FALSE') install.packages('scales') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("effects" %in% rownames(installed.packages()) == 'FALSE') install.packages('effects') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 
if ("ggstatsplot" %in% rownames(installed.packages()) == 'FALSE') remotes::install_github("IndrajeetPatil/ggstatsplot")
if ("nls.multstart" %in% rownames(installed.packages()) == 'FALSE') install.packages('nls.multstart')
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom')
if ("readxl" %in% rownames(installed.packages()) == 'FALSE') install.packages('readxl')

#load packages
library("ggplot2")
library("tidyverse")
library('car')
library('lme4')
library('lmerTest')
library('scales')
library('cowplot')
library('ggstatsplot')
library('nls.multstart')
library('broom')
library('emmeans')
library('readxl')
#library('multcomp')
library('dplyr')
library("tidyverse")
```

# Load data 

Load each data frame to extract O2 Fm, FvFm, and NPQ values. Also extract metadata for light and temperature treatment profiles.  

Turn each data frame to long form, add identifying columns, and join all data together. Prepare each data frame and join together in a running list.  

## C Cold Plate 

Read in data files for C Cold plate 
```{r}
c_cold_O2_fm<-read_xlsx(path="data/phenoplate_oxygen/C-Cold-Plate.xlsx", sheet="df_O2_Fm")
c_cold_QY<-read_xlsx(path="data/phenoplate_oxygen/C-Cold-Plate.xlsx", sheet="df_QY")
c_cold_NPQ<-read_xlsx(path="data/phenoplate_oxygen/C-Cold-Plate.xlsx", sheet="df_NPQ")
c_cold_well_metadata<-read_xlsx(path="data/phenoplate_oxygen/C-Cold-Plate.xlsx", sheet="metadata_wells")
```

Prepare data frames. Make the data frame in a long version, attach metadata, and add column specifying the metric. 
```{r}
c_cold_O2_fm<-c_cold_O2_fm%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="O2_Fm_raw")%>%
  left_join(., c_cold_well_metadata)

c_cold_QY<-c_cold_QY%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="QY")%>%
  left_join(., c_cold_well_metadata)

c_cold_NPQ<-c_cold_NPQ%>%
  rename(Time=`Time (min)`)%>%
pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="NPQ_raw")%>%
  left_join(., c_cold_well_metadata)

c_cold<- c_cold_O2_fm%>%
  left_join(c_cold_QY, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont")) %>%
  left_join(c_cold_NPQ, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont"))

c_cold$Plate<-"C-Cold"
```

## C Warm Plate

Read in data files for C Warm plate 
```{r}
c_warm_O2_fm<-read_xlsx(path="data/phenoplate_oxygen/C-Warm-Plate.xlsx", sheet="df_O2_Fm")
c_warm_QY<-read_xlsx(path="data/phenoplate_oxygen/C-Warm-Plate.xlsx", sheet="df_QY")
c_warm_NPQ<-read_xlsx(path="data/phenoplate_oxygen/C-Warm-Plate.xlsx", sheet="df_NPQ")
c_warm_well_metadata<-read_xlsx(path="data/phenoplate_oxygen/C-Warm-Plate.xlsx", sheet="metadata_wells")
```

Prepare data frames. Make the data frame in a long version, attach metadata, and add column specifying the metric.

```{r}
c_warm_O2_fm<-c_warm_O2_fm%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="O2_Fm_raw")%>%
  left_join(., c_warm_well_metadata)

c_warm_QY<-c_warm_QY%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="QY")%>%
  left_join(., c_warm_well_metadata)

c_warm_NPQ<-c_warm_NPQ%>%
  rename(Time=`Time (min)`)%>%
pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="NPQ_raw")%>%
  left_join(., c_warm_well_metadata)

c_warm<- c_warm_O2_fm%>%
  left_join(c_warm_QY, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont")) %>%
  left_join(c_warm_NPQ, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont"))

c_warm$Plate<-"C-Warm"
```

## MIX Cold Plate

Read in data files for MIX Cold plate 
```{r}
mix_cold_O2_fm<-read_xlsx(path="data/phenoplate_oxygen/Mix-Cold-Plate.xlsx", sheet="df_O2_Fm")
mix_cold_QY<-read_xlsx(path="data/phenoplate_oxygen/Mix-Cold-Plate.xlsx", sheet="df_QY")
mix_cold_NPQ<-read_xlsx(path="data/phenoplate_oxygen/Mix-Cold-Plate.xlsx", sheet="df_NPQ")
mix_cold_well_metadata<-read_xlsx(path="data/phenoplate_oxygen/Mix-Cold-Plate.xlsx", sheet="metadata_wells")
```

Prepare data frames. Make the data frame in a long version, attach metadata, and add column specifying the metric. 
```{r}
mix_cold_O2_fm<-mix_cold_O2_fm%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="O2_Fm_raw")%>%
  left_join(., mix_cold_well_metadata)

mix_cold_QY<-mix_cold_QY%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="QY")%>%
  left_join(., mix_cold_well_metadata)

mix_cold_NPQ<-mix_cold_NPQ%>%
  rename(Time=`Time (min)`)%>%
pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="NPQ_raw")%>%
  left_join(., mix_cold_well_metadata)

mix_cold<- mix_cold_O2_fm%>%
  left_join(mix_cold_QY, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont")) %>%
  left_join(mix_cold_NPQ, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont"))

mix_cold$Plate<-"MIX-Cold"
```

## MIX Warm Plate

Read in data files for MIX Warm plate 
```{r}
mix_warm_O2_fm<-read_xlsx(path="data/phenoplate_oxygen/Mix-Warm-Plate.xlsx", sheet="df_O2_Fm")
mix_warm_QY<-read_xlsx(path="data/phenoplate_oxygen/Mix-Warm-Plate.xlsx", sheet="df_QY")
mix_warm_NPQ<-read_xlsx(path="data/phenoplate_oxygen/Mix-Warm-Plate.xlsx", sheet="df_NPQ")
mix_warm_well_metadata<-read_xlsx(path="data/phenoplate_oxygen/Mix-Warm-Plate.xlsx", sheet="metadata_wells")
```

Prepare data frames. Make the data frame in a long version, attach metadata, and add column specifying the metric. 
```{r}
mix_warm_O2_fm<-mix_warm_O2_fm%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="O2_Fm_raw")%>%
  left_join(., mix_warm_well_metadata)

mix_warm_QY<-mix_warm_QY%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="QY")%>%
  left_join(., mix_warm_well_metadata)

mix_warm_NPQ<-mix_warm_NPQ%>%
  rename(Time=`Time (min)`)%>%
pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="NPQ_raw")%>%
  left_join(., mix_warm_well_metadata)

mix_warm<- mix_warm_O2_fm%>%
  left_join(mix_warm_QY, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont")) %>%
  left_join(mix_warm_NPQ, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont"))

mix_warm$Plate<-"MIX-Warm"
```

## WT Cold Plate

Read in data files for WT Cold plate 
```{r}
wt_cold_O2_fm<-read_xlsx(path="data/phenoplate_oxygen/WT-Cold-Plate.xlsx", sheet="df_O2_Fm")
wt_cold_QY<-read_xlsx(path="data/phenoplate_oxygen/WT-Cold-Plate.xlsx", sheet="df_QY")
wt_cold_NPQ<-read_xlsx(path="data/phenoplate_oxygen/WT-Cold-Plate.xlsx", sheet="df_NPQ")
wt_cold_well_metadata<-read_xlsx(path="data/phenoplate_oxygen/WT-Cold-Plate.xlsx", sheet="metadata_wells")
```

Prepare data frames. Make the data frame in a long version, attach metadata, and add column specifying the metric. 
```{r}
wt_cold_O2_fm<-wt_cold_O2_fm%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="O2_Fm_raw")%>%
  left_join(., wt_cold_well_metadata)

wt_cold_QY<-wt_cold_QY%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="QY")%>%
  left_join(., wt_cold_well_metadata)

wt_cold_NPQ<-wt_cold_NPQ%>%
  rename(Time=`Time (min)`)%>%
pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="NPQ_raw")%>%
  left_join(., wt_cold_well_metadata)

wt_cold<- wt_cold_O2_fm%>%
  left_join(wt_cold_QY, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont")) %>%
  left_join(wt_cold_NPQ, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont"))

wt_cold$Plate<-"WT-Cold"
```

## WT Warm Plate

Read in data files for WT Warm plate 
```{r}
wt_warm_O2_fm<-read_xlsx(path="data/phenoplate_oxygen/WT-Warm-Plate.xlsx", sheet="df_O2_Fm")
wt_warm_QY<-read_xlsx(path="data/phenoplate_oxygen/WT-Warm-Plate.xlsx", sheet="df_QY")
wt_warm_NPQ<-read_xlsx(path="data/phenoplate_oxygen/WT-Warm-Plate.xlsx", sheet="df_NPQ")
wt_warm_well_metadata<-read_xlsx(path="data/phenoplate_oxygen/WT-Warm-Plate.xlsx", sheet="metadata_wells")
```

Prepare data frames. Make the data frame in a long version, attach metadata, and add column specifying the metric. 
```{r}
wt_warm_O2_fm<-wt_warm_O2_fm%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="O2_Fm_raw")%>%
  left_join(., wt_warm_well_metadata)

wt_warm_QY<-wt_warm_QY%>%
  rename(Time=`Time (min)`)%>%
  pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="QY")%>%
  left_join(., wt_warm_well_metadata)

wt_warm_NPQ<-wt_warm_NPQ%>%
  rename(Time=`Time (min)`)%>%
pivot_longer(names_to="well", cols=`Area 1`:`Area 24`, values_to="NPQ_raw")%>%
  left_join(., wt_warm_well_metadata)

wt_warm<- wt_warm_O2_fm%>%
  left_join(wt_warm_QY, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont")) %>%
  left_join(wt_warm_NPQ, by = c("well", "Time", "Light", "Gradient_Temperature", "Symbiont"))

wt_warm$Plate<-"WT-Warm"
```

## Join all files together 

Join together. 
```{r}
df<-full_join(c_cold, c_warm)
df<-full_join(df, mix_cold)
df<-full_join(df, mix_warm)
df<-full_join(df, wt_cold)
df<-full_join(df, wt_warm)

df$code<-paste(df$Plate, df$well)
```

Change to factors. 
```{r}
df$Gradient_Temperature<-as.factor(df$Gradient_Temperature)
df$Symbiont<-as.factor(df$Symbiont)
```

# Perform calculations 

## O2 Fm

Normalize each O2 observation to the first measurement at Time 0 for each well. Calculate the inverse value such that a higher Y axis value indicates more oxygen. This will make it easier to interpret. 
```{r}
df<-df%>%
  group_by(Plate, well)%>%
  mutate(O2_Fm_norm=O2_Fm_raw-first(O2_Fm_raw))%>%
  mutate(O2_Fm_norm=-1*O2_Fm_norm)
```

## QY

QY (relative quantum yield) values do not require any normalization. 

## NPQ

First calculate Fm for each well as average of values from the first 15 min dark period. Then calculate NPQ as (Fm-value)/value. 

```{r}
df <- df %>%
  # Filter rows where Time is within the first 15 minutes
  filter(Time <= 14.99) %>%
  # Group by 'well'
  group_by(Plate, well, code) %>%
  # Calculate the average of 'NPQ_raw' for each 'well'
  summarize(Fm = mean(NPQ_raw, na.rm = TRUE)) %>%
  # Join the calculated averages back to the original data
  left_join(df, by = c("Plate", "well", "code")) %>%
  # Calculate the 'NPQ_norm' column
  mutate(NPQ_norm = (Fm - NPQ_raw) / NPQ_raw)
```

# Set color palettes

Create colour palette for temperatures. 
```{r}
# Define the number of colors in the palette
num_colors <- 12

# Create a color palette from dark blue to dark red
palette <- colorRampPalette(c("darkblue", "lightblue", "red1", "darkred"))(num_colors)
```

Set custom theme for panel plots. 
```{r}
custom_theme<-theme(text=element_text(size=20, face="bold", color="black"), 
        axis.text=element_text(size=18, color="black"), 
        legend.position="none", 
        )
```

Make a light plot to add onto the bottom of each plot for reference. 
```{r}
light_plot<-df%>%
  dplyr::select(Time, Light)%>%
  group_by(Time, Light)%>%
  summarise(Light=mean(Light, na.rm=TRUE))%>%
  
  ggplot(aes(y=Light, x=Time))+
  geom_line(colour="black", linewidth=2)+
  geom_text(label="Dark (26°C)", x=8, y=250, size=4)+
  geom_text(label="Light (26°C)", x=22, y=600, size=4)+
  geom_text(label="Dark \n[T Gradient]", x=36, y=250, size=4)+
  geom_text(label="Low Light \n[T Gradient]", x=45, y=250, size=4)+
  geom_text(label="Rapid Light Curve \n[T Gradient]", x=58, y=1400, size=4)+
  geom_text(label="Low Light \nRecovery \n(26°C)", x=70, y=400, size=4)+
  theme_classic()+
  custom_theme+
  ylim(0, 1650)+
  xlab("Time (min)")+
  ylab("Light (PAR)");light_plot
```

Set names for parent phenotypes. 
```{r}
parent_names<-c("C"="Susceptible (C)", "MIX"="Resistant (C/D)", "WT"="Wildtype (C/D)")
```

# Oxygen QC check    

Load a dataframe of start and end times for each phase from the treatment metadata. 
```{r}
treatments<-read_csv(file="data/phenoplate_oxygen/treatment_metadata.csv")
```

Add a column for the phase of each observation in our data frame. 

```{r}
get_phase <- function(Time) {
  matching_phase <- treatments$Phase[Time >= treatments$Time.Start & Time <= treatments$Time.End]
  if (length(matching_phase) > 0) {
    return(matching_phase[1])
  } else {
    return(NA)
  }
}

df$Phase <- sapply(df$Time, get_phase)
```

Select only required columns. 

```{r}
df<-df%>%
  dplyr::select(Plate, well, code, Time, Light, Gradient_Temperature, Symbiont, O2_Fm_norm, NPQ_norm, QY, Phase)
```

Plot the data from the PI Curve faceted by parent type.

```{r}
pi_plot1<-df%>%
  filter(Phase=="Rapid light curve - Temp Gradient")%>%
  group_by(Symbiont, Phase, Time, Light, Gradient_Temperature)%>%
  summarise(mean=mean(O2_Fm_norm, na.rm=TRUE), se=sd(O2_Fm_norm, na.rm=TRUE)/sqrt(length(O2_Fm_norm)))%>%
  
  ggplot(aes(x=Time, y=mean, colour=Gradient_Temperature, fill=Gradient_Temperature))+
  facet_grid(~Symbiont, labeller = as_labeller(parent_names))+
  geom_ribbon(aes(ymin = mean - se, ymax = mean + se), alpha=0.2, linewidth=0) +
  geom_line(aes(y = mean), linewidth=2)+
  xlab("Time (min)")+
  ylab("Oxygen Concentration [-1*rel Fm]")+
  ggtitle("PI Curve")+
  scale_colour_manual(values=palette, name="Gradient \nTemperature")+
  scale_fill_manual(values=palette, name="Gradient \nTemperature")+
  ylim(1000, 14000)+
  theme_classic()+
  theme(legend.position="none", 
        text=element_text(size=18, color="black"), 
        axis.title=element_text(size=20, color="black", face="bold"), 
        title = element_text(size=20, color="black", face="bold")); pi_plot1
```

Does not look like photosynthesis is being captured/measured. Do not use oxygen data.  

# Fluorescence Summary 

## Check sample size 

Check sample size 
```{r}
df%>%
  mutate(code=as.factor(code))%>%
  group_by(Symbiont, Gradient_Temperature)%>%
  summarise(length(unique(code)))

#n=4 per symbiont per temperature during temperature gradients 

df%>%
  mutate(code=as.factor(code))%>%
  group_by(Symbiont)%>%
  summarise(length(unique(code)))
#n=48 per symbiont during non temperature gradient periods 
```

# Rapid Light Curve equations and parameters 

## Calculate rETR 

First, calculate rETR as QY * PAR. 
```{r}
rlc<-df%>%
  filter(Phase=="Rapid light curve - Temp Gradient")%>%
  mutate(rETR=QY*Light)
```

Plot rETR across PAR with line for each temperature faceted by parent type.    
```{r}
rlc_plot1<-rlc%>%

  ggplot(aes(x=Light, y=rETR, colour=Gradient_Temperature, fill=Gradient_Temperature))+
  facet_grid(~Symbiont, labeller = as_labeller(parent_names))+
  geom_point()+
  geom_smooth(aes(group=Gradient_Temperature), se=FALSE, linewidth=2)+
  xlab("Light (PAR)")+
  ylab("rETR")+
  scale_colour_manual(values=palette, name="Gradient \nTemperature")+
  scale_fill_manual(values=palette, name="Gradient \nTemperature")+
  theme_classic()+
  theme(legend.position="none", 
        text=element_text(size=18, color="black"), 
        axis.title=element_text(size=20, color="black", face="bold"), 
        title = element_text(size=20, color="black", face="bold")); rlc_plot1
```

## Fit nls model 

Fit a model to the data following Platt 1976, Platt 1980 using light dependent model of photosynthesis with photoinhibition because we see the downward trend in rETR at the highest irradiance values.

From this we will extract parameters: 
- alpha (slope under light limitation)
- beta (photoinhibition)
- max rETR (maximal rETR)
- Ik (saturating irradiance)

Reference: https://enveurope.springeropen.com/articles/10.1186/s12302-020-00306-9 
```{r}
library(purrr)
library(minpack.lm)

nest <- nest_legacy
unnest <- unnest_legacy

rlc$group <- paste(rlc$Symbiont, rlc$Gradient_Temperature)

#test starting values
-min(rlc$rETR)
max(rlc$rETR) - min(rlc$rETR)
as.numeric(as.character(rlc$Light))

nls_data <- rlc %>%
  group_by(code) %>%
  nest() %>%
  mutate(model1 = map(data, ~ {
    # Calculate I within the map function for each group
    I <- as.numeric(as.character(.x$Light))
    
    nls_fit <- nlsLM(rETR ~ rETRs * (1 - exp(-((a * I)/rETRs)))*exp(-((b*I)/rETRs))-rETRd,
                     data=., 
                     start=list(rETRs=150, a=1, rETRd=1, b=0.1))
      
    # Return tidy results
    tidy(nls_fit) %>%
      dplyr::select(term, estimate) %>%
      spread(term, estimate)
  })) %>%
  unnest(model1) %>%
  unnest(data) %>%
  group_by(code) %>%
  
  summarise(rETRs=mean(rETRs), a=mean(a), rETRd=mean(rETRd), b=mean(b))%>%
  
  mutate(rETRmax=rETRs*(a/(a+b))*(b/(a+b))^(b/a)-rETRd)%>%
  mutate(Ic = rETRd/a) %>%
  mutate(Ik=(rETRmax/a) * log((a+b)/b))
```

Add in metadata and generate summaries. 

```{r}
results<-nls_data
results$Gradient_Temperature<-rlc$Gradient_Temperature[match(results$code, rlc$code)]
results$Symbiont<-rlc$Symbiont[match(results$code, rlc$code)]

results<-results%>%
  pivot_longer(names_to="Metric", values_to=("Value"), cols=rETRs:Ik)
```

## Plot results 

```{r}
parent_names<-c("C" = "Susceptible (C)", "MIX" = "Resistant (C/D)", "WT" = "Wildtype (C/D)")

rlc_metrics_plot1<-results%>%
  filter(Metric %in% c("a", "b", "Ic", "Ik", "rETRmax", "rETRd"))%>%
  
  group_by(Symbiont, Gradient_Temperature, Metric)%>%
  
  ggplot(aes(x=Gradient_Temperature, y=Value, colour=Symbiont, fill=Symbiont))+
  facet_wrap(Metric ~., scales = "free_y")+
  geom_point(size=2)+
  geom_smooth(aes(group=Symbiont, fill=Symbiont, color=Symbiont), linewidth=2, alpha=0.1)+
  xlab("Temperature")+
  ylab(expression(bold(paste("Value"))))+
  scale_colour_manual(values=c("orange", "brown4", "gray"), name="Parental \nPhenotype", labels=parent_names)+
  scale_fill_manual(values=c("orange", "brown4", "gray"), name="Parental \nPhenotype", labels=parent_names)+
  #ylim(-0.01,0.055)+
  theme_classic()+
  theme(legend.position="right", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold"), 
        title = element_text(size=12, color="black", face="bold")); rlc_metrics_plot1
```

We will use the reliable metrics of alpha and rETRmax for analysis. 

## ANOVA tests and individual plots 

a 
```{r}
a_data<-results%>%
  filter(Metric=="a")

hist(a_data$Value)

model<-results%>%
  filter(Metric=="a")%>%
  
  aov(Value~Gradient_Temperature*Symbiont, data=.)

summary(model)

emm<-emmeans(model, ~Symbiont | Gradient_Temperature)
pairs(emm)
```
Significant temp x symbiont interaction. C is lower than MIX at 20C and higher than mix at 29C (WT also higher than mix at 29°C). C higher than WT at 38°C. 

Plot. 
```{r}
rlc_metrics_plot1<-results%>%
  filter(Metric %in% c("a"))%>%
  
  group_by(Symbiont, Gradient_Temperature, Metric)%>%
  
  ggplot(aes(x=Gradient_Temperature, y=Value, colour=Symbiont))+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(size=2, position=position_dodge(0.5))+
  xlab("Temperature")+
  ylab(expression(bold(paste("Alpha"))))+
  scale_colour_manual(values=c("orange", "brown4", "gray"), name="Parent (Symbiont)", labels=parent_names)+
  geom_text(x=1, y=0.65, label="*", inherit.aes=FALSE, size=8)+
  geom_text(x=6, y=0.88, label="*", inherit.aes=FALSE, size=8)+
  geom_text(x=12, y=0.72, label="*", inherit.aes=FALSE, size=8)+
  theme_classic()+
  ggtitle("D")+
  ylim(0.2,0.91)+
  theme(legend.position="right", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold"), 
        title = element_text(size=12, color="black", face="bold")); rlc_metrics_plot1

ggsave(filename="figures/phenoplate/rlc_alpha.jpeg", rlc_metrics_plot1, width=8, height=6)

blue_red_12 <- c(
  "#08306B", # dark navy
  "#08519C",
  "#2171B5",
  "#4292C6",
  "#6BAED6",
  "#9ECAE1", # mid-light blue
  "#FCAE91", # soft salmon
  "#FB6A4A",
  "#EF3B2C",
  "#CB181D",
  "#A50F15",
  "#67000D"  # dark red
)

rlc_metrics_plot4<-results%>%
  filter(Metric %in% c("a"))%>%
  
  group_by(Gradient_Temperature, Metric)%>%
  
  ggplot(aes(x=Gradient_Temperature, y=Value, colour=Gradient_Temperature))+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(size=2, position=position_dodge(0.5))+
  xlab("Temperature")+
    ggtitle("C")+
  ylab(expression(bold(paste("Alpha"))))+
  scale_color_manual(values = blue_red_12, name="Temperature")+
  ylim(0.2,0.91)+
  theme_classic()+
  theme(legend.position="right", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold"), 
        title = element_text(size=12, color="black", face="bold")); rlc_metrics_plot4

ggsave(filename="figures/phenoplate/rlc_alpha_temp.jpeg", rlc_metrics_plot4, width=8, height=6)
```

Ic shows many negative values, do not analyze. 
```{r}
ic_data<-results%>%
  filter(Metric=="Ic")

hist(ic_data$Value)
```

Ik has many values close to 0, do not analyze. 
```{r}
ik_data<-results%>%
  filter(Metric=="Ik")

hist(ik_data$Value)
```

rETRd and b have many values close to zero, do not analyze. 

rETR Max 
```{r}
etr_data<-results%>%
  filter(Metric=="rETRmax")

hist(etr_data$Value)

model<-etr_data%>%
  filter(Metric=="rETRmax")%>%
  
  aov(Value~Gradient_Temperature*Symbiont, data=.)

summary(model)

emm<-emmeans(model, ~Symbiont)
pairs(emm)

emm<-emmeans(model, ~Gradient_Temperature)
pairs(emm)
```
Significant main effects of symbiont and temperature. C is higher than WT and so is MIX. 

Plot. 
```{r}
rlc_metrics_plot3<-results%>%
  filter(Metric %in% c("rETRmax"))%>%
  
  group_by(Symbiont, Gradient_Temperature, Metric)%>%
  
  ggplot(aes(x=Gradient_Temperature, y=Value, colour=Symbiont))+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(size=2, position=position_dodge(0.5))+
  xlab("Temperature")+
  ylab(expression(bold(paste("rETR max"))))+
  scale_colour_manual(values=c("orange", "brown4", "gray"), name="Parent (Symbiont)", labels=parent_names)+
  #geom_text(x=1, y=0.65, label="*", inherit.aes=FALSE, size=8)+
  #geom_text(x=6, y=0.88, label="*", inherit.aes=FALSE, size=8)+
  #geom_text(x=12, y=0.72, label="*", inherit.aes=FALSE, size=8)+
  theme_classic()+
  ggtitle("B")+
  ylim(100,350)+
  theme(legend.position="right", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold"), 
        title = element_text(size=12, color="black", face="bold")); rlc_metrics_plot3

ggsave(filename="figures/phenoplate/rlc_rETRmax.jpeg", rlc_metrics_plot3, width=8, height=6)

rlc_metrics_plot3<-results%>%
  filter(Metric %in% c("rETRmax"))%>%
  
  group_by(Symbiont, Metric)%>%
  
  ggplot(aes(x=Symbiont, y=Value, colour=Symbiont))+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(size=2, position=position_dodge(0.5))+
  xlab("Temperature")+
  ylab(expression(bold(paste("rETR max"))))+
  scale_colour_manual(values=c("orange", "brown4", "gray"), name="Parent (Symbiont)", labels=parent_names)+
  #geom_text(x=1, y=0.65, label="*", inherit.aes=FALSE, size=8)+
  #geom_text(x=6, y=0.88, label="*", inherit.aes=FALSE, size=8)+
  #geom_text(x=12, y=0.72, label="*", inherit.aes=FALSE, size=8)+
  theme_classic()+
  ylim(100,350)+
  theme(legend.position="right", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold"), 
        title = element_text(size=12, color="black", face="bold")); rlc_metrics_plot3

blue_red_12 <- c(
  "#08306B", # dark navy
  "#08519C",
  "#2171B5",
  "#4292C6",
  "#6BAED6",
  "#9ECAE1", # mid-light blue
  "#FCAE91", # soft salmon
  "#FB6A4A",
  "#EF3B2C",
  "#CB181D",
  "#A50F15",
  "#67000D"  # dark red
)

rlc_metrics_plot4<-results%>%
  filter(Metric %in% c("rETRmax"))%>%
  
  group_by(Gradient_Temperature, Metric)%>%
  
  ggplot(aes(x=Gradient_Temperature, y=Value, colour=Gradient_Temperature))+
  geom_boxplot(position=position_dodge(0.5))+
  geom_point(size=2, position=position_dodge(0.5))+
  xlab("Temperature")+
    ggtitle("A")+
  ylab(expression(bold(paste("rETR max"))))+
  scale_color_manual(values = blue_red_12, name="Temperature")+
  ylim(100, 350)+
  theme_classic()+
  theme(legend.position="right", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold"), 
        title = element_text(size=12, color="black", face="bold")); rlc_metrics_plot4

ggsave(filename="figures/phenoplate/rlc_rETRmax_temp.jpeg", rlc_metrics_plot4, width=8, height=6)
```

# NPQ during RLC 

Normalize NPQ to starting value, view across RLC temperature gradient, and merge into `results` dataframe. 

```{r}
npq<-rlc%>%
  select(Plate, Phase, well, code, Time, Light, Gradient_Temperature,Symbiont, NPQ_norm)%>%
  ungroup()%>%
  filter(Phase == "Rapid light curve - Temp Gradient") %>%
  arrange(Plate, well, code, Time, Light, Gradient_Temperature) %>%
  mutate(
    baseline = dplyr::first(NPQ_norm),           # within each group thanks to .by
    NPQrlc   = NPQ_norm / baseline,
    .by = c(Plate, well, code)
  )%>%
  select(!Phase)%>%
  select(!baseline)%>%
  select(!c(Plate, well, Time))

head(npq)
```

View data. 
```{r}
hist(npq$NPQrlc)

#filter upper outliers 

npq<-npq%>%
  filter(NPQrlc<6)

hist(npq$NPQrlc)
```

View NPQ values across light and temperature for each symbiont. 

```{r}
npq_plot1<-npq%>%
  
  ggplot(aes(x=Light, y=NPQrlc, colour=Symbiont, fill=Symbiont))+
  facet_grid(~Gradient_Temperature)+
  geom_point(size=2, position=position_dodge(0.5), alpha=0.3)+
  geom_smooth(aes(group=Symbiont), se=TRUE)+
  xlab("Light")+
  ylab("Normalized NPQ")+
  scale_colour_manual(values=c("orange", "brown4", "gray"), name="Parent (Symbiont)", labels=parent_names)+
  scale_fill_manual(values=c("orange", "brown4", "gray"), name="Parent (Symbiont)", labels=parent_names)+
  theme_classic()+
  ggtitle("B")+
  theme(legend.position="right", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=12, color="black"), 
        axis.text.x=element_text(angle=45, hjust=1),
        title = element_text(size=12, color="black")); npq_plot1

ggsave(filename="figures/phenoplate/rlc_npq_symbiont.jpeg", npq_plot1, width=14, height=6)

blue_red_12 <- c(
  "#08306B", # dark navy
  "#08519C",
  "#2171B5",
  "#4292C6",
  "#6BAED6",
  "#9ECAE1", # mid-light blue
  "#FCAE91", # soft salmon
  "#FB6A4A",
  "#EF3B2C",
  "#CB181D",
  "#A50F15",
  "#67000D"  # dark red
)

npq_plot2<-npq%>%
  
  ggplot(aes(x=Light, y=NPQrlc, colour=Gradient_Temperature, fill=Gradient_Temperature))+
  facet_grid(~Symbiont, labeller = as_labeller(parent_names))+
  geom_point(size=2, position=position_dodge(0.5), alpha=0.3)+
  geom_smooth(aes(group=Gradient_Temperature), se=TRUE)+
  xlab("Light")+
  ylab("Normalized NPQ")+
  scale_colour_manual(values=blue_red_12)+
  scale_fill_manual(values=blue_red_12)+
  theme_classic()+
  ggtitle("A")+
  theme(legend.position="right", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=12, color="black"), 
        axis.text.x=element_text(angle=45, hjust=1),
        title = element_text(size=12, color="black")); npq_plot2

ggsave(filename="figures/phenoplate/rlc_npq_temperature.jpeg", npq_plot2, width=10, height=5)
```

Analyze NPQ

```{r}
model<-npq%>%
  
  lmer(NPQrlc~Gradient_Temperature*Symbiont*Light + (1|code), data=.)

anova(model)

emm<-emmeans(model, ~Symbiont | Gradient_Temperature * Light)
pairs(emm)

emm<-emmeans(model, ~Symbiont | Gradient_Temperature)
pairs(emm)
```
WT is higher than the other two at 21, 24, 2628, 29, 31, 34, 37. No differences between C and MIX. 
