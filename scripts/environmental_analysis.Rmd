---
title: "Analyzing larval environmental data - Hawaii 2023"
author: "Ariana S Huffmyer"
date: "2023"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

This script reads and plots environmental data from Hobo tidbit loggers and daily measurements.  

# Set Up    

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(purrr)
library(lubridate)
library(ggplot2)
library(seacarb)
library(broom)
library(cowplot)
```

# Daily measurements  

## Read in file  

Read in daily measurements file.  

```{r}
daily<-read_csv("data/environmental/daily_measurements.csv")
daily$date<-as.Date(daily$date, format="%m/%d/%y")
daily$tank<-as.factor(daily$tank)
daily$tris.date<-as.character(daily$tris.date)
```

## Calculate total pH  

Calculate the calibration curve from the Tris calibration and calculate pH on the total scale from pH.mV.   
```{r}
pHcalib<-read_csv("data/environmental/Tris_Calibration.csv")
pHcalib$tris.date<-as.character(pHcalib$tris.date)

pHSlope<-pHcalib %>%
  nest_by(tris.date)%>%
  mutate(fitpH = list(lm(mVTris~Ttris, data = pHcalib))) %>% # linear regression of mV and temp of the tris
  reframe(broom::tidy(fitpH)) %>% # make the output tidy
  select(tris.date, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%# put slope and intercept in their own column
  left_join(daily, ., by="tris.date") %>% # join with the pH sample data
  mutate(mVTris = temp.C*Ttris + `(Intercept)`) %>%# calculate the mV of the tris at temperature in which the pH of the tanks were measured
  mutate(pH.total = pH(Ex=pH.mV, Etris=mVTris, S=sal.psu, T=temp.C)) # calculate pH of the tanks using the pH seacarb function
```

pH is now calculated as Total pH in the "pH" column. Now select the desired columns to analyze further.  
```{r}
daily_calc<-pHSlope%>%
  select(date, time, tank, group, temp.C, pH.total, pH.nbs, sal.psu, flow.mL.5s, par)
```

## Calculate flow  

Calculate flow to total mL per minute rather than 5 sec.  
```{r}
daily_calc<-daily_calc%>%
  mutate(flow.L.min=(flow.mL.5s*12)/1000)%>%
  select(!flow.mL.5s)
```

## Change to long format

Change data format to long format 
```{r}
daily_calc.long <-daily_calc %>% pivot_longer(cols=temp.C:flow.L.min,
  names_to = "metric",
  values_to = "value")
```

## Plot metrics of interest  

Plot by tank colored by symbiont treatment.      
```{r}
daily_tanks<-daily_calc.long %>%
  ggplot(aes(x=date, y=value, colour=group))+
  geom_point(size=2)+
  #geom_vline(xintercept = as.numeric(ymd("2022-10-19")), linetype="dashed", 
                #color = "black", size=0.5)+
  #geom_vline(xintercept = as.numeric(ymd("2022-10-24")), linetype="solid", 
                #color = "black", size=0.5)+
  #scale_colour_manual(values=c("orange", "brown4"))+
  xlab("Date")+
  facet_grid(metric ~ ., scales = "free")+
  theme_bw(); daily_tanks
  
ggsave(filename="figures/environmental/tank_daily_measurements.png", plot=daily_tanks, dpi=300, width=6, height=8, units="in")

```

Plot by treatment summarizing tanks within each group    
```{r}
daily_treatment<-daily_calc.long %>%
  ggplot(aes(x=date, y=value, colour=group, group=interaction(group, date)))+
  geom_point()+
  geom_boxplot()+
  #geom_vline(xintercept = as.numeric(ymd("2022-10-19")), linetype="dashed", 
                #color = "black", size=0.5)+
  #geom_vline(xintercept = as.numeric(ymd("2022-10-24")), linetype="solid", 
                #color = "black", size=0.5)+
  #scale_colour_manual(values=c("orange", "brown4"))+
  xlab("Date")+
  facet_grid(metric ~ ., scales = "free")+
  theme_bw(); daily_treatment

ggsave(filename="figures/environmental/boxplot_daily_measurements.png", plot=daily_treatment, dpi=300, width=6, height=8, units="in")
```

## Test for differences between tanks  

Obtain a short format dataset.  
```{r}
daily_calc.short<-daily_calc.long%>%
  spread(metric, value)
```

Test for differences between tanks. 

```{r}
daily_calc.short%>%
  aov(flow.L.min~tank, data=.)%>%
  summary()
 
daily_calc.short%>%
  aov(par~tank, data=.)%>%
  summary()

daily_calc.short%>%
  aov(pH.total~tank, data=.)%>%
  summary()

daily_calc.short%>%
  aov(pH.nbs~tank, data=.)%>%
  summary()

daily_calc.short%>%
  aov(sal.psu~tank, data=.)%>%
  summary()

daily_calc.short%>%
  aov(temp.C~tank, data=.)%>%
  summary()
```

## Test for differences between treatments  

```{r}
daily_calc.short%>%
  aov(flow.L.min~group, data=.)%>%
  summary()
 
daily_calc.short%>%
  aov(par~group, data=.)%>%
  summary()

daily_calc.short%>%
  aov(pH.total~group, data=.)%>%
  summary()

daily_calc.short%>%
  aov(pH.nbs~group, data=.)%>%
  summary()

daily_calc.short%>%
  aov(sal.psu~group, data=.)%>%
  summary()

daily_calc.short%>%
  aov(temp.C~group, data=.)%>%
  summary()
```

## Summarize daily measurements  

Calculate descriptive statistics   
```{r}
summary<-daily_calc.short%>%
  group_by(group)%>%
  select(!tank)%>%
  select(!date)%>%
  select(!time)%>%
  summarise(across(everything(), list(mean = mean, sd = sd), na.rm = TRUE)); summary

write_csv(summary, "output/environmental/daily_measurements_summary.csv")
```









# Tidbit analysis (NEED TO EDIT WITH TIDBIT FILE STRUCTURE)   

## Read in files  

Read in Hobo Tidbit files  
```{r}
tidbit.files <- list.files(path="data/environmental/tidbit_loggers", pattern="*.csv", full.names=TRUE)

#will need to change to HST time 
tidbits <- setNames(tidbit.files, tidbit.files) %>%
    map_dfr(read_csv, .id = "logger") %>%
    rename(DateTime=`Date-Time (PDT)`, temp.C=`Ch: 1 - Temperature   (°C)`)%>%
    select(!`#`)%>%
    select(logger, DateTime, temp.C)%>%
    mutate(logger=sub(".*/", "", logger))%>% #remove the path name
    mutate(logger=sub("_.*", "", logger))%>% #keep only the serial number 
    filter(!temp.C=="NA")

tidbits$DateTime<-as.POSIXct(tidbits$DateTime, format="%m/%d/%Y %H:%M:%S", tz="Pacific/Honolulu")
```

Remove time periods during logger read out.   
```{r}
#tidbits<-tidbits%>%filter(DateTime<as.POSIXct('2022-10-28 16:30:00', tz="Pacific/Honolulu"))
```

List the logger serial numbers in this dataframe.  
```{r}
levels(as.factor(tidbits$logger))
```

There are 6 loggers as expected.  

## Read in treatment information  

Read in metadata that assigns a pendant serial number to a tank number and/or treatment.  
```{r}
metadata<-read_csv("data/environmental/logger_metadata.csv")
metadata$logger<-as.character(metadata$logger)
```

Assign treatment information to logger data.  
```{r}
tidbits<-left_join(tidbits, metadata, by="logger")
tidbits$tank<-as.factor(tidbits$tank)
tidbits$symbiont<-as.factor(tidbits$symbiont)
```

## Plot temperature    

Plot raw data over time by tank colored by symbiont type.    
```{r}
temp_plot<-tidbits%>%
  
  ggplot(aes(x=DateTime, y=temp.C, colour=symbiont))+
  geom_point()+
  #ylim(26, 30)+
  scale_colour_manual(values=c("orange", "brown4"), name="Symbiont")+
  ylab("Temperature (°C)")+
  xlab("Date Time")+
  theme_classic(); temp_plot

ggsave("figures/environmental/tidbit_temp.png", temp_plot, width=8, height=6)
```

Summarize by treatment with error shading for standard error.  
```{r}
temp_plot_treatment<-tidbits%>%
  group_by(symbiont, DateTime)%>%
  summarise(mean=mean(temp.C, na.rm=TRUE), sd=sd(temp.C, na.rm=TRUE), sem=sd/sqrt(6), upper=mean+sd, lower=mean-sd)%>%
  
  ggplot(aes(x=DateTime, y=mean, colour=symbiont, fill=symbiont))+
  #geom_line()+
  geom_ribbon(aes(ymin = lower, ymax = upper, colour=symbiont), alpha = 0.4, colour = NA, show.legend=FALSE) +
  geom_smooth(method="glm", span=0.1, se=FALSE, aes(colour=symbiont), alpha=1, show.legend=TRUE) +
  #ylim(26, 30)+
  ylab("Temperature (°C)")+
  xlab("Date Time")+
  scale_colour_manual(values=c("orange", "brown4"), name="Symbiont")+
  scale_fill_manual(values=c("orange", "brown4"), name="Symbiont")+
  theme_classic(); temp_plot_treatment

ggsave("figures/environmental/tidbit_temperature_smooth.png", temp_plot_treatment, width=8, height=6)
```

Calculate the mean difference in temperature treatments between symbiont types.  
```{r}
tidbits%>%
  group_by(symbiont, DateTime)%>%
  summarise(mean=mean(temp.C, na.rm=TRUE))%>%
  spread(key=symbiont, value=mean)%>%
  reframe(difference=Cladocopium-Durusdinium)%>%
  reframe(mean=mean(difference))
```

Calculate mean daily maximum temperature for each symbiont type.     
```{r}
tidbits %>%
  mutate(day = floor_date(DateTime, "day")) %>%
           group_by(day, tank, symbiont) %>%
           summarise(max = max(temp.C))%>%
          group_by(symbiont) %>%
           summarise(mean_daily_max=mean(max))
```

Calculate mean daily minimum temperature for each symbiont type.     
```{r}
tidbits %>%
  mutate(day = floor_date(DateTime, "day")) %>%
           group_by(day, tank, symbiont) %>%
           summarise(min = min(temp.C))%>%
          group_by(symbiont) %>%
           summarise(mean_daily_max=mean(min))
```

Calculate mean daily fluctuation in temperature for each symbiont type.     
```{r}
tidbits %>%
  mutate(day = floor_date(DateTime, "day")) %>%
           group_by(day, tank, symbiont) %>%
           summarise(max=max(temp.C), min = min(temp.C), change=max-min)%>%
            group_by(symbiont) %>%
           summarise(mean_cycle=mean(change))
```

# Black logger analysis (NEED TO ADD)

Add spots for black loggers for metadata for each tank and treatment 
Can do after Hawaii, just look over treatment information and do frequent measurements in the day of 
