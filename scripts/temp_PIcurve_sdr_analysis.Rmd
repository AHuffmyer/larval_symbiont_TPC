---
title: "Larval PI Curve Plotting and Analysis - Hawaii 2023 - Temp x Light curve analysis" 
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

# Setup  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("scales" %in% rownames(installed.packages()) == 'FALSE') install.packages('scales') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("effects" %in% rownames(installed.packages()) == 'FALSE') install.packages('effects') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 
if ("rTPC" %in% rownames(installed.packages()) == 'FALSE') remotes::install_github("padpadpadpad/rTPC")
if ("ggstatsplot" %in% rownames(installed.packages()) == 'FALSE') remotes::install_github("IndrajeetPatil/ggstatsplot")
if ("nls.multstart" %in% rownames(installed.packages()) == 'FALSE') install.packages('nls.multstart')
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom')

#load packages
library("ggplot2")
library("tidyverse")
library('car')
library('lme4')
library('lmerTest')
library('scales')
library('cowplot')
library('rTPC')
library('ggstatsplot')
library('nls.multstart')
library('broom')
library('emmeans')
```


# Data visualization and manipulation  

Load data from LoLinR.    
```{r, warning=FALSE, message=FALSE}
pi_temp_data<-read.csv("output/temp_pi_curves/temp_PIcurves_calculated_normalized_photo_rates.csv") #load data
```

Format data. 
```{r, warning=FALSE, message=FALSE}
#remove all rows of wells that did not have samples or blanks
pi_temp_data<-pi_temp_data[!is.na(pi_temp_data$Type),]

#format columns
pi_temp_data$Symbiont<-as.factor(pi_temp_data$Symbiont)
pi_temp_data$SDR<-as.factor(pi_temp_data$SDR)
pi_temp_data$Plate<-as.factor(pi_temp_data$Plate)
pi_temp_data$Temperature<-as.factor(pi_temp_data$Temperature)
```

Look for outliers in the data.  

```{r}
boxplot(pi_temp_data$nmol.org.min)
#pi_temp_data<-pi_temp_data%>%filter(P.nmol.org.min < 0.10)
#boxplot(pi_temp_data$P.nmol.org.min)

boxplot(pi_temp_data$nmol.org.min~pi_temp_data$Light_Value)
```

Set values at 0 for light runs if <0 indicating no photosynthesis occurred. Set values at 0 for dark runs if >0 indicating no respiration occurred. 
```{r}
pi_temp_data<-pi_temp_data%>%
  mutate(nmol.org.min=if_else(nmol.org.min<0 & Light_Value==50, 0, 
                      if_else(nmol.org.min<0 & Light_Value==100, 0, 
                              if_else(nmol.org.min<0 & Light_Value==500, 0, 
                                      if_else(nmol.org.min>0 & Light_Value==0.1, 0, 
                                              if_else(nmol.org.min>0 & Light_Value==0.2, 0, nmol.org.min))))))

boxplot(pi_temp_data$nmol.org.min~pi_temp_data$Light_Value)
```

Calculate mean temperature values for each run.    

```{r}
pr.temps<-read.csv("output/temp_pi_curves/mean_temperature_by_plate_and_light_interval.csv")

pr.temps$Plate <- as.integer(sub("(?i)^plate", "", pr.temps$Plate, perl = TRUE))  # removes leading "Plate"

pr.temps<-pr.temps%>%
  mutate(Plate=as.factor(Plate))
```

Add temperature data to master data frame.  
```{r}
str(pi_temp_data)
str(pr.temps)

pi_temp_data$mean_temp<-pr.temps$Mean_T_internal_C[match(pi_temp_data$Plate, pr.temps$Plate)]

#round to 0.1°C 
pi_temp_data<-pi_temp_data%>%
  mutate(mean_temp=round(mean_temp,1))
```

Reorder factor. 
```{r}
pi_temp_data$PAR<-factor(pi_temp_data$Light_Value, levels=c("0.1", "50", "100", "500", "0.2"))
```

# Plot and analyze 

Plot data with means   
```{r}
pi_temp_plot1<-pi_temp_data %>%
    group_by(PAR, Symbiont, Temperature)%>%
    dplyr::summarise(mean=mean(nmol.org.min, na.rm=TRUE), sd=sd(nmol.org.min, na.rm=TRUE), N=length(nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = as.factor(PAR), y = mean, group=interaction(PAR, Symbiont))) +
    facet_wrap(~Temperature)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(PAR, Symbiont), colour=Symbiont), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(PAR, Symbiont)), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Light (PAR)") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_temp_plot1

ggsave("figures/temp_pi_curves/pi_means.png", pi_temp_plot1, dpi=300, w=7, h=5, units="in")
```

Display with plate. 
```{r}
pi_temp_plot1a<-pi_temp_data %>%
    group_by(PAR, Symbiont, Plate)%>%
    dplyr::summarise(mean=mean(nmol.org.min, na.rm=TRUE), sd=sd(nmol.org.min, na.rm=TRUE), N=length(nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = as.factor(PAR), y = mean, group=interaction(PAR, Symbiont))) +
    facet_wrap(~Plate)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(PAR, Symbiont), colour=Symbiont), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(PAR, Symbiont)), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Light (PAR)") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_temp_plot1a
```

View by plate. 
```{r}
pi_temp_plot2b<-pi_temp_data %>%
    ggplot(., aes(x = as.factor(PAR), y = nmol.org.min, group=Symbiont)) +
    facet_wrap(~Plate)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_smooth(aes(color=Symbiont, group=Symbiont), method="loess", alpha=0.4, se=FALSE)+
    xlab("Light (PAR)") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_temp_plot2b
```

Plot data with dots   
```{r}
pi_temp_plot3<-pi_temp_data %>%
  
    ggplot(., aes(x = as.factor(PAR), y = nmol.org.min, group=interaction(PAR, Symbiont))) +
    facet_wrap(~Temperature)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(PAR, Symbiont), color=Symbiont), size=3, fill="white", position = position_jitterdodge(0.4), shape=21) + 
    geom_smooth(aes(color=Symbiont, group=Symbiont), method="loess", size=2, alpha=0.4, se=FALSE)+
    xlab("Light (PAR)") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_temp_plot3

ggsave("figures/temp_pi_curves/pi_temp_dots.png", pi_temp_plot3, dpi=300, w=7, h=5, units="in")
```

## Conduct anova 

Run anova on values at each temperature
```{r}
model<-pi_temp_data%>%
  aov(nmol.org.min~PAR*Symbiont*Temperature, data=.)

summary(model)
```
There is an effect of temperature x light. 

Run model for 27 
```{r}
model<-pi_temp_data%>%
  filter(Temperature==27)%>%
  aov(nmol.org.min~PAR*Symbiont, data=.)

summary(model)
```
There is an effect of light at 27C. 

Run model for 30
```{r}
model<-pi_temp_data%>%
  filter(Temperature==30)%>%
  aov(nmol.org.min~PAR*Symbiont, data=.)

summary(model)
```
There is an effect of light at 30C. 

Run model for 33
```{r}
model<-pi_temp_data%>%
  filter(Temperature==33)%>%
  aov(nmol.org.min~PAR*Symbiont, data=.)

summary(model)
```
There is an effect of light at 33C. 

Run model for 36
```{r}
model<-pi_temp_data%>%
  filter(Temperature==36)%>%
  aov(nmol.org.min~PAR*Symbiont, data=.)

summary(model)
```
There is an effect of light at 36C. 

# Calculate R, P, and P:R 

Calculate gross photosynthesis and P:R ratio. 
```{r}
pi_temp_data_calc<-pi_temp_data%>%
  select(Date, Well, Plate, Run, Temperature, Symbiont, PAR, nmol.org.min)%>%
  pivot_wider(names_from=PAR, values_from=nmol.org.min)%>%
  mutate(ler=`0.2`)%>%
  mutate(rd=`0.1`)%>%
  mutate(ler_inverse=ler*-1)%>%
  mutate(rd_inverse=rd*-1)%>%
  mutate(p_net_low=`50`)%>%
  mutate(p_net_medium=`100`)%>%
  mutate(p_net_high=`500`)%>%
  mutate(p_gross_low=p_net_low-ler)%>%
  mutate(p_gross_medium=p_net_medium-ler)%>%
  mutate(p_gross_high=p_net_high-ler)%>%
  mutate(ratio_low=p_gross_low/ler_inverse)%>%
  mutate(ratio_medium=p_gross_medium/ler_inverse)%>%
  mutate(ratio_high=p_gross_high/ler_inverse)%>%
  pivot_longer(names_to="Metric", values_to="Value", cols=c(ler:ratio_high))%>%
  select(!c(`0.1`, `50`, `100`, `500`, `0.2`))

boxplot(pi_temp_data_calc$Value)

pi_temp_data_calc<-pi_temp_data_calc%>%
 filter(Value<15)

boxplot(pi_temp_data_calc$Value)
```

Set level of factors. 
```{r}
levels(as.factor(pi_temp_data_calc$Metric))

pi_temp_data_calc$Metric<-factor(pi_temp_data_calc$Metric, levels=c("p_gross_low", "p_gross_medium", "p_gross_high", "p_net_low", "p_net_medium", "p_net_high", "ratio_low", "ratio_medium", "ratio_high", "rd", "rd_inverse", "ler", "ler_inverse"))
```

View P metrics by dots. 
```{r}
metric_plot1<-pi_temp_data_calc%>%
    filter(!Metric=="ratio_high")%>%
    filter(!Metric=="ratio_medium")%>%
    filter(!Metric=="ratio_low")%>%
    filter(!Metric=="ler")%>%
    filter(!Metric=="rd")%>%
    filter(!Metric=="ler_inverse")%>%
    filter(!Metric=="rd_inverse")%>%
  
    ggplot(., aes(x = Temperature, y = Value)) +
    facet_wrap(~Metric)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(Temperature, Symbiont), color=Symbiont), size=3, fill="white", position = position_jitterdodge(0.4), shape=21) + 
    geom_smooth(aes(color=Symbiont, group=Symbiont), method="loess", size=2, alpha=0.4, se=FALSE)+
    xlab("Temperature") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("Value")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); metric_plot1

ggsave("figures/temp_pi_curves/pi_metrics.png", metric_plot1, dpi=300, w=7, h=5, units="in")
```

View P metrics by means. 
```{r}
metric_plot1_means<-pi_temp_data_calc%>%
    filter(!Metric=="ratio_high")%>%
    filter(!Metric=="ratio_medium")%>%
    filter(!Metric=="ratio_low")%>%
    filter(!Metric=="ler")%>%
    filter(!Metric=="rd")%>%
    filter(!Metric=="ler_inverse")%>%
    filter(!Metric=="rd_inverse")%>%

    group_by(Metric, Symbiont, Temperature)%>%
    dplyr::summarise(mean=mean(Value, na.rm=TRUE), sd=sd(Value, na.rm=TRUE), N=length(Value), se=sd/sqrt(N))%>%
  
  
    ggplot(., aes(x = Temperature, y = mean)) +
    facet_wrap(~Metric)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(Temperature, Symbiont), color=Symbiont), size=4, fill="white", position = position_dodge(0.4), shape=19) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(Metric, Symbiont)), width=0, linetype="solid", position=position_dodge(0.4), size=0.6, color="black")+
    xlab("Temperature") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("Value")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); metric_plot1_means

ggsave("figures/temp_pi_curves/pi_metrics_mean.png", metric_plot1_means, dpi=300, w=7, h=5, units="in")
```

View P metrics by light and temp.  
```{r}
# 1) compute mean ± SE for each Symbiont × Metric × Temperature
sum_df <- pi_temp_data_calc %>%
  filter(Metric %in% c("p_gross_low", "p_gross_medium", "p_gross_high")) %>%
  group_by(Symbiont, Metric, Temperature) %>%
  summarise(
    n    = n(),
    mean = mean(Value, na.rm = TRUE),
    se   = sd(Value, na.rm = TRUE) / sqrt(length(Value))
  ) %>%
  ungroup()

# 2) plot: raw points (optional), then mean lines, mean points, and SE error bars
metric_plot3 <- ggplot() +
  facet_wrap(~ Symbiont) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.75) +

  # raw points (optional, lightly jittered)
  geom_point(
    data = pi_temp_data_calc %>% 
      filter(Metric %in% c("p_gross_low", "p_gross_medium", "p_gross_high")),
    aes(x = Temperature, y = Value, fill = Metric),
    shape = 21, size = 2.5, alpha = 0.1,
    position = position_jitter(width = 0.2, height = 0)  # no dodging, just jitter
  ) +

  # connecting lines of group means, colored by light level (Metric)
  geom_line(
    data = sum_df,
    aes(x = Temperature, y = mean, color = Metric, group = Metric),
    linewidth = 1.2
  ) +
  # mean points
  geom_point(
    data = sum_df,
    aes(x = Temperature, y = mean, color = Metric),
    size = 3
  ) +
  # error bars: mean ± SE
  geom_errorbar(
    data = sum_df,
    aes(x = Temperature, ymin = mean - se, ymax = mean + se, color = Metric),
    width = 0.12
  ) +

  xlab("Temperature") +
  scale_color_manual(
    name = "PAR",
    values = c("#253494", "#41B6C4", "#A1D99B"),
    labels = c("50", "100", "500")
  ) +
  scale_fill_manual(  # keep raw points in the same palette as lines
    name = "PAR",
    values = c("#253494", "#41B6C4", "#A1D99B"),
    labels = c("50", "100", "500")
  ) +
  ylab(expression(bold(paste(P[Gross]," (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(
    legend.position = "right",
    axis.title = element_text(face = "bold", size = 16),
    axis.text = element_text(size = 12, color = "black"),
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 12)
  );metric_plot3

ggsave("figures/temp_pi_curves/gross_photosynthesis_light_temp.png", metric_plot3, dpi=300, w=9, h=6, units="in")
```

View P metrics by light and temp.  
```{r}
parent_names<-c("C" = "Susceptible (C)", "MIX" = "Resistant (C/D)", "WT" = "Wildtype (C/D)")
  
# 1) compute mean ± SE for each Symbiont × Metric × Temperature
sum_df <- pi_temp_data_calc %>%
  filter(Metric %in% c("p_gross_low", "p_gross_medium", "p_gross_high")) %>%
  group_by(Symbiont, Metric, Temperature) %>%
  dplyr::summarise(
    n    = n(),
    mean = mean(Value, na.rm = TRUE),
    se   = sd(Value, na.rm = TRUE) / sqrt(length(Value))
  ) %>%
  ungroup()

new_labels<-c("p_gross_low"="Low Light (50)","p_gross_medium"="Mod. Light (100)", "p_gross_high"="High Light (500)")

# 2) plot: raw points (optional), then mean lines, mean points, and SE error bars
metric_plot3 <- ggplot() +
  facet_wrap(~ Metric, labeller = labeller(Metric = new_labels)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.75) +

  # raw points (optional, lightly jittered)
  geom_point(
    data = pi_temp_data_calc %>% 
      filter(Metric %in% c("p_gross_low", "p_gross_medium", "p_gross_high")),
    aes(x = Temperature, y = Value, fill = Symbiont),
    shape = 21, size = 2.5, alpha = 0.1,
    position = position_jitter(width = 0.2, height = 0)  # no dodging, just jitter
  ) +

  # connecting lines of group means, colored by light level (Metric)
  geom_line(
    data = sum_df,
    aes(x = Temperature, y = mean, color = Symbiont, group = Symbiont),
    linewidth = 1.2
  ) +
  # mean points
  geom_point(
    data = sum_df,
    aes(x = Temperature, y = mean, color = Symbiont),
    size = 3
  ) +
  # error bars: mean ± SE
  geom_errorbar(
    data = sum_df,
    aes(x = Temperature, ymin = mean - se, ymax = mean + se, color = Symbiont),
    width = 0.12
  ) +

  xlab("Temperature") +
  scale_color_manual(
    name = "Parent",
    values = c("orange", "darkred", "darkgray"), 
    labels = parent_names
  ) +
  scale_fill_manual(  # keep raw points in the same palette as lines
    name = "Parent",
    values = c("orange", "darkred", "darkgray"), 
    labels = parent_names
  ) +
  ylab(expression(bold(paste(P[Gross]," (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(
    legend.position = "right",
    axis.title = element_text(face = "bold", size = 16),
    axis.text = element_text(size = 12, color = "black"),
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 12)
  );metric_plot3

ggsave("figures/temp_pi_curves/gross_photosynthesis_symbiont_temp.png", metric_plot3, dpi=300, w=9, h=6, units="in")
```

View Rd and LER metrics. 
```{r}
metric_plot1a<-pi_temp_data_calc%>%
    filter(Metric %in% c("ler_inverse", "rd_inverse"))%>%
  
    ggplot(., aes(x = Temperature, y = Value)) +
    facet_wrap(~Metric)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(Temperature, Symbiont), color=Symbiont), size=3, fill="white", position = position_jitterdodge(0.4), shape=21) + 
    geom_smooth(aes(color=Symbiont, group=Symbiont), method="loess", size=2, alpha=0.4, se=FALSE)+
    xlab("Temperature") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("Value")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); metric_plot1a

ggsave("figures/temp_pi_curves/pi_rd_ler.png", metric_plot1a, dpi=300, w=7, h=5, units="in")
```

LER is higher than Rd because photosynthesis stimulates respiration in the host.  

View Rd and LER metrics by means. 
```{r}
metric_plot1a_means<-pi_temp_data_calc%>%
    filter(Metric %in% c("ler_inverse", "rd_inverse"))%>%
  
    group_by(Metric, Symbiont, Temperature)%>%
    dplyr::summarise(mean=mean(Value, na.rm=TRUE), sd=sd(Value, na.rm=TRUE), N=length(Value), se=sd/sqrt(N))%>%
  
    ggplot(., aes(x = Temperature, y = mean)) +
    facet_wrap(~Metric)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(Temperature, Symbiont), color=Symbiont), size=3, fill="white", position = position_dodge(0.4), shape=19) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(Metric, Symbiont)), width=0, linetype="solid", position=position_dodge(0.4), size=0.6, color="black")+
    xlab("Temperature") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("Value")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); metric_plot1a_means

ggsave("figures/temp_pi_curves/pi_rd_ler_means.png", metric_plot1a_means, dpi=300, w=7, h=5, units="in")
```

View R metrics by light and temp  
```{r}
# Compute mean ± SE per Symbiont × Metric × Temperature
sum_df5 <- pi_temp_data_calc %>%
  filter(Metric %in% c("ler_inverse", "rd_inverse")) %>%
  group_by(Symbiont, Metric, Temperature) %>%
  summarise(
    n    = n(),
    mean = mean(Value, na.rm = TRUE),
    se   = sd(Value, na.rm = TRUE) / sqrt(n),
    .groups = "drop"
  )



metric_plot5 <- ggplot() +
  facet_wrap(~ Symbiont) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.75) +

  # Raw points (optional), lightly jittered
  geom_point(
    data = pi_temp_data_calc %>% filter(Metric %in% c("ler_inverse", "rd_inverse")),
    aes(x = Temperature, y = Value, fill = Metric),
    shape = 21, size = 2.5, alpha = 0.1,
    position = position_jitter(width = 0.2, height = 0)
  ) +

  # Lines connecting group means across Temperature, colored by Metric
  geom_line(
    data = sum_df5,
    aes(x = Temperature, y = mean, color = Metric, group = Metric),
    linewidth = 1.2
  ) +
  # Mean points
  geom_point(
    data = sum_df5,
    aes(x = Temperature, y = mean, color = Metric),
    size = 3
  ) +
  # Error bars: mean ± SE
  geom_errorbar(
    data = sum_df5,
    aes(x = Temperature, ymin = mean - se, ymax = mean + se, color = Metric),
    width = 0.12
  ) +

  xlab("Temperature") +
  ylab(expression(bold(paste("Respiration")))) +
  theme_classic() +
  theme(
    legend.position = "right",
    axis.title = element_text(face = "bold", size = 16),
    axis.text = element_text(size = 12, color = "black"),
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 12)
  ) +

  # Lock mapping: rd_inverse = "Dark Respiration" (black),
  # ler_inverse = "Light Enhanced Respiration" (darkgray)
  scale_color_manual(
    name   = "PAR",
    breaks = c("rd_inverse", "ler_inverse"),
    values = c("rd_inverse" = "black", "ler_inverse" = "darkgray"),
    labels = c("Dark Respiration", "Light Enhanced \nRespiration")
  ) +
  scale_fill_manual(
    name   = "PAR",
    breaks = c("rd_inverse", "ler_inverse"),
    values = c("rd_inverse" = "black", "ler_inverse" = "darkgray"),
    labels = c("Dark Respiration", "Light Enhanced \nRespiration")
  );metric_plot5

ggsave("figures/temp_pi_curves/resp_light_temp.png", metric_plot5, dpi=300, w=9, h=6, units="in")
```

View R metrics by symbiont and temp  
```{r}
# Compute mean ± SE per Symbiont × Metric × Temperature
sum_df5 <- pi_temp_data_calc %>%
  filter(Metric %in% c("ler_inverse", "rd_inverse")) %>%
  group_by(Symbiont, Metric, Temperature) %>%
  dplyr::summarise(
    n    = n(),
    mean = mean(Value, na.rm = TRUE),
    se   = sd(Value, na.rm = TRUE) / sqrt(n),
    .groups = "drop"
  )

new_labels<-c("ler_inverse"="LEDR","rd_inverse"="R")

metric_plot5 <- ggplot() +
  facet_wrap(~ Metric, labeller = labeller(Metric = new_labels)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.75) +

  # Raw points (optional), lightly jittered
  geom_point(
    data = pi_temp_data_calc %>% filter(Metric %in% c("ler_inverse", "rd_inverse")),
    aes(x = Temperature, y = Value, fill = Symbiont),
    shape = 21, size = 2.5, alpha = 0.1,
    position = position_jitter(width = 0.2, height = 0)
  ) +

  # Lines connecting group means across Temperature, colored by Metric
  geom_line(
    data = sum_df5,
    aes(x = Temperature, y = mean, color = Symbiont, group = Symbiont),
    linewidth = 1.2
  ) +
  # Mean points
  geom_point(
    data = sum_df5,
    aes(x = Temperature, y = mean, color = Symbiont),
    size = 3
  ) +
  # Error bars: mean ± SE
  geom_errorbar(
    data = sum_df5,
    aes(x = Temperature, ymin = mean - se, ymax = mean + se, color = Symbiont),
    width = 0.12
  ) +

  xlab("Temperature") +
  ylab(expression(bold(paste("Respiration (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
  theme_classic() +
  theme(
    legend.position = "right",
    axis.title = element_text(face = "bold", size = 16),
    axis.text = element_text(size = 12, color = "black"),
    legend.title = element_text(face = "bold", size = 14),
    legend.text = element_text(size = 12)
  ) +

  # Lock mapping: rd_inverse = "Dark Respiration" (black),
  # ler_inverse = "Light Enhanced Respiration" (darkgray)
  scale_color_manual(
    name   = "Parent",
    values = c("orange", "darkred", "darkgray"), 
    labels= parent_names
  ) +
  scale_fill_manual(
    name   = "Parent",
    values = c("orange", "darkred", "darkgray"), 
    labels= parent_names
  );metric_plot5

ggsave("figures/temp_pi_curves/resp_symbiont_temp.png", metric_plot5, dpi=300, w=7, h=6, units="in")
```

View P:R metrics. 
```{r}
metric_plot2<-pi_temp_data_calc%>%
    filter(Metric %in% c("ratio_high", "ratio_medium", "ratio_low"))%>%
    filter(Value>0)%>%
  
    ggplot(., aes(x = Temperature, y = Value)) +
    facet_wrap(~Metric)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(Temperature, Symbiont), color=Symbiont), size=3, fill="white", position = position_jitterdodge(0.4), shape=21) + 
    geom_smooth(aes(color=Symbiont, group=Symbiont), method="loess", size=2, alpha=0.4, se=FALSE)+
    xlab("Temperature") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("Value")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); metric_plot2

ggsave("figures/temp_pi_curves/pi_ratio.png", metric_plot2, dpi=300, w=7, h=5, units="in")
```

View P:R ratios by means. 
```{r}
metric_plot2_means<-pi_temp_data_calc%>%
    filter(Metric %in% c("ratio_high", "ratio_medium", "ratio_low"))%>%
    filter(Value>0)%>%
  
    group_by(Metric, Symbiont, Temperature)%>%
    dplyr::summarise(mean=mean(Value, na.rm=TRUE), sd=sd(Value, na.rm=TRUE), N=length(Value), se=sd/sqrt(N))%>%

    ggplot(., aes(x = Temperature, y = mean)) +
    facet_wrap(~Metric)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(Temperature, Symbiont), color=Symbiont), size=3, fill="white", position = position_dodge(0.4), shape=19) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(Metric, Symbiont)), width=0, linetype="solid", position=position_dodge(0.4), size=0.6, color="black")+
    xlab("Temperature") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("Value")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); metric_plot2_means

ggsave("figures/temp_pi_curves/pi_ratio_means.png", metric_plot2_means, dpi=300, w=7, h=5, units="in")
```

View P:R metrics by light and temp only. 
```{r}
# 1) Summarize PR ratio by Symbiont × Metric × Temperature
sum_df6 <- pi_temp_data_calc %>%
  filter(Metric %in% c("ratio_low", "ratio_medium", "ratio_high")) %>%
  filter(!is.infinite(Value)) %>%
  filter(Value<10)%>%
  group_by(Symbiont, Metric, Temperature) %>%
  summarise(
    n    = n(),
    mean = mean(Value, na.rm = TRUE),
    se   = sd(Value, na.rm = TRUE) / sqrt(n),
    .groups = "drop"
  )

# (Optional) enforce Temperature order if needed
# lvl <- c("18","22","26","30")  # example
# sum_df6 <- sum_df6 %>% mutate(Temperature = factor(Temperature, levels = lvl))
# pi_temp_data_calc <- pi_temp_data_calc %>%
#   mutate(Temperature = factor(Temperature, levels = lvl))

metric_plot6 <- ggplot() +
  facet_wrap(~ Symbiont) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.75) +

  # raw points (optional), lightly jittered
  geom_point(
    data = pi_temp_data_calc %>%
      filter(Value<10)%>%
      filter(Metric %in% c("ratio_low", "ratio_medium", "ratio_high"),
             !is.infinite(Value)),
    aes(x = Temperature, y = Value, fill = Metric),
    shape = 21, size = 2.5, alpha = 0.1,
    position = position_jitter(width = 0.2, height = 0)
  ) +

  # lines connecting group means across Temperature, colored by light (Metric)
  geom_line(
    data = sum_df6,
    aes(x = Temperature, y = mean, color = Metric, group = Metric),
    linewidth = 1.2
  ) +
  # mean points
  geom_point(
    data = sum_df6,
    aes(x = Temperature, y = mean, color = Metric),
    size = 3
  ) +
  # error bars: mean ± SE
  geom_errorbar(
    data = sum_df6,
    aes(x = Temperature, ymin = pmax(0, mean - se), ymax = mean + se, color = Metric),
    width = 0.12
  ) +

  xlab("Temperature") +
  ylab(expression(bold(paste("P : R")))) +
  #ylim(0, 8) +
  theme_classic() +
  theme(
    legend.position = "right",
    axis.title = element_text(face = "bold", size = 16),
    axis.text  = element_text(size = 12, color = "black"),
    legend.title = element_text(face = "bold", size = 14),
    legend.text  = element_text(size = 12)
  ) +
  # lock label mapping to your "low/medium/high" lights
  scale_color_manual(
    name   = "PAR",
    breaks = c("ratio_low", "ratio_medium", "ratio_high"),
    values = c("#253494", "#41B6C4", "#A1D99B"),
    labels = c("50", "100", "500")
  ) +
  scale_fill_manual(
    name   = "PAR",
    breaks = c("ratio_low", "ratio_medium", "ratio_high"),
    values = c("#253494", "#41B6C4", "#A1D99B"),
    labels = c("50", "100", "500")
  );metric_plot6

ggsave("figures/temp_pi_curves/PRratio_light_temp.png", metric_plot6, dpi=300, w=9, h=6, units="in")
```

View P:R metrics by symbiont and temp only. 
```{r}
# 1) Summarize PR ratio by Symbiont × Metric × Temperature
sum_df6 <- pi_temp_data_calc %>%
  filter(Metric %in% c("ratio_low", "ratio_medium", "ratio_high")) %>%
  filter(!is.infinite(Value)) %>%
  filter(Value<10)%>%
  group_by(Symbiont, Metric, Temperature) %>%
  dplyr::summarise(
    n    = n(),
    mean = mean(Value, na.rm = TRUE),
    se   = sd(Value, na.rm = TRUE) / sqrt(n),
    .groups = "drop"
  )

new_labels<-c("ratio_low"="Low Light (50)","ratio_medium"="Mod. Light (100)", "ratio_high"="High Light (500)")

metric_plot6 <- ggplot() +
  facet_wrap(~ Metric, labeller = labeller(Metric = new_labels)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.75) +

  # raw points (optional), lightly jittered
  geom_point(
    data = pi_temp_data_calc %>%
      filter(Value<10)%>%
      filter(Metric %in% c("ratio_low", "ratio_medium", "ratio_high"),
             !is.infinite(Value)),
    aes(x = Temperature, y = Value, fill = Symbiont),
    shape = 21, size = 2.5, alpha = 0.1,
    position = position_jitter(width = 0.2, height = 0)
  ) +

  # lines connecting group means across Temperature, colored by light (Metric)
  geom_line(
    data = sum_df6,
    aes(x = Temperature, y = mean, color = Symbiont, group = Symbiont),
    linewidth = 1.2
  ) +
  # mean points
  geom_point(
    data = sum_df6,
    aes(x = Temperature, y = mean, color = Symbiont),
    size = 3
  ) +
  # error bars: mean ± SE
  geom_errorbar(
    data = sum_df6,
    aes(x = Temperature, ymin = pmax(0, mean - se), ymax = mean + se, color = Symbiont),
    width = 0.12
  ) +

  xlab("Temperature") +
  ylab(expression(bold(paste("P : R")))) +
  #ylim(0, 8) +
  theme_classic() +
  theme(
    legend.position = "right",
    axis.title = element_text(face = "bold", size = 16),
    axis.text  = element_text(size = 12, color = "black"),
    legend.title = element_text(face = "bold", size = 14),
    legend.text  = element_text(size = 12)
  ) +
  # lock label mapping to your "low/medium/high" lights
  scale_color_manual(
    name   = "Parent",
    values = c("orange", "darkred", "darkgrey"), 
    labels = parent_names
  ) +
  scale_fill_manual(
    name   = "Parent",
    values = c("orange", "darkred", "darkgrey"), 
    labels = parent_names
  );metric_plot6

ggsave("figures/temp_pi_curves/PRratio_symbiont_temp.png", metric_plot6, dpi=300, w=9, h=6, units="in")
```

# Run anova tests

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="ratio_high")%>%
  filter(Value>0)%>%
  filter(Value<10)%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="ratio_medium")%>%
  filter(Value<10)%>% 
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="ratio_low")%>%
  filter(Value<10)%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

emm<-emmeans(model, ~Symbiont|Temperature)
pairs(emm)
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="ler_inverse")%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
TukeyHSD(model, c("Symbiont"))

emm<-emmeans(model, ~ Temperature)
pairs(emm)

emm<-emmeans(model, ~ Symbiont)
pairs(emm)
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="rd_inverse")%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Symbiont"))
TukeyHSD(model, c("Temperature"))

emm<-emmeans(model, ~ Temperature)
pairs(emm)

emm<-emmeans(model, ~ Symbiont)
pairs(emm)
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="p_gross_high")%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="p_gross_medium")%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="p_gross_low")%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="p_net_low")%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="p_net_medium")%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
```

```{r}
model<-pi_temp_data_calc%>%
  filter(Metric=="p_net_high")%>%
  aov(Value~Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, c("Temperature"))
```

## Test effect of light 

Test effect of light on P:R ratio. 
```{r}
model<-pi_temp_data_calc%>%
  filter(Metric %in% c("ratio_low", "ratio_medium", "ratio_high"))%>%
  filter(Value>0)%>%
  aov(Value~Metric*Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, "Metric")
TukeyHSD(model, "Temperature")
TukeyHSD(model, "Symbiont")

emm<-emmeans(model, ~ Metric | Temperature)
pairs(emm)

emm<-emmeans(model, ~ Symbiont | Temperature)
pairs(emm)

emm<-emmeans(model, ~ Symbiont | Temperature | Metric)
pairs(emm)

emm<-emmeans(model, ~ Metric)
pairs(emm)

emm<-emmeans(model, ~ Temperature)
pairs(emm)

```

Test effect of light on P gross.  
```{r}
model<-pi_temp_data_calc%>%
  filter(Metric %in% c("p_gross_low", "p_gross_medium", "p_gross_high"))%>%
  aov(Value~Metric*Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, "Metric")
TukeyHSD(model, "Temperature")

emm<-emmeans(model, ~ Symbiont | Temperature | Metric)
pairs(emm)

emm<-emmeans(model, ~ Symbiont | Temperature)
pairs(emm)

emm<-emmeans(model, ~ Metric)
pairs(emm)

emm<-emmeans(model, ~ Temperature)
pairs(emm)

emm<-emmeans(model, ~ Symbiont)
pairs(emm)
```

Test effect of light on P net.   
```{r}
model<-pi_temp_data_calc%>%
  filter(Metric %in% c("p_net_low", "p_net_medium", "p_net_high"))%>%
  aov(Value~Metric*Temperature*Symbiont, data=.)

summary(model)

TukeyHSD(model, "Metric")
TukeyHSD(model, "Temperature")

emm<-emmeans(model, ~ Metric | Temperature)
pairs(emm)
```

