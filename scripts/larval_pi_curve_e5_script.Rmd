---
title: "Adult PI Curve Plotting and Analysis - Hawaii 2023" 
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

# Setup  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if (!require("devtools")) install.packages("devtools")
if (!require("furrr")) install.packages("furrr")
if (!require("future")) install.packages("future")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("lubridate")) install.packages("lubridate")
if (!require("cowplot")) install.packages("cowplot")
if (!require("LoLinR")) install_github('colin-olito/LoLinR') 

## load libraries
library(devtools)
library(LoLinR)
library(tidyverse)
library(lubridate)
library(cowplot)

## libraries for parallel processing
library(future)
library(furrr)

## install packages if you dont already have them in your library
if ("segmented" %in% rownames(installed.packages()) == 'FALSE') install.packages('segmented') 
if ("plotrix" %in% rownames(installed.packages()) == 'FALSE') install.packages('plotrix') 
if ("gridExtra" %in% rownames(installed.packages()) == 'FALSE') install.packages('gridExtra') 
if ("chron" %in% rownames(installed.packages()) == 'FALSE') install.packages('chron') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 

#Read in required libraries

library("ggplot2")
library("segmented")
library("plotrix")
library("gridExtra")
library("chron")
library("broom")
```

# Step 1: Calculate rates 

## Import data
```{r}
path.p <- "data/larval_pi_curves/runs/" #the location of all your respirometry files 

# List data files
file.names <- list.files(path = path.p, pattern = "csv$")  # list all csv file names in the folder

# Load PI curve sample metadata (i.e., which larvae were in which runs)
sample.info <- read_csv(file = "data/larval_pi_curves/larval_PIcurve_SDR_Sample_Info.csv")%>%
  select(!TimeStart)%>%
  select(!TimeEnd)%>%
  select(!Notes)

# Load PI curve run metadata (i.e., light levels and interval times for each run)
run.info <- read_csv(file = "data/larval_pi_curves/larval_PIcurve_SDR_Run_Info.csv")

# Join all coral and run metadata
metadata <- full_join(sample.info, run.info) %>%
  mutate(Date = as_date(as.character(Date), format = "%Y%m%d"))
```

Read in data files. 
```{r}
# Read in all data files 
df <- tibble(file.name = file.names) %>%
  
  
  
  
  
  mutate(colony_id = gsub("_.*", "", file.name),                              # Get colony_id from filename
          info = map(colony_id, ~filter(metadata, colony_id == .)),           # Get associated sample info
         data0 = map(file.name, ~read_csv(file.path(path.p, .), skip = 1, col_types = cols(.default = "d", Time = "t"))))   # Get associated O2 data

# Select only Time, Value, and Temp columns from O2 data
df <- df %>%
  dplyr::mutate(data0 = map(data0, ~dplyr::select(., Time, Value, Temp)))%>%
  dplyr::mutate(data0 = map(data0, ~(.x %>% filter(complete.cases(.))))) #remove NAs to get rid of artifact line in our data
 
```


Go back and check this, not working for me ^^^ 


## Use the time breaks in the sample info to link O2 data with light levels

```{r, warning = FALSE}
df <- df %>%
  dplyr::mutate(intervals = map2(data0, info, function(.x, .y) {
    split(.x, f = cut(as.numeric(.x$Time), breaks = as.numeric(c(.y$Start.time, last(.y$Stop.time))),
                      labels = as.character(.y$Light_Value)))})) %>%
  dplyr::mutate(data = map(intervals, ~ unnest(tibble(.), .id = "Light_Value")))

## 'data' now contains the O2 data with the corresponding light level as another column
## Example of what 'data' for each sample looks like:
#df$data[[1]]
```

## Thin data
```{r, fig.height = 8, fig.width = 8}
# Set thinning parameter
thin_par <- 20

# Thin data for all samples
df <- df %>%
  mutate(thin_data = map(data, ~ slice(., seq(1, nrow(.), thin_par))))

# Create plots for full dataset and thinned data
df <- df %>%
  mutate(data_plot = map2(data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)),
    thin_data_plot = map2(thin_data, colony_id, ~ ggplot(.x, aes(x = Time, y = Value)) + 
                            facet_wrap(~ as.numeric(Light_Value), scales = "free") +
                            geom_point() +
                            labs(title = .y)))

# Example of plots
cowplot::plot_grid(df$data_plot[[1]], df$thin_data_plot[[1]], nrow = 2,
                   labels = c("Example plot: all data", "Example plot: thinned data"))
```

## Fit regressions to each interval for each sample
```{r}
# Define function for fitting LoLinR regressions to be applied to all intervals for all samples
fit_reg <- function(df) {
  rankLocReg(xall = as.numeric(df$Time), yall = df$Value, 
             alpha = 0.2, method = "pc", verbose = FALSE)
}

# Setup for parallel processing
future::plan(multiprocess)

# Map LoLinR function onto all intervals of each sample's thinned dataset
df <- df %>%
  mutate(regs = furrr::future_map(thin_data, function(.) {       # future_map executes function in parallel
    group_by(., Light_Value) %>%
    do(rankLcRg = fit_reg(.))
  }))

## Now 'regs' contains the fitted local regressions for each interval of each sample's thinned dataset

# Define function to pull out and plot regression diagnostics
plot_rankLcRg <- function(colony_id, interval_number) {
  df %>%
    filter(colony_id == colony_id) %>%
    pluck("regs", 1, "rankLcRg", interval_number) %>%
    plot()
}
```

The diagnostics for any regression can be plotted like this, specifying a colony_id and the number of the light curve interval:
```
plot_rankLcRg("ACR-225", 1)
```

## Extract slope of best regression for each interval for each sample
```{r}
df.out <- df %>% 
  unnest(regs) %>%
  mutate(micromol.L.s = map_dbl(rankLcRg, ~ pluck(., "allRegs", "b1", 1)))
```

## Adjust by chamber volume and normalize to surface area
```{r}
### Merge rates with sample info
pr <- left_join(
  select(df.out, colony_id, Light_Value, micromol.L.s),
  distinct(metadata, colony_id, Run, Chamber.Vol.L)
)

### Correct for chamber volume and blanks
pr <- pr %>%
  mutate(micromol.s = micromol.L.s * Chamber.Vol.L)

# Get blank values -- average for each run and light value in case multiple blanks
blanks <- pr %>%
  filter(grepl("BK", colony_id)) %>%
  group_by(Run, Light_Value) %>%
  dplyr::summarise(micromol.s.blank = mean(micromol.s))

# Join blank values with rest of data and subtract values from samples for same run and light value
pr <- left_join(pr, blanks) %>%
  mutate(micromol.s.adj = micromol.s - micromol.s.blank) %>%
  # After correcting for blank values, remove blanks from data
  filter(!grepl("BK", colony_id))

# Import surface area data
sa <- read.csv("data/adult_pi_curves/surface_area.csv")

# Join surface area with rest of data
pr <- left_join(pr, select(sa, colony_id, surface.area.cm2))

# Normalize rates by surface area
pr <- pr %>%
  mutate(micromol.cm2.s = micromol.s.adj / surface.area.cm2,
         micromol.cm2.h = micromol.cm2.s * 3600)
```

## Plot rates vs. irradiance for each sample
```{r, fig.height=15, fig.width = 10}
ggplot(pr, aes(x = as.numeric(Light_Value), y = micromol.cm2.h)) +
  geom_point() +
  facet_wrap(~colony_id, scale = "free_y", ncol = 9)
```

## Write to output file
```{r}
# Select variables to write to file
pr.out <- pr %>% 
  select(colony_id, Light_Value, Run, micromol.cm2.s, micromol.cm2.h) %>%
  mutate(timepoint="timepoint1")

# Write to output file
write.csv(pr.out, "output/adult_pi_curves/adult_pi_curve_rates.csv")
```

# Step 2: Conduct nls 

## Import data
```{r import_data}
Data <- read.csv(file = 'output/adult_pi_curves/adult_pi_curve_rates.csv')
```

## Define data  

```{r}
#specify data
Data$PAR <- as.numeric(Data$Light_Value)
Data$Pc <- as.numeric(Data$micromol.cm2.h)
```

## Define PI curve function as a nonlinear Least Squares regression of a quadratic fit, test nls fit

Aquatic Photosynthesis, Falkowski   
Pmax = max photosynthesis (AKA Am from Bayesian script)  
alpha = quantum yeild (AKA AQY from Bayesian script)  
I/E = irradiance (AKA PAR from Bayesian script)  
Rd = dark respiration   

Run models 

Using fixed initial values (keeping for reference):  

```{r}
#nls_data <- Data %>% 
   #filter(colony_id==c("ACR-140"))%>%
   #group_by(colony_id) %>%
   #nest(-colony_id) %>%
   #mutate(model1 = map(data, ~ 
                        # nls(Pc ~ (Am*((AQY*PAR)/(sqrt(Am^2 + (AQY*PAR)^2)))-Rd), data=., start=list(Am=0.7,  AQY=0.001, Rd=.4)) %>%
                             # tidy %>%
                             # dplyr::select(term, estimate) %>% 
                             # spread(term, estimate))) %>%
  #unnest(model1) %>%
  #unnest(data) %>%
  #group_by(colony_id)%>%
  #summarise(Am=mean(Am), AQY=mean(AQY), Rd=mean(Rd))%>%
  #mutate(timepoint="timepoint1")%>%
  #write_csv(., "output/1_pi_curve_pars_NLS_fixed_inis.csv")
```

Using flexible initial values based on input data:  

```{r}
nls_data <- Data %>% 
   #filter(colony_id==c("ACR-140"))%>%
   group_by(colony_id) %>%
   nest(-colony_id) %>%
   mutate(model1 = map(data, ~ 
                         nls(Pc ~ (Am*((AQY*PAR)/(sqrt(Am^2 + (AQY*PAR)^2)))-Rd), data=., start=list(Am=(max(.$Pc)-min(.$Pc)),  AQY=0.001, Rd=-min(.$Pc))) %>%
                              tidy %>%
                              dplyr::select(term, estimate) %>% 
                              spread(term, estimate))) %>%
  unnest(model1) %>%
  unnest(data) %>%
  group_by(colony_id)%>%
  summarise(Am=mean(Am), AQY=mean(AQY), Rd=mean(Rd))%>%
  mutate(timepoint="timepoint1")%>%
  write_csv(., "output/adult_pi_curves/pi_curve_pars_nls.csv")
```

Plot curve over data points.  
```{r}
augmented <- Data %>% 
  nest(-colony_id) %>% 
  mutate(
    fit = map(data, ~ nls(Pc ~ (Am*((AQY*PAR)/(sqrt(Am^2 + (AQY*PAR)^2)))-Rd), data=., start=list(Am=0.7,  AQY=0.001, Rd=.4))),
    augmented = map(fit, augment),
  ) %>% 
  unnest(augmented)


#all colonies together
augmented %>%
  group_by(colony_id)%>%
  qplot(PAR, Pc, data = ., geom = 'point', colour = colony_id) +
  geom_line(aes(y=.fitted))+
  theme(legend.position="none")


#view individual plots
by(augmented,augmented$colony_id, function(i) {
  ggplot(i) +
          geom_point(aes(PAR, Pc, group=colony_id)) + 
          geom_line(aes(y=.fitted, x=PAR)) + 
          theme_classic()+
          labs(x = expression(paste('PAR (', mu, "mol photons m"^-2, 's'^-1,")")),
               y = expression(paste('Photosynthetic rate (', mu, "mol cm"^-2, 'h'^-1,")")),
               title = paste0("1_", augmented$colony_id))
})
```

# Step 3: Plot PI curves 

## Import PI curve fitted parameters for each individual
```{r}
pars <- read_csv("output/adult_pi_curves/pi_curve_pars_nls.csv")
```

## Import sample metadata
```{r}
md <- read_csv("data/adult_pi_curves/pi_curves_sample_metadata.csv")

df <- left_join(pars, md)

#add scripts here to keep only desired columns 
```

## Plot data with mean ± SE for each species/site

```{r, fig.height = 8}
# Facet grid with common y-scale for each variable

pdf("output/adult_pi_curves/PI_metrics_Am_nls.pdf")
df %>%
  #filter(!.variable %in% c("sigma", "b_theta_Intercept", NA)) %>%
  ggplot(aes(x = site, y = Am, color = species)) +
  facet_grid(~species, scales = "free_y") +
  geom_jitter(width = 0.1) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1),    # Plot standard error
               geom = "errorbar", color = "black", width = 0.5) +
  stat_summary(fun.y = mean, geom = "point", color = "black")   
dev.off()

pdf("output/adult_pi_curves/PI_metrics_AQY_nls.pdf")
df %>%
  #filter(!.variable %in% c("sigma", "b_theta_Intercept", NA)) %>%
  ggplot(aes(x = site, y = AQY, color = species)) +
  facet_grid(~species, scales = "free_y") +
  geom_jitter(width = 0.1) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1),    # Plot standard error
               geom = "errorbar", color = "black", width = 0.5) +
  stat_summary(fun.y = mean, geom = "point", color = "black")   
dev.off()

pdf("output/adult_pi_curves/PI_metrics_Rd_nls.pdf")
df %>%
  #filter(!.variable %in% c("sigma", "b_theta_Intercept", NA)) %>%
  ggplot(aes(x = site, y = Rd, color = species)) +
  facet_grid(~species, scales = "free_y") +
  geom_jitter(width = 0.1) +
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1),    # Plot standard error
               geom = "errorbar", color = "black", width = 0.5) +
  stat_summary(fun.y = mean, geom = "point", color = "black")   
dev.off()

```

# Plot species average PI curve for each site using mean parameter values
```{r, fig.width = 10}
#arrange data in long format
df <- df%>%
  gather("parameter", "value", 2:4)
df$parameter<-as.factor(df$parameter)
df$symbiont<-as.factor(df$symbiont)
df$colony_id<-as.factor(df$colony_id)

# Get mean parameter values for each species and site
meanpars <- df %>%
  #drop_na(.variable) %>%  # Drops rows with NA for .variable (samples that failed PI curve fitting)
  group_by(symbiont, parameter) %>%
  dplyr::summarize(meanval = mean(value)) %>%
  pivot_wider(names_from = parameter, values_from = meanval) %>%
  #rename(Am = b_Am_Intercept, AQY = b_AQY_Intercept, Rd = b_Rd_Intercept, theta = b_theta_Intercept) %>%
  ungroup()

# Define PI curve function
PIfun <- function(I, Am, AQY, Rd) {
  (Am*((AQY*I)/(sqrt(Am^2 + (AQY*I)^2)))-Rd)
}

# Produce PI curve for each species/site
curves <- meanpars %>%
  nest(pars = c(Am, AQY, Rd)) %>%
  mutate(I = list(1:1000),
         PIcurve = map2(pars, I, ~ pmap_dfc(.x, .f = PIfun, I = .y)))   # curve for each par set and Irradiance

# Plot
pdf("output/adult_pi_curves/PI_curves_species_nls.pdf")
curves %>% 
  unnest(cols = c(I, PIcurve)) %>%
  ggplot(aes(x = I, y = ...1, color = species)) +
  geom_line() +
  facet_wrap(~ site) +
  theme_classic()+
  labs(x = expression(paste('PAR (', mu, "mol photons m"^-2, 's'^-1,")")),
       y = expression(paste('Photosynthetic rate (', mu, "mol O2 cm"^-2, 'h'^-1,")")),
       title = "")
dev.off()

# Save mean photosynthesis pars for each species/site to file
meanpars %>%
  write_csv(path = "output/adult_pi_curves/photosynthesis_pars_summary_nls.csv")
```









