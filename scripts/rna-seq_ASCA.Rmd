---
title: "RNAseq ASCA Analysis"
author: "Ariana S Huffmyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

Trigg et al 2020 BMC Genomics 
- Found location of "diminishing returns" of PC loading scores to determine which proteins were "most important" to each PC 
https://doi.org/10.1186/s12864-020-07127-3

Analysis of RNAseq data using ASCA (ANOVA Simultaneous Component Analysis) to examine how gene expression changes across temperatures for each parental phenotype.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# The following setting is important, do not omit.
options(stringsAsFactors = FALSE) #Set Strings to character
```

# Load libraries

```{r}
library("tidyverse")
library("genefilter")
library("DESeq2")
library("RColorBrewer")
library("ALASCA")
library(purrr)
library(readr)
library(tibble)
```

# Data input and filtering

Import the data files.

```{r}
#load metadata sheet with sample name and developmental stage information
metadata <- read.csv("data/rna_seq/sample_rnaseq_metadata.csv", header = TRUE, sep = ",")%>%
  dplyr::select(sample, temperature, parent, symbiont, phenotype)
metadata$code<-paste0(metadata$temperature, "_", metadata$parent)
head(metadata)

#load gene count matrix generated from cluster computation
gcount <- as.data.frame(read.csv("data/rna_seq/Mcapitata2023_gene_count_matrix_STAR.csv", row.names="gene_id"), colClasses = double)
head(gcount)
```

Check that there are no genes with 0 counts across all samples.

```{r}
dim(gcount) 

gcount<-gcount %>%
     mutate(Total = rowSums(.[, 1:54]))%>%
    filter(!Total==0)%>%
    dplyr::select(!Total)

dim(gcount)
```

Conduct data filtering using pOverA approach.

```{r}
filt <- filterfun(pOverA(0.1,10))

#create filter for the counts data
gfilt <- genefilter(gcount, filt)

#identify genes to keep by count filter
gkeep <- gcount[gfilt,]

#identify gene lists
gn.keep <- rownames(gkeep)

#gene count data filtered in PoverA, P percent of the samples have counts over A
gcount_filt <- as.data.frame(gcount[which(rownames(gcount) %in% gn.keep),])

#How many rows do we have before and after filtering?
nrow(gcount) #Before
nrow(gcount_filt) #After
```

Prepare sample names.

```{r}
# Function to extract 'R' followed by numbers from column names
extract_R_numbers <- function(col_names) {
  sub("R(\\d+).*", "\\1", col_names)
}

# Apply the function to all column names
new_col_names <- sapply(names(gcount_filt), extract_R_numbers)

# Rename the columns
names(gcount_filt) <- paste0("R", new_col_names)

# remove "trim." from the name
names(gcount_filt) <- gsub("trim\\.", "", names(gcount_filt))

# Output the modified dataframe
names(gcount_filt)
length(names(gcount_filt))
```

# Format metadata and count data

Convert temperature and metadata categories to factors.

```{r}
metadata$temperature<-as.factor(metadata$temperature)
metadata$parent<-as.factor(metadata$parent)
metadata$symbiont<-as.factor(metadata$symbiont)
metadata$code<-as.factor(metadata$code)
```

Set levels of factors.

```{r}
metadata$temperature<-factor(metadata$temperature, levels=c("27", "30", "33"))
metadata$parent<-factor(metadata$parent, levels=c("Wildtype", "Bleached", "Nonbleached"))
metadata$code<-factor(metadata$code, levels=c("27_Wildtype", "27_Bleached", "27_Nonbleached", "30_Wildtype", "30_Bleached", "30_Nonbleached", "33_Wildtype", "33_Bleached", "33_Nonbleached"))
```

Reorder metadata to match gene count columns.

```{r}
list<-colnames(gcount_filt)
list<-as.factor(list)

metadata$sample<-as.factor(metadata$sample)

# Re-order the levels
metadata$sample <- factor(as.character(metadata$sample), levels=list)
# Re-order the data.frame
metadata_ordered <- metadata[order(metadata$sample),]
metadata_ordered$sample

head(metadata_ordered)

metadata_ordered$sample
colnames(gcount_filt)
head(gcount_filt)
```

# Normalize data using VST transformation

Create a DESeqDataSet and apply variance stabilizing transformation for normalization.

```{r}
#Set DESeq2 design
gdds <- DESeqDataSetFromMatrix(countData = gcount_filt,
                              colData = metadata_ordered,
                             design = ~temperature + parent + temperature:parent)
```

Calculate size factors and check if VST can be used (size factors should be <4).

```{r}
SF.gdds <- estimateSizeFactors(gdds)
print(sizeFactors(SF.gdds))

all(sizeFactors(SF.gdds)) < 4
```

Apply VST transformation.

```{r}
gvst <- vst(gdds, blind=TRUE)
head(assay(gvst), 3)
dim(gvst)
```

Extract normalized counts.

```{r}
normalized_counts <- assay(gvst)
dim(normalized_counts)
head(normalized_counts)
```

# Prepare data for ASCA analysis

Create long format data with sample, temperature, parent, gene, and value columns.

```{r}
# Transpose and convert to dataframe
normalized_df <- as.data.frame(t(normalized_counts))
normalized_df$sample <- rownames(normalized_df)
rownames(normalized_df) <- NULL

# Add metadata
normalized_df <- normalized_df %>%
  left_join(metadata_ordered %>% dplyr::select(sample, temperature, parent), by = "sample")

# Reorder columns to put metadata first
normalized_df <- normalized_df %>%
  dplyr::select(sample, temperature, parent, everything())

head(normalized_df[, 1:10])
```

Make sure there are no missing values or NAs. 
```{r}
str(normalized_df)

sum(is.na(normalized_df))
sum(is.infinite(as.matrix(normalized_df[, -(1:3)])))

na_per_col <- colSums(is.na(normalized_df))
summary(na_per_col)

cols_with_na <- names(na_per_col[na_per_col > 0])
length(cols_with_na)
cols_with_na[1:10]

inf_per_col <- colSums(is.infinite(as.matrix(normalized_df[, -(1:3)])))
names(inf_per_col[inf_per_col > 0])

na_per_row <- rowSums(is.na(normalized_df))
summary(na_per_row)

expr_mat <- normalized_df[, -(1:3)]  # expression only

zero_var_cols <- apply(expr_mat, 2, function(x) sd(x, na.rm = TRUE) == 0)
sum(zero_var_cols)
names(zero_var_cols[zero_var_cols])[1:10]

nzv_cols <- apply(expr_mat, 2, function(x) sd(x, na.rm = TRUE) < 1e-6)
sum(nzv_cols)

with(normalized_df, table(temperature, parent))
```

Convert to long format for ALASCA.

```{r}
str(normalized_df)

long_data <- normalized_df %>%
  pivot_longer(cols = -c(sample, temperature, parent), 
               names_to = "variable", 
               values_to = "value")

str(long_data)
head(long_data)
```

View any NA or Inf values. 

```{r}
long_data%>%
  filter(if_any(everything(), is.na))

long_data%>%
  filter(is.infinite(value))
```

No NA or INF values. 

# Run ASCA analysis for all parental phenotypes

For initial analysis run with 10 runs, do full validation at 1000 runs. 

Run ASCA model with temperature and phenotype as the main effect and sample as random effect.

Samples are stratified by group. With an n=6, random resampling can sometimes cause validation to fail if resampling excludes a group randomly. This conducts random resampling with representatives of each group in each run. We will not perform additional scaling because data is already variance stabilize transformed. 

Analyze effects in the model of parent, temperature, and parent:temperature. Determine PC's for each effect. 

Full validation with 1000 runs takes about 1.5 h to run. Suggest to run this script as a background job. Needs to run with larger memory. 
```{r}
long_data<-long_data%>%
  mutate(code = interaction(temperature, parent, drop = TRUE))

set.seed(123)

res_all <- ALASCA(
  long_data,
  value ~ temperature * parent + (1|sample),
  effects=c("temperature", "parent", "temperature:parent"),
  n_validation_runs = 1000,
  scale_function = "none",
  validate = TRUE,
  stratification_column = "code",
  p_adjust_method = "fdr",
  reduce_dimensions = TRUE
)

saveRDS(res_all, file = "output/rna_seq/asca/asca_results_genes.rds")
```

Read in R data file of full validation run if not running full validation.
```{r}
res_all <- readRDS("output/rna_seq/asca/asca_results_genes.rds")
```

```{r}
#temp
plot(res_all, component = seq(1,10), effect = 1, type = 'scree')
#2 PCs >10%

#parent
plot(res_all, component = seq(1,10), effect = 2, type = 'scree')
#2 PCs >10%

#parent:temperature
plot(res_all, component = seq(1,10), effect = 3, type = 'scree')
#3 PCs >10%

#temp

#increase with temp
plot(res_all, effect = 1, component = 1, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     #palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())

#different at 30C than 27 and 33 
plot(res_all, effect = 1, component = 2, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     #palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())

#parent

#Different in bleached
plot(res_all, effect = 2, component = 1, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     #palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())

#Different between all parents
plot(res_all, effect = 2, component = 2, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     #palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())

#parent:temperature

#Different between parents at high temperature, linear response to temperature 
plot(res_all, effect = 3, component = 1, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())

#Different between parents at high temperature, with peak/decrease at 30C 
plot(res_all, effect = 3, component = 2, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     #palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())

#Higher in bleached across temperatures than NB/WT  
plot(res_all, effect = 3, component = 3, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     #palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())
```































Generate scree plot.

```{r}
pdf(file="figures/rna_seq/asca/scree_plot.pdf", width=6, height=4)
plot(res_all, component = seq(1,10), effect = 1, type = 'scree')
dev.off()
```

Plot significant components (>1% variance explained).

```{r}
# PC1
pdf(file="figures/rna_seq/asca/PC1.pdf", width=10, height=6)
plot(res_all, effect = 1, component = 1, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())
dev.off()

# PC1
pdf(file="figures/rna_seq/asca/PC2.pdf", width=10, height=6)
plot(res_all, effect = 1, component = 2, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())
dev.off()

# PC3
pdf(file="figures/rna_seq/asca/PC3.pdf", width=10, height=6)
plot(res_all, effect = 1, component = 3, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/rna_seq/asca/PC4.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 4, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/rna_seq/asca/PC5.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 5, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/rna_seq/asca/PC6.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 6, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/rna_seq/asca/PC7.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 7, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/rna_seq/asca/PC8.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 8, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/rna_seq/asca/PC9.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 9, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/rna_seq/asca/PC10.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 10, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()
```

Make combined plot for PC1-3. 
```{r}
# PC1-3
pdf(file="figures/rna_seq/asca/PC1-PC3.pdf", width=12, height=12)
plot(res_all, effect = 1, component = c(1,2,3), type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())
dev.off()
```

Plot top genes contributing to each component.

```{r}
# PC1 genes
pdf(file="figures/rna_seq/asca/PC1_genes.pdf", width=16, height=6)
plot(res_all, component = 1, effect = 1, type = 'prediction', n_limit = 20, variable = c(), palette = c("darkgray", "orange", "darkred"))
dev.off()

# PC2 genes
pdf(file="figures/rna_seq/asca/PC2_genes.pdf", width=16, height=6)
plot(res_all, component = 2, effect = 1, type = 'prediction', n_limit = 20, variable = c(), palette = c("darkgray", "orange", "darkred"))
dev.off()

# PC3 genes
pdf(file="figures/rna_seq/asca/PC3_genes.pdf", width=16, height=6)
plot(res_all, component = 3, effect = 1, type = 'prediction', n_limit = 20, variable = c(), palette = c("darkgray", "orange", "darkred"))
dev.off()
```

Extract top genes from PC1 to PC3 for each component.

```{r}
loadings1 <- get_loadings(res_all, component=1, effect=1, n_limit=20)
list1 <- loadings1[[1]]$covars

loadings2 <- get_loadings(res_all, component=2, effect=1, n_limit=20)
list2 <- loadings2[[1]]$covars

loadings3 <- get_loadings(res_all, component=3, effect=1, n_limit=20)
list3 <- loadings3[[1]]$covars

# Combine all lists
list_wt <- data.frame(
  PC1 = c(list1, rep(NA, max(0, 20 - length(list1)))),
  PC2 = c(list2, rep(NA, max(0, 20 - length(list2)))),
  PC3 = c(list3, rep(NA, max(0, 20 - length(list3))))
)
```

# Determine top contributing genes to PC1, PC2, and PC3 quantitatively 

Identify top genes for PC1â€“PC3 using a cumulative variance explained method for each PC. 

I am going to use a 50% threshold cut off, which will keep only the very strong drivers (genes explaining the first 50% of variance on each PC).

## PC1: temperature (linear change with temperature) 

### Variance explained threshold method 

```{r}
# 1. Extract all loadings for PC1 (effect 1 = temperature * parent)
pc1_raw <- get_loadings(res_all, effect = 1, component = 1)

# ALASCA usually returns a list; first element holds the data
if (is.list(pc1_raw) && !inherits(pc1_raw, "data.frame")) {
  pc1_df <- as.data.frame(pc1_raw[[1]])
} else {
  pc1_df <- as.data.frame(pc1_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(pc1_df)) {
  stop("Could not find 'covars' column in PC1 loadings; check the structure of pc1_df.")
}

gene_vec <- pc1_df$covars

num_cols <- names(pc1_df)[sapply(pc1_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC1 loadings.")
}
loading_col <- num_cols[2]  # typically the PC1 loading column

pc1_load <- pc1_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(pc1_load)
x <- (pc1_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (pc1_load$abs_loading - min(pc1_load$abs_loading)) /
     (max(pc1_load$abs_loading) - min(pc1_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- pc1_load$rank[elbow_idx]
elbow_gene <- pc1_load$gene[elbow_idx]

# 3. 80% cumulative variance threshold as a comparison
idx_80_var <- which(pc1_load$cum_var >= 0.50)[1]

pc1_load <- pc1_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_80_var = rank <= idx_80_var
  )

cat("PC1 important genes by elbow selection: ",
    sum(pc1_load$selected_elbow), "\n")
cat("PC1 important genes by 80% variance selection: ",
    sum(pc1_load$selected_80_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/rna_seq/asca/PC1_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(pc1_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
  annotate("text",
           x = idx_80_var,
           y = max(pc1_load$abs_loading) * 0.9,
           label = paste0("50% var (", idx_80_var, " genes)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC1 loading|",
    title = "PC1 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/rna_seq/asca/PC1_cumulative_variance.pdf", width = 7, height = 5)
ggplot(pc1_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
   annotate("text",
           x = idx_80_var,
           y = max(pc1_load$abs_loading) * 0.9,
           label = paste0("50% var (", idx_80_var, " genes)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "PC1 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
pc1_important_80 <- pc1_load %>%
  filter(rank <= idx_80_var)

write.csv(pc1_important_80,
          "output/rna_seq/asca/PC1_important_genes_50pct_variance.csv",
          row.names = FALSE)

```

4053 genes are most important in describing PC1 

## PC2: symbiont (C-only different than C&D mix symbionts) 

```{r}
# 1. Extract all loadings for PC1 (effect 1 = temperature * parent)
pc2_raw <- get_loadings(res_all, effect = 1, component = 2)

# ALASCA usually returns a list; first element holds the data
if (is.list(pc2_raw) && !inherits(pc2_raw, "data.frame")) {
  pc2_df <- as.data.frame(pc2_raw[[1]])
} else {
  pc2_df <- as.data.frame(pc2_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(pc2_df)) {
  stop("Could not find 'covars' column in PC2 loadings; check the structure of pc2_df.")
}

gene_vec <- pc2_df$covars

num_cols <- names(pc2_df)[sapply(pc2_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC2 loadings.")
}
loading_col <- num_cols[2]  # typically the PC2 loading column

pc2_load <- pc2_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(pc2_load)
x <- (pc2_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (pc2_load$abs_loading - min(pc2_load$abs_loading)) /
     (max(pc2_load$abs_loading) - min(pc2_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- pc2_load$rank[elbow_idx]
elbow_gene <- pc2_load$gene[elbow_idx]

# 3. 80% cumulative variance threshold as a comparison
idx_80_var <- which(pc2_load$cum_var >= 0.50)[1]

pc2_load <- pc2_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_80_var = rank <= idx_80_var
  )

cat("PC2 important genes by elbow selection: ",
    sum(pc2_load$selected_elbow), "\n")
cat("PC2 important genes by 80% variance selection: ",
    sum(pc2_load$selected_80_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/rna_seq/asca/PC2_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(pc2_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
  annotate("text",
           x = idx_80_var,
           y = max(pc2_load$abs_loading) * 0.9,
           label = paste0("50% var (", idx_80_var, " genes)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC2 loading|",
    title = "PC2 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/rna_seq/asca/PC2_cumulative_variance.pdf", width = 7, height = 5)
ggplot(pc2_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
   annotate("text",
           x = idx_80_var,
           y = max(pc2_load$abs_loading) * 0.9,
           label = paste0("50% var (", idx_80_var, " genes)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "PC2 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
pc2_important_80 <- pc2_load %>%
  filter(rank <= idx_80_var)

write.csv(pc2_important_80,
          "output/rna_seq/asca/PC2_important_genes_50pct_variance.csv",
          row.names = FALSE)

```

3247 genes are important in describing PC2 (differences between C only and C&D mixed symbiont groups) 

## PC3: parental signature (different between each parent type) 

```{r}
# 1. Extract all loadings for PC1 (effect 1 = temperature * parent)
pc3_raw <- get_loadings(res_all, effect = 1, component = 3)

# ALASCA usually returns a list; first element holds the data
if (is.list(pc3_raw) && !inherits(pc3_raw, "data.frame")) {
  pc3_df <- as.data.frame(pc3_raw[[1]])
} else {
  pc3_df <- as.data.frame(pc3_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(pc3_df)) {
  stop("Could not find 'covars' column in PC3 loadings; check the structure of pc3_df.")
}

gene_vec <- pc3_df$covars

num_cols <- names(pc3_df)[sapply(pc3_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC3 loadings.")
}
loading_col <- num_cols[2]  # typically the PC3 loading column

pc3_load <- pc3_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(pc3_load)
x <- (pc3_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (pc3_load$abs_loading - min(pc3_load$abs_loading)) /
     (max(pc3_load$abs_loading) - min(pc3_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- pc3_load$rank[elbow_idx]
elbow_gene <- pc3_load$gene[elbow_idx]

# 3. 80% cumulative variance threshold as a comparison
idx_80_var <- which(pc3_load$cum_var >= 0.50)[1]

pc3_load <- pc3_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_80_var = rank <= idx_80_var
  )

cat("PC3 important genes by elbow selection: ",
    sum(pc3_load$selected_elbow), "\n")
cat("PC3 important genes by 80% variance selection: ",
    sum(pc3_load$selected_80_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/rna_seq/asca/PC3_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(pc3_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
  annotate("text",
           x = idx_80_var,
           y = max(pc3_load$abs_loading) * 0.9,
           label = paste0("50% var (", idx_80_var, " genes)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC3 loading|",
    title = "PC3 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/rna_seq/asca/PC3_cumulative_variance.pdf", width = 7, height = 5)
ggplot(pc3_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
   annotate("text",
           x = idx_80_var,
           y = max(pc3_load$abs_loading) * 0.9,
           label = paste0("50% var (", idx_80_var, " genes)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "PC3 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
pc3_important_80 <- pc3_load %>%
  filter(rank <= idx_80_var)

write.csv(pc3_important_80,
          "output/rna_seq/asca/PC3_important_genes_50pct_variance.csv",
          row.names = FALSE)

```

3225 genes are important in describing PC3 (differences between parent groups) 

## Compare lists of genes 

```{r}
pc1_list<-pc1_important_80%>%pull(gene)
pc2_list<-pc2_important_80%>%pull(gene)
pc3_list<-pc3_important_80%>%pull(gene)
```

```{r}
# install.packages("UpSetR")   # if needed
library(UpSetR)

# Create list object for upset
gene_lists <- list(
  PC1 = pc1_list,
  PC2 = pc2_list,
  PC3 = pc3_list
)

# Convert list to binary matrix for UpSetR
upset_data <- fromList(gene_lists)

# Plot
pdf("figures/rna_seq/asca/PC1_PC2_PC3_upset.pdf", width = 8, height = 6)
upset(upset_data,
      order.by = "freq",
      sets = c("PC1", "PC2", "PC3"),
      sets.bar.color = "black",
      mainbar.y.label = "Intersection size",
      sets.x.label = "Set size"
)
dev.off()
```

