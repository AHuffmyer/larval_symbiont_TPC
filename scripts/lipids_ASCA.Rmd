---
title: "Lipidomics ASCA Analysis"
author: "Ariana S Huffmyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

Analysis of lipidomic data using ASCA (ANOVA Simultaneous Component Analysis) to examine how lipids changes across temperatures for each parental phenotype.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# The following setting is important, do not omit.
options(stringsAsFactors = FALSE) #Set Strings to character
```

# Load libraries

```{r}
library("tidyverse")
library("genefilter")
library("DESeq2")
library("RColorBrewer")
library("ALASCA")
library(purrr)
library(readr)
library(tibble)
library(circlize)
library(ComplexHeatmap)
```

# Data input and filtering

Read in data. 

```{r}
lipids<-read_csv("output/lipids_metabolites/lipids/processed_lipids.csv")
```

# Prepare data for ASCA analysis

Select data for long format for ALASCA.

```{r}
long_data <- lipids %>%
  select(sample, temperature, parent, lipid, area_normalized)%>%
  rename(lipid="variable", area_normalized="value")

head(long_data)

long_data$temperature<-factor(long_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

long_data$parent<-factor(long_data$parent, levels=c("Wildtype", "Bleached", "Nonbleached"))
```

View any NA or Inf values. 

```{r}
long_data%>%
  filter(if_any(everything(), is.na))

long_data%>%
  filter(is.infinite(value))
```

No NA or INF values. 

Data in format of sample, temperature, parent, variable (lipid), and value (normalized concentration)

# Run ASCA analysis for all parental phenotypes

Start with 10 runs, increase to 100 for full analysis. 

Run ASCA model with temperature and phenotype as the main effect and sample as random effect.

```{r}
res_all <- ALASCA(
  long_data,
  value ~ temperature * parent + (1|sample),
  n_validation_runs = 50,
  validate = TRUE,
  reduce_dimensions = TRUE
)
```

Generate scree plot.

```{r}
pdf(file="figures/lipids/asca/scree_plot.pdf", width=6, height=4)
plot(res_all, component = seq(1,10), effect = 1, type = 'scree')
dev.off()
```

Plot significant components (>10% variance explained).

```{r}
# PC1
pdf(file="figures/lipids/asca/PC1.pdf", width=10, height=6)
plot(res_all, effect = 1, component = 1, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())
dev.off()

# PC1
pdf(file="figures/lipids/asca/PC2.pdf", width=10, height=6)
plot(res_all, effect = 1, component = 2, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())
dev.off()

# PC3
pdf(file="figures/lipids/asca/PC3.pdf", width=10, height=6)
plot(res_all, effect = 1, component = 3, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/lipids/asca/PC4.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 4, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/lipids/asca/PC5.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 5, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/lipids/asca/PC6.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 6, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/lipids/asca/PC7.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 7, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/lipids/asca/PC8.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 8, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/lipids/asca/PC9.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 9, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()

pdf(file="figures/lipids/asca/PC10.pdf", width=10, height=4)
plot(res_all, effect = 1, component = 10, type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     palette = c("darkgray", "orange", "darkred"),
     flip_axis=TRUE,
     my_theme = theme_classic())
dev.off()
```

Make combined plot for PC1-3. 
```{r}
# PC1-3
pdf(file="figures/lipids/asca/PC1-PC3.pdf", width=12, height=12)
plot(res_all, effect = 1, component = c(1,2,3), type = 'effect', 
     n_limit=10, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("darkgray", "orange", "darkred"),
     my_theme = theme_classic())
dev.off()
```

Plot top genes contributing to each component.

```{r}
# PC1 genes
pdf(file="figures/lipids/asca/PC1_genes.pdf", width=16, height=6)
plot(res_all, component = 1, effect = 1, type = 'prediction', n_limit = 20, variable = c(), palette = c("darkgray", "orange", "darkred"))
dev.off()

# PC2 genes
pdf(file="figures/lipids/asca/PC2_genes.pdf", width=16, height=6)
plot(res_all, component = 2, effect = 1, type = 'prediction', n_limit = 20, variable = c(), palette = c("darkgray", "orange", "darkred"))
dev.off()

# PC3 genes
pdf(file="figures/lipids/asca/PC3_genes.pdf", width=16, height=6)
plot(res_all, component = 3, effect = 1, type = 'prediction', n_limit = 20, variable = c(), palette = c("darkgray", "orange", "darkred"))
dev.off()
```

Extract top genes from PC1 to PC3 for each component.

```{r}
loadings1 <- get_loadings(res_all, component=1, effect=1, n_limit=20)
list1 <- loadings1[[1]]$covars

loadings2 <- get_loadings(res_all, component=2, effect=1, n_limit=20)
list2 <- loadings2[[1]]$covars

loadings3 <- get_loadings(res_all, component=3, effect=1, n_limit=20)
list3 <- loadings3[[1]]$covars

# Combine all lists
list_wt <- data.frame(
  PC1 = c(list1, rep(NA, max(0, 20 - length(list1)))),
  PC2 = c(list2, rep(NA, max(0, 20 - length(list2)))),
  PC3 = c(list3, rep(NA, max(0, 20 - length(list3))))
)
```

# Determine top contributing lipids to PC1, PC2, and PC3 quantitatively 

Identify top genes for PC1–PC3 using a cumulative variance explained method for each PC. 

I am going to use an 25% threshold cut off (lipids explaining the first 50% of variance on each PC).

## PC1: temperature 

### Variance explained threshold method 

```{r}
# 1. Extract all loadings for PC1 (effect 1 = temperature * parent)
pc1_raw <- get_loadings(res_all, effect = 1, component = 1)

# ALASCA usually returns a list; first element holds the data
if (is.list(pc1_raw) && !inherits(pc1_raw, "data.frame")) {
  pc1_df <- as.data.frame(pc1_raw[[1]])
} else {
  pc1_df <- as.data.frame(pc1_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(pc1_df)) {
  stop("Could not find 'covars' column in PC1 loadings; check the structure of pc1_df.")
}

gene_vec <- pc1_df$covars

num_cols <- names(pc1_df)[sapply(pc1_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC1 loadings.")
}
loading_col <- num_cols[2]  # typically the PC1 loading column

pc1_load <- pc1_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(pc1_load)
x <- (pc1_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (pc1_load$abs_loading - min(pc1_load$abs_loading)) /
     (max(pc1_load$abs_loading) - min(pc1_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- pc1_load$rank[elbow_idx]
elbow_gene <- pc1_load$gene[elbow_idx]

# 3. 80% cumulative variance threshold as a comparison
idx_80_var <- which(pc1_load$cum_var >= 0.25)[1]

pc1_load <- pc1_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_80_var = rank <= idx_80_var
  )

cat("PC1 important genes by elbow selection: ",
    sum(pc1_load$selected_elbow), "\n")
cat("PC1 important genes by 80% variance selection: ",
    sum(pc1_load$selected_80_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/lipids/asca/PC1_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(pc1_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
  annotate("text",
           x = idx_80_var,
           y = max(pc1_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_80_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC1 loading|",
    title = "PC1 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/PC1_cumulative_variance.pdf", width = 7, height = 5)
ggplot(pc1_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
   annotate("text",
           x = idx_80_var,
           y = max(pc1_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_80_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "PC1 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
pc1_important_80 <- pc1_load %>%
  filter(rank <= idx_80_var)

write.csv(pc1_important_80,
          "output/lipids_metabolites/lipids/asca/PC1_important_lipids_25pct_variance.csv",
          row.names = FALSE)

```

72 lipids are most important in describing PC1 at 80% and 198 at 50% - proceeding with 50% cut off. 

## PC2: symbiont (C-only different than C&D mix symbionts) 

```{r}
# 1. Extract all loadings for PC1 (effect 1 = temperature * parent)
pc2_raw <- get_loadings(res_all, effect = 1, component = 2)

# ALASCA usually returns a list; first element holds the data
if (is.list(pc2_raw) && !inherits(pc2_raw, "data.frame")) {
  pc2_df <- as.data.frame(pc2_raw[[1]])
} else {
  pc2_df <- as.data.frame(pc2_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(pc2_df)) {
  stop("Could not find 'covars' column in PC2 loadings; check the structure of pc2_df.")
}

gene_vec <- pc2_df$covars

num_cols <- names(pc2_df)[sapply(pc2_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC2 loadings.")
}
loading_col <- num_cols[2]  # typically the PC2 loading column

pc2_load <- pc2_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(pc2_load)
x <- (pc2_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (pc2_load$abs_loading - min(pc2_load$abs_loading)) /
     (max(pc2_load$abs_loading) - min(pc2_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- pc2_load$rank[elbow_idx]
elbow_gene <- pc2_load$gene[elbow_idx]

# 3. 80% cumulative variance threshold as a comparison
idx_80_var <- which(pc2_load$cum_var >= 0.25)[1]

pc2_load <- pc2_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_80_var = rank <= idx_80_var
  )

cat("PC2 important genes by elbow selection: ",
    sum(pc2_load$selected_elbow), "\n")
cat("PC2 important genes by 80% variance selection: ",
    sum(pc2_load$selected_80_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/lipids/asca/PC2_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(pc2_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
  annotate("text",
           x = idx_80_var,
           y = max(pc2_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_80_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC2 loading|",
    title = "PC2 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/PC2_cumulative_variance.pdf", width = 7, height = 5)
ggplot(pc2_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
   annotate("text",
           x = idx_80_var,
           y = max(pc2_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_80_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "PC2 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
pc2_important_80 <- pc2_load %>%
  filter(rank <= idx_80_var)

write.csv(pc2_important_80,
          "output/lipids_metabolites/lipids/asca/PC2_important_lipids_25pct_variance.csv",
          row.names = FALSE)

```

36 lipids are important in describing PC2 (differences between C only and C&D mixed symbiont groups) 

## PC3: parental signature (different between each parent type) 

```{r}
# 1. Extract all loadings for PC1 (effect 1 = temperature * parent)
pc3_raw <- get_loadings(res_all, effect = 1, component = 3)

# ALASCA usually returns a list; first element holds the data
if (is.list(pc3_raw) && !inherits(pc3_raw, "data.frame")) {
  pc3_df <- as.data.frame(pc3_raw[[1]])
} else {
  pc3_df <- as.data.frame(pc3_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(pc3_df)) {
  stop("Could not find 'covars' column in PC3 loadings; check the structure of pc3_df.")
}

gene_vec <- pc3_df$covars

num_cols <- names(pc3_df)[sapply(pc3_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC3 loadings.")
}
loading_col <- num_cols[2]  # typically the PC3 loading column

pc3_load <- pc3_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(pc3_load)
x <- (pc3_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (pc3_load$abs_loading - min(pc3_load$abs_loading)) /
     (max(pc3_load$abs_loading) - min(pc3_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- pc3_load$rank[elbow_idx]
elbow_gene <- pc3_load$gene[elbow_idx]

# 3. 80% cumulative variance threshold as a comparison
idx_80_var <- which(pc3_load$cum_var >= 0.25)[1]

pc3_load <- pc3_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_80_var = rank <= idx_80_var
  )

cat("PC3 important genes by elbow selection: ",
    sum(pc3_load$selected_elbow), "\n")
cat("PC3 important genes by 80% variance selection: ",
    sum(pc3_load$selected_80_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/lipids/asca/PC3_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(pc3_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
  annotate("text",
           x = idx_80_var,
           y = max(pc3_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_80_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC3 loading|",
    title = "PC3 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/PC3_cumulative_variance.pdf", width = 7, height = 5)
ggplot(pc3_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_80_var, linetype = "dashed") +
   annotate("text",
           x = idx_80_var,
           y = max(pc3_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_80_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "PC3 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
pc3_important_80 <- pc3_load %>%
  filter(rank <= idx_80_var)

write.csv(pc3_important_80,
          "output/lipids_metabolites/lipids/asca/PC3_important_lipids_25pct_variance.csv",
          row.names = FALSE)

```

89 lipids are important in describing PC3 (differences between parent groups) 

## Compare lists of lipids 

```{r}
pc1_list<-pc1_important_80%>%pull(gene)
pc2_list<-pc2_important_80%>%pull(gene)
pc3_list<-pc3_important_80%>%pull(gene)
```

```{r}
# install.packages("UpSetR")   # if needed
library(UpSetR)

# Create list object for upset
gene_lists <- list(
  PC1 = pc1_list,
  PC2 = pc2_list,
  PC3 = pc3_list
)

# Convert list to binary matrix for UpSetR
upset_data <- fromList(gene_lists)

# Plot
pdf("figures/lipids/asca/PC1_PC2_PC3_upset.pdf", width = 8, height = 6)
upset(upset_data,
      order.by = "freq",
      sets = c("PC1", "PC2", "PC3"),
      sets.bar.color = "black",
      mainbar.y.label = "Intersection size",
      sets.x.label = "Set size"
)
dev.off()
```

# Plot a heatmap of the most important lipids from each PC

```{r}
#make data frames for each PC: pc1_conc, pc2_conc, pc3_conc
pc1_important_80<-pc1_important_80%>%mutate(PC="1")
pc2_important_80<-pc2_important_80%>%mutate(PC="2")
pc3_important_80<-pc3_important_80%>%mutate(PC="3")

importance<-rbind(pc1_important_80, pc2_important_80, pc3_important_80)

importance<-importance%>%select(gene, abs_loading, var_contrib, PC)%>%rename(gene="variable")
head(importance)

imp1<-importance%>%filter(PC=="1")

pc1_conc<-long_data%>%
  filter(variable %in% imp1$variable)%>%
  left_join(., importance)

imp2<-importance%>%filter(PC=="2")

pc2_conc<-long_data%>%
  filter(variable %in% imp2$variable)%>%
  left_join(., importance)
  
imp3<-importance%>%filter(PC=="3")

pc3_conc<-long_data%>%
  filter(variable %in% imp3$variable)%>%
  left_join(., importance)
```

PC1: Temperature 
```{r}
# Start from your original object
pc1_conc2 <- pc1_conc %>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- pc1_conc2 %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- pc1_conc2 %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- pc1_conc2 %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

# Explicit named colors for temperature
temp_cols <- c(
  "Ambient"       = "#2c7bb6",
  "Moderate (+3)" = "#7b3294",
  "High (+6)"     = "#d53e4f"
)

# Explicit named colors for parent
# Include a few possible variations for the 3rd level so it still works
parent_cols <- c(
  "Wildtype"    = "darkgray",
  "Bleached"    = "orange",
  "Nonbleached" = "darkred",
  "Non-bleached" = "darkred",
  "Resistant"   = "darkred"
)

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/PC1_heatmap.pdf", width = 9, height = 10)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$temperature,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "PC1: Temperature Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```

PC2: Symbiont
```{r}
# Start from your original object
pc2_conc2 <- pc2_conc %>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- pc2_conc2 %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- pc2_conc2 %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- pc2_conc2 %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/PC2_heatmap.pdf", width = 9, height = 10)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$parent,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "PC2: Symbiont Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```

PC3: Parent
```{r}
# Start from your original object
pc3_conc2 <- pc3_conc %>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- pc3_conc2 %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- pc3_conc2 %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- pc3_conc2 %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/PC3_heatmap.pdf", width = 9, height = 10)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$parent,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "PC3: Parent Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```

# Plot top 10 contributing lipids on each component 

PC1: Temperature effects 
```{r}
top10_pc1<-pc1_conc%>%
  filter(PC=="1")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=10)%>%
  pull(variable)

pc_plot1<-pc1_conc%>%
  filter(variable %in% top10_pc1)%>%
  
  ggplot(aes(x=temperature, y=value, colour=parent))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Parent (Symbiont)", labels=c("Wildtype (C/D)", "Bleached (C)", "Nonbleached (C/D)"), values=c("darkgray", "orange", "darkred"))+
  ggtitle("PC1: Temperature Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot1
  
ggsave(pc_plot1, filename="figures/lipids/asca/PC1_top10_lipids.png", height=6, width=12)
```

PC2: Symbiont effects 
```{r}
top10_pc2<-pc2_conc%>%
  filter(PC=="2")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=10)%>%
  pull(variable)

pc_plot2<-pc2_conc%>%
  filter(variable %in% top10_pc2)%>%
  
  ggplot(aes(x=temperature, y=value, colour=parent))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Parent (Symbiont)", labels=c("Wildtype (C/D)", "Bleached (C)", "Nonbleached (C/D)"), values=c("darkgray", "orange", "darkred"))+
  ggtitle("PC2: Symbiont Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot2
  
ggsave(pc_plot2, filename="figures/lipids/asca/PC2_top10_lipids.png", height=6, width=12)
```

PC2: Parent effects 
```{r}
top10_pc3<-pc3_conc%>%
  filter(PC=="3")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=10)%>%
  pull(variable)

pc_plot3<-pc3_conc%>%
  filter(variable %in% top10_pc3)%>%
  
  ggplot(aes(x=temperature, y=value, colour=parent))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Parent (Symbiont)", labels=c("Wildtype (C/D)", "Bleached (C)", "Nonbleached (C/D)"), values=c("darkgray", "orange", "darkred"))+
  ggtitle("PC3: Parent Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot3
  
ggsave(pc_plot3, filename="figures/lipids/asca/PC3_top10_lipids.png", height=6, width=12)
```

