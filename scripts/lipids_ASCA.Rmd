---
title: "Lipidomics ASCA Analysis"
author: "Ariana S Huffmyer"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

Analysis of lipidomic data using ASCA (ANOVA Simultaneous Component Analysis) to examine how lipids changes across temperatures for each parental phenotype.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# The following setting is important, do not omit.
options(stringsAsFactors = FALSE) #Set Strings to character
```

# Load libraries

```{r}
library("tidyverse")
library("genefilter")
library("DESeq2")
library("RColorBrewer")
library("ALASCA")
library(purrr)
library(readr)
library(tibble)
library(circlize)
library(ComplexHeatmap)
```

# Data input and filtering

Read in data that has been filtered, normalized, with outliers removed. 

```{r}
lipids<-read_csv("output/lipids_metabolites/lipids/processed_lipids.csv")
```

# Prepare data for ASCA analysis

Select data for long format for ALASCA.

```{r}
long_data <- lipids %>%
  select(sample, temperature, parent, lipid, area_normalized)%>%
  rename(lipid="variable", area_normalized="value")

head(long_data)

long_data$temperature<-factor(long_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

long_data$parent<-factor(long_data$parent, levels=c("Wildtype", "Nonbleached", "Bleached"))
```

View any NA or Inf values. 

```{r}
long_data%>%
  filter(if_any(everything(), is.na))

long_data%>%
  filter(is.infinite(value))
```

No NA or INF values. 

# Run ASCA analysis 

For initial analysis run with 10 runs, do full validation at 1000 runs. 

Run ASCA model with temperature and phenotype as the main effect and sample as random effect.

Samples are stratified by group. With an n=6, random resampling can sometimes cause validation to fail if resampling excludes a group randomly. This conducts random resampling with representatives of each group in each run. 

Use default scaling method sdall. 

Analyze effects in the model of parent, temperature, and parent:temperature. Determine PC's for each effect. 

Full validation with 1000 runs takes about 5 min to run. 

Use a log1p(value) transformation. 
```{r}
hist(long_data$value)
summary(long_data$value)

long_data<-long_data%>%
  mutate(code = interaction(temperature, parent, drop = TRUE))%>%
  mutate(value = log1p(value))

hist(long_data$value)
summary(long_data$value)

set.seed(123)

res_all <- ALASCA(
  long_data,
  value ~ temperature * parent + (1|sample),
  effects=c("temperature", "parent", "temperature:parent"),
  n_validation_runs = 1000,
  scale_function = "sdall",
  validate = TRUE,
  stratification_column = "code",
  p_adjust_method = "fdr",
  reduce_dimensions = TRUE
)
```

```{r}
#temp
pdf(file="figures/lipids/asca/temp_scree_plot.pdf", width=6, height=4)
plot(res_all, component = seq(1,10), effect = 1, type = 'scree')
dev.off()
# 2 PCs

#parent
pdf(file="figures/lipids/asca/parent_scree_plot.pdf", width=6, height=4)
plot(res_all, component = seq(1,10), effect = 2, type = 'scree')
dev.off()
#2 PCs

#temp:parent
pdf(file="figures/lipids/asca/interaction_scree_plot.pdf", width=6, height=4)
plot(res_all, component = seq(1,10), effect = 3, type = 'scree')
dev.off()
#2 PCs
```

Temperature PCs
```{r}
pdf(file="figures/lipids/asca/temp_PC1.pdf", width=10, height=6)
plot(res_all, effect = 1, component = 1, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("black"),
     my_theme = theme_classic()+ theme(legend.position = "none"))
dev.off()
#higher/lower at moderate temp

pdf(file="figures/lipids/asca/temp_PC2.pdf", width=10, height=6)
plot(res_all, effect = 1, component = 2, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("black"),
     my_theme = theme_classic())
dev.off()
#linear increase/decrease with temp 
```

Parent PCs
```{r}
pdf(file="figures/lipids/asca/parent_PC1.pdf", width=10, height=6)
plot(res_all, effect = 2, component = 1, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("black"),
     my_theme = theme_classic())
dev.off()
#higher/lower in bleached than WT and NB

pdf(file="figures/lipids/asca/parent_PC2.pdf", width=10, height=6)
plot(res_all, effect = 2, component = 2, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("black"),
     my_theme = theme_classic())
dev.off()
#higher/lower in wildtype
```

Parent:Temperature PCs
```{r}
pdf(file="figures/lipids/asca/interaction_PC1.pdf", width=10, height=6)
plot(res_all, effect = 3, component = 1, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     palette = c("darkgray", "darkred", "orange"),
     my_theme = theme_classic())
dev.off()
#Responsive to temp in B and NB but not WT 

pdf(file="figures/lipids/asca/interaction_PC2.pdf", width=10, height=6)
plot(res_all, effect = 3, component = 2, type = 'effect', 
     n_limit=20, 
     ribbon = TRUE,
     x_angle = 0, x_h_just= 0.5,
     flip_axis=TRUE,
     #palette = c("darkgray", "darkred", "orange"),
     my_theme = theme_classic())
dev.off()
#Responsive to temp in B and NB but not WT 
```

# Determine top contributing lipids to PCs quantitatively 

Identify top lipids for each PC using a cumulative variance explained method for each PC. 

I am going to use an % threshold cut off (lipids explaining the first X% of variance on each PC).

## Temperature: PC1 

```{r}
# 1. Extract all loadings for PC1 (effect 1 = temp)
temp_pc1_raw <- get_loadings(res_all, effect = 1, component = 1)

# ALASCA usually returns a list; first element holds the data
if (is.list(temp_pc1_raw) && !inherits(temp_pc1_raw, "data.frame")) {
  temp_pc1_df <- as.data.frame(temp_pc1_raw[[1]])
} else {
  temp_pc1_df <- as.data.frame(temp_pc1_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(temp_pc1_df)) {
  stop("Could not find 'covars' column in PC1 loadings; check the structure of pc1_df.")
}

gene_vec <- temp_pc1_df$covars

num_cols <- names(temp_pc1_df)[sapply(temp_pc1_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC1 loadings.")
}
loading_col <- num_cols[2]  # typically the PC1 loading column

temp_pc1_load <- temp_pc1_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(temp_pc1_load)
x <- (temp_pc1_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (temp_pc1_load$abs_loading - min(temp_pc1_load$abs_loading)) /
     (max(temp_pc1_load$abs_loading) - min(temp_pc1_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- temp_pc1_load$rank[elbow_idx]
elbow_gene <- temp_pc1_load$gene[elbow_idx]

# 3. 25% cumulative variance threshold as a comparison
idx_25_var <- which(temp_pc1_load$cum_var >= 0.25)[1]

temp_pc1_load <- temp_pc1_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_25_var = rank <= idx_25_var
  )

cat("PC1 important genes by elbow selection: ",
    sum(temp_pc1_load$selected_elbow), "\n")
cat("PC1 important genes by 25% variance selection: ",
    sum(temp_pc1_load$selected_25_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/lipids/asca/temp_PC1_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(temp_pc1_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
  annotate("text",
           x = idx_25_var,
           y = max(temp_pc1_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC1 loading|",
    title = "Temperature PC1 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/temp_PC1_cumulative_variance.pdf", width = 7, height = 5)
ggplot(temp_pc1_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
   annotate("text",
           x = idx_25_var,
           y = max(temp_pc1_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "Temperature PC1 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
temp_pc1_important_25 <- temp_pc1_load %>%
  filter(rank <= idx_25_var)

write.csv(temp_pc1_important_25,
          "output/lipids_metabolites/lipids/asca/temp_PC1_important_lipids.csv",
          row.names = FALSE)

```

Plot lipids colored by lipid class. 

```{r}
lollipop_temp_pc1<-temp_pc1_important_25%>%
   mutate(class = str_extract(gene, "^[A-Za-z]+"))

library(RColorBrewer)

okabe_ito_19 <- c(
  "#E69F00", # orange
  "#56B4E9", # sky blue
  "#009E73", # bluish green
  "#F0E442", # yellow
  "#0072B2", # blue
  "#D55E00", # vermillion
  "#CC79A7", # reddish purple
  "#000000", # black
  "#999999", # grey
  "#117733", # dark green
  "#882255", # wine
  "#88CCEE", # light teal
  "#44AA99", # turquoise
  "#332288", # dark navy
  "#DDCC77", # sand
  "#999933", # olive
  "#AA4499", # magenta
  "#661100", # dark brown
  "#6699CC"  # steel blue
)

lollipop_temp_pc1 <- lollipop_temp_pc1 %>%
  arrange(rank) %>%
  mutate(panel = ceiling(row_number() / (n()/2)))%>%
  mutate(pattern = if_else(panel=="1", "Elevated at 30°C", 
                           if_else(panel=="2", "Elevated at 30°C ", NA))) 

lolli_temp_pc1_plot<-lollipop_temp_pc1%>%
  
  ggplot(aes(x=loading, y=reorder(gene, -rank), color=class))+
  facet_wrap(~pattern, ncol = 2, scales = "free_y") +
  geom_point()+
  geom_segment(aes(x = 0, xend = loading, y = gene, yend = gene), linewidth = 0.8) +
  ylab("Lipid")+
  scale_color_manual(values = okabe_ito_19) +
  xlab("PC1 Loading Score")+
  ggtitle("C")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14, face="bold"), 
    #strip.text = element_blank(), 
    title=element_text(size=14, color="black", face="bold")
  );lolli_temp_pc1_plot

ggsave(lolli_temp_pc1_plot, filename="figures/lipids/asca/temp_pc1_lipid_loadings.png", width=14, height=7)
```

## Temperature: PC2 

```{r}
# 1. Extract all loadings for PC2 (effect 1 = temp)
temp_pc2_raw <- get_loadings(res_all, effect = 1, component = 2)

# ALASCA usually returns a list; first element holds the data
if (is.list(temp_pc2_raw) && !inherits(temp_pc2_raw, "data.frame")) {
  temp_pc2_df <- as.data.frame(temp_pc2_raw[[1]])
} else {
  temp_pc2_df <- as.data.frame(temp_pc2_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(temp_pc2_df)) {
  stop("Could not find 'covars' column in PC2 loadings; check the structure of pc2_df.")
}

gene_vec <- temp_pc2_df$covars

num_cols <- names(temp_pc2_df)[sapply(temp_pc2_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC2 loadings.")
}
loading_col <- num_cols[2]  # typically the PC2 loading column

temp_pc2_load <- temp_pc2_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(temp_pc2_load)
x <- (temp_pc2_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (temp_pc2_load$abs_loading - min(temp_pc2_load$abs_loading)) /
     (max(temp_pc2_load$abs_loading) - min(temp_pc2_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- temp_pc2_load$rank[elbow_idx]
elbow_gene <- temp_pc2_load$gene[elbow_idx]

# 3. 25% cumulative variance threshold as a comparison
idx_25_var <- which(temp_pc2_load$cum_var >= 0.25)[1]

temp_pc2_load <- temp_pc2_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_25_var = rank <= idx_25_var
  )

cat("PC2 important genes by elbow selection: ",
    sum(temp_pc2_load$selected_elbow), "\n")
cat("PC2 important genes by 25% variance selection: ",
    sum(temp_pc2_load$selected_25_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 25% var lines
pdf("figures/lipids/asca/temp_PC2_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(temp_pc2_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
  annotate("text",
           x = idx_25_var,
           y = max(temp_pc2_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC2 loading|",
    title = "Temperature PC2 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/temp_PC2_cumulative_variance.pdf", width = 7, height = 5)
ggplot(temp_pc2_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
   annotate("text",
           x = idx_25_var,
           y = max(temp_pc2_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "Temperature PC2 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
temp_pc2_important_25 <- temp_pc2_load %>%
  filter(rank <= idx_25_var)

write.csv(temp_pc2_important_25,
          "output/lipids_metabolites/lipids/asca/temp_PC2_important_lipids.csv",
          row.names = FALSE)

```

Plot lipids colored by lipid class. 

```{r}
lollipop_temp_pc2<-temp_pc2_important_25%>%
   mutate(class = str_extract(gene, "^[A-Za-z]+"))

lollipop_temp_pc2 <- lollipop_temp_pc2 %>%
  arrange(rank) %>%
  mutate(panel = ceiling(row_number() / (n()/2)))%>%
  mutate(pattern = if_else(loading<0, "Higher at 27°C", 
                           if_else(loading>0, "Lower at 27°C", NA)))%>%
  mutate(pattern = factor(pattern, levels=c("Lower at 27°C", "Higher at 27°C")))

lolli_temp_pc2_plot<-lollipop_temp_pc2%>%
  
  ggplot(aes(x=loading, y=reorder(gene, -rank), color=class))+
  facet_wrap(~pattern, ncol = 2, scales = "free_y") +
  geom_point()+
  geom_segment(aes(x = 0, xend = loading, y = gene, yend = gene), linewidth = 0.8) +
  ylab("Lipid")+
  scale_color_manual(values = okabe_ito_19) +
  xlab("PC2 Loading Score")+
  ggtitle("C")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14, face="bold"), 
    #strip.text = element_blank(), 
    title=element_text(size=14, color="black", face="bold")
  );lolli_temp_pc2_plot

ggsave(lolli_temp_pc2_plot, filename="figures/lipids/asca/temp_pc2_lipid_loadings.png", width=14, height=7)
```

## Parent: PC1 

```{r}
# 1. Extract all loadings for PC1 (effect 2 = parent)
parent_pc1_raw <- get_loadings(res_all, effect = 2, component = 1)

# ALASCA usually returns a list; first element holds the data
if (is.list(parent_pc1_raw) && !inherits(parent_pc1_raw, "data.frame")) {
  parent_pc1_df <- as.data.frame(parent_pc1_raw[[1]])
} else {
  parent_pc1_df <- as.data.frame(parent_pc1_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(parent_pc1_df)) {
  stop("Could not find 'covars' column in PC1 loadings; check the structure of pc1_df.")
}

gene_vec <- parent_pc1_df$covars

num_cols <- names(parent_pc1_df)[sapply(parent_pc1_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC1 loadings.")
}
loading_col <- num_cols[2]  # typically the PC1 loading column

parent_pc1_load <- parent_pc1_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(parent_pc1_load)
x <- (parent_pc1_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (parent_pc1_load$abs_loading - min(parent_pc1_load$abs_loading)) /
     (max(parent_pc1_load$abs_loading) - min(parent_pc1_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- parent_pc1_load$rank[elbow_idx]
elbow_gene <- parent_pc1_load$gene[elbow_idx]

# 3. 25% cumulative variance threshold as a comparison
idx_25_var <- which(parent_pc1_load$cum_var >= 0.25)[1]

parent_pc1_load <- parent_pc1_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_25_var = rank <= idx_25_var
  )

cat("PC1 important genes by elbow selection: ",
    sum(parent_pc1_load$selected_elbow), "\n")
cat("PC1 important genes by 25% variance selection: ",
    sum(parent_pc1_load$selected_25_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/lipids/asca/parent_PC1_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(parent_pc1_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
  annotate("text",
           x = idx_25_var,
           y = max(parent_pc1_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC1 loading|",
    title = "Parent PC1 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/parent_PC1_cumulative_variance.pdf", width = 7, height = 5)
ggplot(parent_pc1_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
   annotate("text",
           x = idx_25_var,
           y = max(parent_pc1_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "Parent PC1 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
parent_pc1_important_25 <- parent_pc1_load %>%
  filter(rank <= idx_25_var)

write.csv(parent_pc1_important_25,
          "output/lipids_metabolites/lipids/asca/parent_PC1_important_lipids.csv",
          row.names = FALSE)

```

Plot lipids colored by lipid class. 

```{r}
lollipop_parent_pc1<-parent_pc1_important_25%>%
   mutate(class = str_extract(gene, "^[A-Za-z]+"))

lollipop_parent_pc1 <- lollipop_parent_pc1 %>%
  arrange(rank) %>%
  mutate(panel = ceiling(row_number() / (n()/2)))

lolli_parent_pc1_plot<-lollipop_parent_pc1%>%
  
  ggplot(aes(x=loading, y=reorder(gene, -rank), color=class))+
  facet_wrap(~panel, ncol = 2, scales = "free_y") +
  geom_point()+
  geom_segment(aes(x = 0, xend = loading, y = gene, yend = gene), linewidth = 0.8) +
  ylab("Lipid")+
  scale_color_manual(values = okabe_ito_19) +
  xlab("PC1 Loading Score")+
  ggtitle("C")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14, face="bold"), 
    strip.text = element_blank(), 
    title=element_text(size=14, color="black", face="bold")
  );lolli_parent_pc1_plot

ggsave(lolli_parent_pc1_plot, filename="figures/lipids/asca/parent_pc1_lipid_loadings.png", width=14, height=7)
```

## Parent: PC2 

```{r}
# 1. Extract all loadings for PC2 (effect 2 = parent)
parent_pc2_raw <- get_loadings(res_all, effect = 2, component = 2)

# ALASCA usually returns a list; first element holds the data
if (is.list(parent_pc2_raw) && !inherits(parent_pc2_raw, "data.frame")) {
  parent_pc2_df <- as.data.frame(parent_pc2_raw[[1]])
} else {
  parent_pc2_df <- as.data.frame(parent_pc2_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(parent_pc2_df)) {
  stop("Could not find 'covars' column in PC2 loadings; check the structure of pc2_df.")
}

gene_vec <- parent_pc2_df$covars

num_cols <- names(parent_pc2_df)[sapply(parent_pc2_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC2 loadings.")
}
loading_col <- num_cols[2]  # typically the PC1 loading column

parent_pc2_load <- parent_pc2_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(parent_pc2_load)
x <- (parent_pc2_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (parent_pc2_load$abs_loading - min(parent_pc2_load$abs_loading)) /
     (max(parent_pc2_load$abs_loading) - min(parent_pc2_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- parent_pc2_load$rank[elbow_idx]
elbow_gene <- parent_pc2_load$gene[elbow_idx]

# 3. 25% cumulative variance threshold as a comparison
idx_25_var <- which(parent_pc2_load$cum_var >= 0.25)[1]

parent_pc2_load <- parent_pc2_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_25_var = rank <= idx_25_var
  )

cat("PC2 important genes by elbow selection: ",
    sum(parent_pc2_load$selected_elbow), "\n")
cat("PC2 important genes by 25% variance selection: ",
    sum(parent_pc2_load$selected_25_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/lipids/asca/parent_PC2_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(parent_pc2_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
  annotate("text",
           x = idx_25_var,
           y = max(parent_pc2_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC2 loading|",
    title = "Parent PC2 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/parent_PC2_cumulative_variance.pdf", width = 7, height = 5)
ggplot(parent_pc2_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
   annotate("text",
           x = idx_25_var,
           y = max(parent_pc2_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "Parent PC2 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
parent_pc2_important_25 <- parent_pc2_load %>%
  filter(rank <= idx_25_var)

write.csv(parent_pc2_important_25,
          "output/lipids_metabolites/lipids/asca/parent_PC2_important_lipids.csv",
          row.names = FALSE)

```


Plot lipids colored by lipid class. 

```{r}
lollipop_parent_pc2<-parent_pc2_important_25%>%
   mutate(class = str_extract(gene, "^[A-Za-z]+"))

lollipop_parent_pc2 <- lollipop_parent_pc2 %>%
  arrange(rank) %>%
  mutate(panel = ceiling(row_number() / (n()/2)))

lolli_parent_pc2_plot<-lollipop_parent_pc2%>%
  
  ggplot(aes(x=loading, y=reorder(gene, -rank), color=class))+
  facet_wrap(~panel, ncol = 2, scales = "free_y") +
  geom_point()+
  geom_segment(aes(x = 0, xend = loading, y = gene, yend = gene), linewidth = 0.8) +
  ylab("Lipid")+
  scale_color_manual(values = okabe_ito_19) +
  xlab("PC2 Loading Score")+
  ggtitle("C")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14, face="bold"), 
    strip.text = element_blank(), 
    title=element_text(size=14, color="black", face="bold")
  );lolli_parent_pc2_plot

ggsave(lolli_parent_pc2_plot, filename="figures/lipids/asca/parent_pc2_lipid_loadings.png", width=14, height=7)
```

## ParentxTemperature: PC1 

```{r}
# 1. Extract all loadings for PC1 (effect 3 = parent:temperature)
int_pc1_raw <- get_loadings(res_all, effect = 3, component = 1)

# ALASCA usually returns a list; first element holds the data
if (is.list(int_pc1_raw) && !inherits(int_pc1_raw, "data.frame")) {
  int_pc1_df <- as.data.frame(int_pc1_raw[[1]])
} else {
  int_pc1_df <- as.data.frame(int_pc1_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(int_pc1_df)) {
  stop("Could not find 'covars' column in PC1 loadings; check the structure of pc1_df.")
}

gene_vec <- int_pc1_df$covars

num_cols <- names(int_pc1_df)[sapply(int_pc1_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC1 loadings.")
}
loading_col <- num_cols[2]  # typically the PC1 loading column

int_pc1_load <- int_pc1_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(int_pc1_load)
x <- (int_pc1_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (int_pc1_load$abs_loading - min(int_pc1_load$abs_loading)) /
     (max(int_pc1_load$abs_loading) - min(int_pc1_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- int_pc1_load$rank[elbow_idx]
elbow_gene <- int_pc1_load$gene[elbow_idx]

# 3. 25% cumulative variance threshold as a comparison
idx_25_var <- which(int_pc1_load$cum_var >= 0.25)[1]

int_pc1_load <- int_pc1_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_25_var = rank <= idx_25_var
  )

cat("PC1 important genes by elbow selection: ",
    sum(int_pc1_load$selected_elbow), "\n")
cat("PC1 important genes by 25% variance selection: ",
    sum(int_pc1_load$selected_25_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/lipids/asca/interaction_PC1_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(int_pc1_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
  annotate("text",
           x = idx_25_var,
           y = max(int_pc1_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC1 loading|",
    title = "Interaction PC1 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/interaction_PC1_cumulative_variance.pdf", width = 7, height = 5)
ggplot(int_pc1_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
   annotate("text",
           x = idx_25_var,
           y = max(int_pc1_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "Interaction PC1 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
int_pc1_important_25 <- int_pc1_load %>%
  filter(rank <= idx_25_var)

write.csv(int_pc1_important_25,
          "output/lipids_metabolites/lipids/asca/interaction_PC1_important_lipids.csv",
          row.names = FALSE)

```










## ParentxTemperature: PC2 

```{r}
# 1. Extract all loadings for PC1 (effect 3 = parent:temperature)
int_pc2_raw <- get_loadings(res_all, effect = 3, component = 2)

# ALASCA usually returns a list; first element holds the data
if (is.list(int_pc2_raw) && !inherits(int_pc2_raw, "data.frame")) {
  int_pc2_df <- as.data.frame(int_pc2_raw[[1]])
} else {
  int_pc2_df <- as.data.frame(int_pc2_raw)
}

# Identify gene column and numeric loading column
# (You can change "covars" if your object uses a different name)
if (!"covars" %in% names(int_pc2_df)) {
  stop("Could not find 'covars' column in PC2 loadings; check the structure of pc2_df.")
}

gene_vec <- int_pc2_df$covars

num_cols <- names(int_pc2_df)[sapply(int_pc2_df, is.numeric)]

if (length(num_cols) == 0) {
  stop("No numeric loading column found in PC2 loadings.")
}
loading_col <- num_cols[2]  # typically the PC1 loading column

int_pc2_load <- int_pc2_df %>%
  transmute(
    gene    = gene_vec,
    loading = .data[[loading_col]]
  ) %>%
  mutate(
    abs_loading = abs(loading)
  ) %>%
  arrange(desc(abs_loading)) %>%
  mutate(
    rank           = row_number(),
    cum_abs        = cumsum(abs_loading),
    cum_abs_prop   = cum_abs / sum(abs_loading),
    var_contrib    = loading^2,
    cum_var        = cumsum(var_contrib) / sum(var_contrib)
  )

# 2. Find "elbow" on normalized abs(loadings) curve (Kneedle-style)
n <- nrow(int_pc2_load)
x <- (int_pc2_load$rank - 1) / (n - 1 + 1e-9)  # normalized rank
y <- (int_pc2_load$abs_loading - min(int_pc2_load$abs_loading)) /
     (max(int_pc2_load$abs_loading) - min(int_pc2_load$abs_loading) + 1e-9)

#elbow is selected at the rank of the maximum deviation between the loading curve and diagonal reference
diff_xy <- x - y
elbow_idx  <- which.max(diff_xy)
elbow_rank <- int_pc2_load$rank[elbow_idx]
elbow_gene <- int_pc2_load$gene[elbow_idx]

# 3. 25% cumulative variance threshold as a comparison
idx_25_var <- which(int_pc2_load$cum_var >= 0.25)[1]

int_pc2_load <- int_pc2_load %>%
  mutate(
    selected_elbow  = rank <= elbow_rank,
    selected_25_var = rank <= idx_25_var
  )

cat("PC2 important genes by elbow selection: ",
    sum(int_pc2_load$selected_elbow), "\n")
cat("PC2 important genes by 25% variance selection: ",
    sum(int_pc2_load$selected_25_var), "\n")

# 5. Diagnostic plots ------------------------------------------

# (a) Absolute loadings vs rank, with elbow + 80% var lines
pdf("figures/lipids/asca/interaction_PC2_abs_loadings_rank.pdf", width = 7, height = 5)
ggplot(int_pc2_load, aes(x = rank, y = abs_loading)) +
  geom_line() +
  geom_point(size = 0.7) +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
  annotate("text",
           x = idx_25_var,
           y = max(int_pc2_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank (sorted by |loading|)",
    y = "|PC2 loading|",
    title = "Interaction PC2 absolute loadings and selection thresholds"
  ) +
  theme_classic()
dev.off()

# Cumulative proportion of variance (squared loadings)
pdf("figures/lipids/asca/interaction_PC2_cumulative_variance.pdf", width = 7, height = 5)
ggplot(int_pc2_load, aes(x = rank, y = cum_var)) +
  geom_line() +
  geom_vline(xintercept = idx_25_var, linetype = "dashed") +
   annotate("text",
           x = idx_25_var,
           y = max(int_pc2_load$abs_loading) * 0.9,
           label = paste0("25% var (", idx_25_var, " lipids)"),
           hjust = -0.1, vjust = 1) +
  labs(
    x = "Rank",
    y = "Cumulative proportion of variance (loading^2)",
    title = "Interaction PC2 cumulative variance contribution"
  ) +
  theme_classic()
dev.off()

#export a list of genes contributing 80% of variance to PC1
int_pc2_important_25 <- int_pc2_load %>%
  filter(rank <= idx_25_var)

write.csv(int_pc2_important_25,
          "output/lipids_metabolites/lipids/asca/interaction_PC2_important_lipids.csv",
          row.names = FALSE)

```










## Compare lists of lipids 

```{r}
temp_pc1_list<-temp_pc1_important_25%>%pull(gene)
temp_pc2_list<-temp_pc2_important_25%>%pull(gene)
parent_pc1_list<-parent_pc1_important_25%>%pull(gene)
parent_pc2_list<-parent_pc2_important_25%>%pull(gene)
int_pc1_list<-int_pc1_important_25%>%pull(gene)
int_pc2_list<-int_pc2_important_25%>%pull(gene)
```

```{r}
# install.packages("UpSetR")   # if needed
library(UpSetR)

# Create list object for upset
gene_lists <- list(
  temp_PC1 = temp_pc1_list,
  temp_PC2 = temp_pc2_list,
  parent_PC1 = parent_pc1_list,
  parent_PC2 = parent_pc2_list,
  int_PC1 = int_pc1_list,
  int_PC2 = int_pc2_list
)

# Convert list to binary matrix for UpSetR
upset_data <- fromList(gene_lists)

colnames(upset_data)

# Plot
pdf("figures/lipids/asca/upset.pdf", width = 8, height = 6)
UpSetR::upset(upset_data,
      order.by = "freq",
      sets = c("temp_PC1", "temp_PC2", "parent_PC1", "parent_PC2", "int_PC1", "int_PC2"),
      sets.bar.color = "black",
      mainbar.y.label = "Intersection size",
      sets.x.label = "Set size"
)
dev.off()
```

There is more overlap in lipids between the temperature and interaction PCs. In general, the highest numbers of unique lipids are in the individual PCs with minimal overlap. This may be due to weak interaction effects. 

# Plot a heatmap of the most important lipids from each PC

Use log1p transformed area normalized lipid values. 
```{r}
#make data frames for each PC
temp_pc1_important_25<-temp_pc1_important_25%>%mutate(PC="Temp 1")
temp_pc2_important_25<-temp_pc2_important_25%>%mutate(PC="Temp 2")
parent_pc1_important_25<-parent_pc1_important_25%>%mutate(PC="Parent 1")
parent_pc2_important_25<-parent_pc2_important_25%>%mutate(PC="Parent 2")
int_pc1_important_25<-int_pc1_important_25%>%mutate(PC="Interaction 1")
int_pc2_important_25<-int_pc2_important_25%>%mutate(PC="Interaction 2")

importance<-rbind(temp_pc1_important_25, temp_pc2_important_25, parent_pc1_important_25, parent_pc2_important_25, int_pc1_important_25, int_pc2_important_25)

importance<-importance%>%select(gene, abs_loading, var_contrib, PC)%>%rename(gene="variable")
head(importance)

#add in concentration data 
pc_conc<-long_data%>%
  filter(variable %in% importance$variable)%>%
  left_join(., importance)

test1<-levels(factor(importance$variable))
test2<-levels(factor(pc_conc$variable))
setdiff(test1, test2)
setdiff(test2, test1)
```

## Temperature PC1 
```{r}
# Start from your original object
temp_pc1_conc <- pc_conc %>%
  filter(PC=="Temp 1")%>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- temp_pc1_conc %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- temp_pc1_conc %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- temp_pc1_conc %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

# Explicit named colors for temperature
temp_cols <- c(
  "Ambient"       = "#2c7bb6",
  "Moderate (+3)" = "#7b3294",
  "High (+6)"     = "#d53e4f"
)

# Explicit named colors for parent
# Include a few possible variations for the 3rd level so it still works
parent_cols <- c(
  "Wildtype"    = "darkgray",
  "Bleached"    = "orange",
  "Nonbleached" = "darkred"
)

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/temp_PC1_heatmap.pdf", width = 9, height = 10)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$temperature,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "Temperature PC1 Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```











## Temperature PC2 
```{r}
# Start from your original object
temp_pc2_conc <- pc_conc %>%
  filter(PC=="Temp 2")%>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- temp_pc2_conc %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- temp_pc2_conc %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- temp_pc2_conc %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

# Explicit named colors for temperature
temp_cols <- c(
  "Ambient"       = "#2c7bb6",
  "Moderate (+3)" = "#7b3294",
  "High (+6)"     = "#d53e4f"
)

# Explicit named colors for parent
# Include a few possible variations for the 3rd level so it still works
parent_cols <- c(
  "Wildtype"    = "darkgray",
  "Bleached"    = "orange",
  "Nonbleached" = "darkred"
)

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/temp_PC2_heatmap.pdf", width = 8, height = 7)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$temperature,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "Temperature PC2 Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```











## Parent PC1 
```{r}
# Start from your original object
parent_pc1_conc <- pc_conc %>%
  filter(PC=="Parent 1")%>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- parent_pc1_conc %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- parent_pc1_conc %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- parent_pc1_conc %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

# Explicit named colors for temperature
temp_cols <- c(
  "Ambient"       = "#2c7bb6",
  "Moderate (+3)" = "#7b3294",
  "High (+6)"     = "#d53e4f"
)

# Explicit named colors for parent
# Include a few possible variations for the 3rd level so it still works
parent_cols <- c(
  "Wildtype"    = "darkgray",
  "Bleached"    = "orange",
  "Nonbleached" = "darkred"
)

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/parent_PC1_heatmap.pdf", width = 9, height = 9)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$parent,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "Parent PC1 Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```











## Parent PC2 
```{r}
# Start from your original object
parent_pc2_conc <- pc_conc %>%
  filter(PC=="Parent 2")%>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- parent_pc2_conc %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- parent_pc2_conc %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- parent_pc2_conc %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

# Explicit named colors for temperature
temp_cols <- c(
  "Ambient"       = "#2c7bb6",
  "Moderate (+3)" = "#7b3294",
  "High (+6)"     = "#d53e4f"
)

# Explicit named colors for parent
# Include a few possible variations for the 3rd level so it still works
parent_cols <- c(
  "Wildtype"    = "darkgray",
  "Bleached"    = "orange",
  "Nonbleached" = "darkred"
)

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/parent_PC2_heatmap.pdf", width = 9, height = 9)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$parent,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "Parent PC2 Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```











## Interaction PC1 
```{r}
# Start from your original object
int_pc1_conc <- pc_conc %>%
  filter(PC=="Interaction 1")%>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- int_pc1_conc %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- int_pc1_conc %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- int_pc1_conc %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

# Explicit named colors for temperature
temp_cols <- c(
  "Ambient"       = "#2c7bb6",
  "Moderate (+3)" = "#7b3294",
  "High (+6)"     = "#d53e4f"
)

# Explicit named colors for parent
# Include a few possible variations for the 3rd level so it still works
parent_cols <- c(
  "Wildtype"    = "darkgray",
  "Bleached"    = "orange",
  "Nonbleached" = "darkred"
)

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/interaction_PC1_heatmap.pdf", width = 9, height = 9)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$temperature,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "Interaction PC1 Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```











## Interaction PC2 
```{r}
# Start from your original object
int_pc2_conc <- pc_conc %>%
  filter(PC=="Interaction 2")%>%
  mutate(
    sample   = as.character(sample),
    variable = as.character(variable),
    temperature = droplevels(temperature),
    parent      = droplevels(parent)
  )

mat_df <- int_pc2_conc %>%
  select(variable, sample, value) %>%
  distinct() %>%
  pivot_wider(
    names_from  = sample,
    values_from = value,
    values_fill = list(value = NA_real_)
  ) %>%
  as.data.frame()   # <-- convert tibble → data.frame

rownames(mat_df) <- mat_df$variable
mat_df$variable  <- NULL

mat <- as.matrix(mat_df)

head(rownames(mat))  # should now show your lipid names
dim(mat)

# 3. Column annotation (temperature + parent) -----------------
col_annot <- int_pc2_conc %>%
  distinct(sample, temperature, parent)

# Define desired sample order: by temperature, then parent, then sample ID
sample_order <- col_annot %>%
  arrange(temperature, parent, sample) %>%
  pull(sample) %>%
  unique()

# Make sure only samples that exist in the matrix are kept
sample_order <- sample_order[sample_order %in% colnames(mat)]
cat("Ordered samples:", length(sample_order), "\n")

if (length(sample_order) == 0) {
  stop("No overlap between samples in matrix and annotation – check sample IDs.")
}

# Apply manual column order
mat       <- mat[, sample_order, drop = FALSE]
col_annot <- col_annot %>%
  filter(sample %in% sample_order) %>%
  mutate(sample = factor(sample, levels = sample_order)) %>%
  arrange(sample)

# 4. Order rows by loading (highest at top) -------------------
row_order <- int_pc2_conc %>%
  group_by(variable) %>%
  summarize(abs_loading = first(abs_loading), .groups = "drop") %>%
  arrange(desc(abs_loading)) %>%
  pull(variable)

row_order <- intersect(row_order, rownames(mat))
cat("Variables in row_order:", length(row_order), "\n")

if (length(row_order) == 0) {
  stop("No overlap between variables in loading table and matrix rownames.")
}

# Apply manual row order (y-axis)
mat <- mat[row_order, , drop = FALSE]

# 5. Annotation colors ----------------------------------------

# Explicit named colors for temperature
temp_cols <- c(
  "Ambient"       = "#2c7bb6",
  "Moderate (+3)" = "#7b3294",
  "High (+6)"     = "#d53e4f"
)

# Explicit named colors for parent
# Include a few possible variations for the 3rd level so it still works
parent_cols <- c(
  "Wildtype"    = "darkgray",
  "Bleached"    = "orange",
  "Nonbleached" = "darkred"
)

ha <- HeatmapAnnotation(
  Temperature = col_annot$temperature,
  Parent      = col_annot$parent,
  col = list(
    Temperature = temp_cols,
    Parent      = parent_cols
  )
)

# 6. Z-score by row (if not already done) ---------------------
# center & scale each row: (x - mean) / sd
row_means <- rowMeans(mat, na.rm = TRUE)
row_sds   <- apply(mat, 1, sd, na.rm = TRUE)

row_sds[row_sds == 0 | is.na(row_sds)] <- 1

mat_z <- sweep(mat, 1, row_means, FUN = "-")
mat_z <- sweep(mat_z, 1, row_sds,   FUN = "/")

# 7. Color scale for z-scores ---------------------------------
z_lim <- max(2, quantile(abs(mat_z[is.finite(mat_z)]), 0.95, na.rm = TRUE))

col_fun <- colorRamp2(
  c(-z_lim, 0, z_lim),
  c("navy", "white", "firebrick")
)

# 8. Complex heatmap (z-score, manual order, sample IDs shown) -
pdf("figures/lipids/asca/interaction_PC2_heatmap.pdf", width = 9, height = 9)
Heatmap(
  mat_z,
  name = "Z-score",
  col  = col_fun,
  cluster_columns = FALSE,      # manual order, no dendrogram
  cluster_rows    = FALSE,
  column_split    = col_annot$temperature,   # <-- splits by temperature
  gap             = unit(3, "mm"),           # <-- spacing between temperature groups
  column_title    = "Interaction PC2 Effects",
  row_title       = "Variables (ordered by loading)",
  top_annotation  = ha,
  show_row_names    = TRUE,
  show_column_names = TRUE,
  row_names_gp       = gpar(fontsize = 6),
  column_names_gp    = gpar(fontsize = 6),
  column_names_rot   = 90
)
dev.off()
```











# Plot top 12 contributing lipids on each component 

Temperature PC1 
```{r}
temp_cols <- c(
  "Ambient"       = "#2c7bb6",
  "Moderate (+3)" = "#7b3294",
  "High (+6)"     = "#d53e4f"
)

top10_temp_pc1<-pc_conc%>%
  filter(PC=="Temp 1")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=12)%>%
  pull(variable)

pc_plot1<-pc_conc%>%
  filter(variable %in% top10_temp_pc1)%>%
  
  ggplot(aes(x=temperature, y=value, colour=temperature))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Temperature", values=temp_cols)+
  ggtitle("Temperature PC1 Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot1
  
ggsave(pc_plot1, filename="figures/lipids/asca/Temp_PC1_top10_lipids.png", height=6, width=12)
```

Temperature PC2
```{r}
top10_temp_pc2<-pc_conc%>%
  filter(PC=="Temp 2")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=12)%>%
  pull(variable)

pc_plot2<-pc_conc%>%
  filter(variable %in% top10_temp_pc2)%>%
  
  ggplot(aes(x=temperature, y=value, colour=temperature))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Temperature", values=temp_cols)+
  ggtitle("Temperature PC2 Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot2
  
ggsave(pc_plot2, filename="figures/lipids/asca/Temp_PC2_top10_lipids.png", height=6, width=12)
```

Parent PC1
```{r}
parent_cols <- c(
  "Wildtype"    = "darkgray",
  "Bleached"    = "orange",
  "Nonbleached" = "darkred"
)

parent_labels <-c(
  "Wildtype" = "Wildtype (C/D)", 
  "Bleached" = "Sensitive (C)", 
  "Nonbleached" = "Resistant (C/D)"
)

top10_parent_pc1<-pc_conc%>%
  filter(PC=="Parent 1")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=12)%>%
  pull(variable)

pc_plot3<-pc_conc%>%
  filter(variable %in% top10_parent_pc1)%>%
  
  ggplot(aes(x=temperature, y=value, colour=parent))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Phenotype", values=parent_cols, labels=parent_labels)+
  ggtitle("Parent PC1 Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot3
  
ggsave(pc_plot3, filename="figures/lipids/asca/Parent_PC1_top10_lipids.png", height=6, width=12)
```

Parent PC2
```{r}
top10_parent_pc2<-pc_conc%>%
  filter(PC=="Parent 2")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=12)%>%
  pull(variable)

pc_plot4<-pc_conc%>%
  filter(variable %in% top10_parent_pc2)%>%
  
  ggplot(aes(x=temperature, y=value, colour=parent))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Phenotype", values=parent_cols, labels=parent_labels)+
  ggtitle("Parent PC2 Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot4
  
ggsave(pc_plot4, filename="figures/lipids/asca/Parent_PC2_top10_lipids.png", height=6, width=12)
```

Interaction PC1
```{r}
top10_int_pc1<-pc_conc%>%
  filter(PC=="Interaction 1")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=12)%>%
  pull(variable)

pc_plot5<-pc_conc%>%
  filter(variable %in% top10_int_pc1)%>%
  
  ggplot(aes(x=temperature, y=value, colour=parent))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Phenotype", values=parent_cols, labels=parent_labels)+
  ggtitle("Interaction PC1 Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot5
  
ggsave(pc_plot5, filename="figures/lipids/asca/Interaction_PC1_top10_lipids.png", height=6, width=12)
```

Interaction PC2
```{r}
top10_int_pc2<-pc_conc%>%
  filter(PC=="Interaction 2")%>%
  arrange(desc(abs_loading))%>%
  select(variable, abs_loading)%>%
  unique()%>%
  slice_head(n=12)%>%
  pull(variable)

pc_plot6<-pc_conc%>%
  filter(variable %in% top10_int_pc2)%>%
  
  ggplot(aes(x=temperature, y=value, colour=parent))+
  facet_wrap(~variable, scales="free_y")+
  geom_boxplot(outliers=FALSE)+
  geom_point(position=position_dodge(0.8))+
  scale_colour_manual(name="Phenotype", values=parent_cols, labels=parent_labels)+
  ggtitle("Interaction PC2 Effects")+
  xlab("Temperature")+
  ylab("Concentration")+
  theme_classic()+
  theme(axis.text.x = element_text(angle=45, hjust=1));pc_plot6
  
ggsave(pc_plot6, filename="figures/lipids/asca/Interaction_PC2_top10_lipids.png", height=6, width=12)
```

# Output lists of lipids for LION 

```{r}
head(importance)

#all lipids
long_data%>%
  select(variable)%>%
  unique()%>%
  write_csv(., file="output/lipids_metabolites/lipids/asca/lion_lists/all_lipids_list.csv")

#temp PC1
importance%>%
  filter(PC=="Temp 1")%>%
  select(variable)%>%
  write_csv(., file="output/lipids_metabolites/lipids/asca/lion_lists/temp_pc1_list.csv")

#temp PC2
importance%>%
  filter(PC=="Temp 2")%>%
  select(variable)%>%
  write_csv(., file="output/lipids_metabolites/lipids/asca/lion_lists/temp_pc2_list.csv")

#parent PC1
importance%>%
  filter(PC=="Parent 1")%>%
  select(variable)%>%
  write_csv(., file="output/lipids_metabolites/lipids/asca/lion_lists/parent_pc1_list.csv")

#parent PC2
importance%>%
  filter(PC=="Parent 2")%>%
  select(variable)%>%
  write_csv(., file="output/lipids_metabolites/lipids/asca/lion_lists/parent_pc2_list.csv")

#interaction PC1
importance%>%
  filter(PC=="Interaction 1")%>%
  select(variable)%>%
  write_csv(., file="output/lipids_metabolites/lipids/asca/lion_lists/interaction_pc1_list.csv")

#interaction PC2
importance%>%
  filter(PC=="Interaction 2")%>%
  select(variable)%>%
  write_csv(., file="output/lipids_metabolites/lipids/asca/lion_lists/interaction_pc2_list.csv")
```

Results from LION: 

Temperature PC1
```{r}
temp_pc1_lion<-read_csv("output/lipids_metabolites/lipids/asca/lion_results/LION_temp_pc1.csv")
temp_pc1_lion
#no significant enrichment according to FDR q values 
#C16:0, fatty acids with 16 carbons, sphingolipids, plasma membrane, fatty acid with 16-18 cabons, and fatty acid with <18 carbons are significant at p<0.05

lolli_temp_pc1<-temp_pc1_lion%>%
  mutate(logp=-log10(`p-value`))%>%
  arrange(desc(logp))%>%
  filter(logp>1)%>%
  
  ggplot(aes(x=logp, y=reorder(Discription, logp)))+
  geom_point(size=3)+
  geom_segment(aes(x = 0, xend = logp, y = Discription, yend = Discription), linewidth = 0.8) +
  ylab("LION Term")+
  #xlim(2, 2.8)+
  xlab("-Log(p-value)")+
  ylab("LION Term")+
  ggtitle("B")+
  geom_vline(xintercept=1.3, linetype="dashed")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14), 
    title=element_text(color="black", size=14, face="bold")
  );lolli_temp_pc1

ggsave(lolli_temp_pc1, filename="figures/lipids/asca/lion/temp_pc1_terms.png", width=9, height=5)
```

Temperature PC2
```{r}
temp_pc2_lion<-read_csv("output/lipids_metabolites/lipids/asca/lion_results/LION_temp_pc2.csv")
temp_pc2_lion
#no significant enrichment according to FDR q values 
#fatty acid with 3-5 double bonds are significant at p<0.05 

lolli_temp_pc2<-temp_pc2_lion%>%
  mutate(logp=-log10(`p-value`))%>%
  arrange(desc(logp))%>%
  filter(logp>1)%>%
  
  ggplot(aes(x=logp, y=reorder(Discription, logp)))+
  geom_point(size=3)+
  geom_segment(aes(x = 0, xend = logp, y = Discription, yend = Discription), linewidth = 0.8) +
  ylab("LION Term")+
  xlab("-Log(p-value)")+
  ylab("LION Term")+
  ggtitle("B")+
  geom_vline(xintercept=1.3, linetype="dashed")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14), 
    title=element_text(color="black", size=14, face="bold")
  );lolli_temp_pc2

ggsave(lolli_temp_pc2, filename="figures/lipids/asca/lion/temp_pc2_terms.png", width=7, height=5)
```

Parent PC1
```{r}
parent_pc1_lion<-read_csv("output/lipids_metabolites/lipids/asca/lion_results/LION_parent_pc1.csv")
parent_pc1_lion
#no significant enrichment according to FDR q values 
#fatty acid with <18 carbons, neutral intrinsic curvature, and 1-alkyl 2-acylglycerophosphocholines are significant at p<0.05

lolli_parent_pc1<-parent_pc1_lion%>%
  mutate(logp=-log10(`p-value`))%>%
  arrange(desc(logp))%>%
  filter(logp>1)%>%
  
  ggplot(aes(x=logp, y=reorder(Discription, logp)))+
  geom_point(size=3)+
  geom_segment(aes(x = 0, xend = logp, y = Discription, yend = Discription), linewidth = 0.8) +
  ylab("LION Term")+
  #xlim(2, 2.8)+
  xlab("-Log(p-value)")+
  ylab("LION Term")+
  ggtitle("B")+
  geom_vline(xintercept=1.3, linetype="dashed")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14), 
    title=element_text(color="black", size=14, face="bold")
  );lolli_parent_pc1

ggsave(lolli_parent_pc1, filename="figures/lipids/asca/lion/parent_pc1_terms.png", width=7, height=5)
```

Parent PC2
```{r}
parent_pc2_lion<-read_csv("output/lipids_metabolites/lipids/asca/lion_results/LION_parent_pc2.csv")
parent_pc2_lion
#no significant enrichment according to FDR q values 
#fatty acid with 26 carbons enriched at p<0.05

lolli_parent_pc2<-parent_pc2_lion%>%
  mutate(logp=-log10(`p-value`))%>%
  arrange(desc(logp))%>%
  filter(logp>1)%>%
  
  ggplot(aes(x=logp, y=reorder(Discription, logp)))+
  geom_point(size=3)+
  geom_segment(aes(x = 0, xend = logp, y = Discription, yend = Discription), linewidth = 0.8) +
  ylab("LION Term")+
  #xlim(2, 2.8)+
  xlab("-Log(p-value)")+
  ylab("LION Term")+
  ggtitle("C")+
  geom_vline(xintercept=1.3, linetype="dashed")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14)
  );lolli_parent_pc2

ggsave(lolli_parent_pc1, filename="figures/lipids/asca/lion/parent_pc2_terms.png", width=9, height=5)
```

Interaction PC1
```{r}
int_pc1_lion<-read_csv("output/lipids_metabolites/lipids/asca/lion_results/LION_interaction_pc1.csv")
int_pc1_lion
#no significant enrichment according to FDR q values 
#membrane component, ceramide phosphocholines (sphingomeylins), endosome/lysosome, high transition temperature, headgroup with positive charge, diacylglycerophosphocholines, low bilayer thickness, high bilayer thickness, above average bilayer thickness, and low lateral diffusion are significant at p<0.05

lolli_int_pc1<-int_pc1_lion%>%
  mutate(logp=-log10(`p-value`))%>%
  arrange(desc(logp))%>%
  filter(logp>1)%>%
  
  ggplot(aes(x=logp, y=reorder(Discription, logp)))+
  geom_point(size=3)+
  geom_segment(aes(x = 0, xend = logp, y = Discription, yend = Discription), linewidth = 0.8) +
  ylab("LION Term")+
  #xlim(2, 2.8)+
  xlab("-Log(p-value)")+
  ylab("LION Term")+
  ggtitle("C")+
  geom_vline(xintercept=1.3, linetype="dashed")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14)
  );lolli_int_pc1

ggsave(lolli_int_pc1, filename="figures/lipids/asca/lion/interaction_pc1_terms.png", width=9, height=5)
```

Interaction PC2
```{r}
int_pc2_lion<-read_csv("output/lipids_metabolites/lipids/asca/lion_results/LION_interaction_pc2.csv")
int_pc2_lion
#no significant enrichment according to FDR q values 
#alkyldiacylglycerols and headgroup with neural charge are significant at p<0.05

lolli_int_pc2<-int_pc2_lion%>%
  mutate(logp=-log10(`p-value`))%>%
  arrange(desc(logp))%>%
  filter(logp>1)%>%
  
  ggplot(aes(x=logp, y=reorder(Discription, logp)))+
  geom_point(size=3)+
  geom_segment(aes(x = 0, xend = logp, y = Discription, yend = Discription), linewidth = 0.8) +
  ylab("LION Term")+
  #xlim(2, 2.8)+
  xlab("-Log(p-value)")+
  ylab("LION Term")+
  ggtitle("C")+
  geom_vline(xintercept=1.3, linetype="dashed")+
  theme_classic()+
  theme(
    legend.title=element_blank(), 
    axis.text=element_text(color="black", size=12), 
    axis.title=element_text(color="black", size=14)
  );lolli_int_pc2

ggsave(lolli_int_pc2, filename="figures/lipids/asca/lion/interaction_pc2_terms.png", width=9, height=5)
```





