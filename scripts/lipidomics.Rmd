---
title: "Lipidomics analysis"
author: "Ariana S Huffmyer"
date: "2024"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---
# Set Up    

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(purrr)
library(lubridate)
library(ggplot2)
library(broom)
library(cowplot)
library(mixOmics)
library(dplyr)
library(conflicted)
library(vegan)
library(factoextra)
library(ggfortify)
library(RVAideMemoire)
library(ComplexHeatmap)
library(circlize)
library(tibble)
library(viridis)
library(genefilter)

conflict_prefer("select", winner = "dplyr", quiet = FALSE)
conflict_prefer("filter", winner = "dplyr", quiet = FALSE)
conflict_prefer("rename", winner = "dplyr", quiet = FALSE)
```

# Data manipulation and preparations  

## Read in all files 

```{r}
metadata<-read_csv("data/lipids_metabolites/lipidomics/lipid_metadata_huffmyer_matthews.csv")%>%
  rename(sample=`Vial ID`, tube=`Sample ID`, temperature=Temperature, parent=Parent, type=Type, code=Code)

neg_values<-read_csv("data/lipids_metabolites/lipidomics/processed-data/negative/PeakValues_2_2024_09_06_14_56_30.csv")

neg_peaks<-read_csv("data/lipids_metabolites/lipidomics/processed-data/negative/PeakMaster_2_2024_09_06_14_56_30.csv")

pos_values<-read_csv("data/lipids_metabolites/lipidomics/processed-data/positive/PeakValues_3_2024_09_06_15_02_41.csv")

pos_peaks<-read_csv("data/lipids_metabolites/lipidomics/processed-data/positive/PeakMaster_3_2024_09_06_15_02_41.csv")

protein<-read_csv("data/lipids_metabolites/protein/protein_calculated.csv")
```

There was an issue in the negative polarity where the compound 3,4'-Dimethoxy-5,7,3'-trihydroxyflavone was reading in incorrectly because of the commas. I manually revised the name to be 3;4'-Dimethoxy-5;7;3'-trihydroxyflavone instead. 

Add protein data to the metadata. 

```{r}
metadata$protein.ug<-protein$`Total Protein ug`[match(metadata$tube, protein$Sample)]
```

## Negative polarity 

How many peaks do we have?  

```{r}
length(neg_peaks$`Metabolite name`)
```

Reformat data set to be useful.  

```{r}
neg_peaks<-neg_peaks%>% 
  rename(peak=`Alignment ID`, lipid=`Metabolite name`, formula=Formula, ontology=Ontology)%>%
  select(peak, lipid, formula, ontology)%>%
  mutate(polarity=c("negative"))

neg_values<-neg_values%>%
  rename(peak=ID, file=File, group=Class, area=NormalizedArea)%>%
  select(peak, file, group, area)%>%
  mutate(polarity=c("negative"))
```

The data frames now contain `peak` for a unique ID for each lipid detected. This number links the two files. Area represents the normalized area after internal standard normalization. We will further normalize this value below.  

Format the file names to correspond to sample IDs in the metadata sheet. 

```{r}
#first remove the test PBQCs ran at 5 and 10 uL loadings and keep the standard 20 uL loading 
neg_values<-neg_values%>%
  filter(!file=="20240423_Mcap_neg_PBQC1_5")%>%
  filter(!file=="20240423_Mcap_neg_PBQC1_10")%>%
  mutate(file = str_replace(file, "20240423_Mcap_neg_PBQC1_20", "20240423_Mcap_neg_PBQC1"))%>%
  mutate(sample = str_extract(file, "[^_]+$"))
```

Merge together all data from the metadata, values, and peak information to one data frame. 

```{r}
negative<-left_join(metadata, neg_values)

negative<-negative%>%
  select(sample, temperature, parent, type, peak, area, polarity, protein.ug)

negative<-left_join(negative, neg_peaks)
```

Next, add together the values for all peaks identified as the same metabolite for each sample.   

How many lipids have multiple peaks detected separately? 
```{r}
length(unique(neg_peaks$lipid))
```

There are 301 unique lipids and 370 peaks. 

Show an example of entries that have the same metabolite with multiple peak IDs. 
```{r}
filtered_values <- negative %>%
  group_by(lipid) %>%
  filter(n_distinct(peak) > 1) %>%
  ungroup()%>%
  arrange(lipid, sample, peak)

print(filtered_values)
```

Add together the values for each sample for each identified lipid. 
```{r}
negative<-negative%>%
  group_by(sample, lipid, temperature, parent, type, polarity, formula, ontology, protein.ug)%>%
  summarise(area=sum(area, na.rm=TRUE))
```

Note that area is currently in units of nmol/uL plasma after normalization to internal standard. Following protein normalization, the units will be nmol/uL plasma / ug protein. 

We now have a dataframe with one line per lipid per sample with metadata and annotation information.  

Next, calculate the mean value of each lipid in the blank samples and subtract this value from all larval samples to perform blank correction. Areas should be low or close to 0 for blank samples.  

```{r}
neg_blanks<-negative%>%
  filter(type=="Blank")%>%
  group_by(lipid)%>%
  summarise(mean_blank=mean(area, na.rm=TRUE))

#add this value back into the master data frame for corrections. 

negative<-negative%>%
  filter(!type=="Blank")%>%
  left_join(.,neg_blanks)
```

Remove PBQC's. These were used for peak identification in MSDIAL and are not used downstream at this point. 
```{r}
negative<-negative%>%
  filter(!type=="PBQC")
```

Subtract blank value from each sample's peak value for each lipid and if the value is negative, replace with 0. 
```{r}
negative<-negative%>%
  mutate(area_corrected=area-mean_blank)%>%
  mutate(area_corrected = if_else(area_corrected < 0, 0, area_corrected))
  
```

How many entries had non zero values before and now have zeros after blank correction (i.e., number of observations that were not higher than average blank).  

```{r}
test<-negative%>%
  filter(area>0)
length(test$area)

#16021 before 

test<-negative%>%
  filter(area_corrected>0)
length(test$area_corrected)

#14551 after
```

We now have performed blank correction. 

Finally, normalize corrected area to sample protein. This will generate units of nmol lipid / uL plasma / ug protein. 

```{r}
negative<-negative%>%
  mutate(area_normalized=area_corrected/protein.ug)
```

Repeat for positive polarity.  

## Positive polarity 

How many peaks do we have?  

```{r}
length(pos_peaks$`Metabolite name`)
```

Reformat data set to be useful.  

```{r}
pos_peaks<-pos_peaks%>% 
  rename(peak=`Alignment ID`, lipid=`Metabolite name`, formula=Formula, ontology=Ontology)%>%
  select(peak, lipid, formula, ontology)%>%
  mutate(polarity=c("positive"))

pos_values<-pos_values%>%
  rename(peak=ID, file=File, group=Class, area=NormalizedArea)%>%
  select(peak, file, group, area)%>%
  mutate(polarity=c("positive"))
```

The data frames now contain `peak` for a unique ID for each lipid detected. This number links the two files. Area represents the normalized area after internal standard normalization. We will further normalize this value below.  

Format the file names to correspond to sample IDs in the metadata sheet. 

```{r}
pos_values<-pos_values%>%
  mutate(sample = str_extract(file, "[^_]+$"))
```

Merge together all data from the metadata, values, and peak information to one data frame. 

```{r}
positive<-left_join(metadata, pos_values)

positive<-positive%>%
  select(sample, temperature, parent, type, peak, area, polarity, protein.ug)

positive<-left_join(positive, pos_peaks)
```

Next, add together the values for all peaks identified as the same metabolite for each sample.   

How many lipids have multiple peaks detected separately? 
```{r}
length(unique(pos_peaks$lipid))
```

There are 1308 unique lipids and 1471 total peaks. 

Show an example of entries that have the same metabolite with multiple peak IDs. 
```{r}
filtered_values <- positive %>%
  group_by(lipid) %>%
  filter(n_distinct(peak) > 1) %>%
  ungroup()%>%
  arrange(lipid, sample, peak)

print(filtered_values)
```

Add together the values for each sample for each identified lipid. 
```{r}
positive<-positive%>%
  group_by(sample, lipid, temperature, parent, type, polarity, formula, ontology, protein.ug)%>%
  summarise(area=sum(area, na.rm=TRUE))
```

Note that area is currently in units of nmol/uL plasma after normalization to internal standard. Following protein normalization, the units will be nmol/uL plasma / ug protein. 

We now have a dataframe with one line per lipid per sample with metadata and annotation information.  

Next, calculate the mean value of each lipid in the blank samples and subtract this value from all larval samples to perform blank correction. Areas should be low or close to 0 for blank samples.  

```{r}
pos_blanks<-positive%>%
  filter(type=="Blank")%>%
  group_by(lipid)%>%
  summarise(mean_blank=mean(area, na.rm=TRUE))

#add this value back into the master data frame for corrections. 

positive<-positive%>%
  filter(!type=="Blank")%>%
  left_join(.,pos_blanks)
```

Remove PBQC's. These were used for peak identification in MSDIAL and are not used downstream at this point. 
```{r}
positive<-positive%>%
  filter(!type=="PBQC")
```

Subtract blank value from each sample's peak value for each lipid and if the value is negative, replace with 0. 
```{r}
positive<-positive%>%
  mutate(area_corrected=area-mean_blank)%>%
  mutate(area_corrected = if_else(area_corrected < 0, 0, area_corrected))
  
```

How many entries had non zero values before and now have zeros after blank correction (i.e., number of observations that were not higher than average blank).  

```{r}
test<-positive%>%
  filter(area>0)
length(test$area)

#70402 before 

test<-positive%>%
  filter(area_corrected>0)
length(test$area_corrected)

#62752 after
```

We now have performed blank correction. 

Finally, normalize corrected area to sample protein. This will generate units of nmol lipid / uL plasma / ug protein. 

```{r}
positive<-positive%>%
  mutate(area_normalized=area_corrected/protein.ug)
```

## Join polarities together 

Join positive and negative datasets.  

```{r}
length(negative$lipid)
length(positive$lipid)

lipids<-rbind(negative, positive)

length(lipids$lipid)
```

Add together peaks for those detected in both polarities. How many lipids are detected at both polarities? 

```{r}
filtered_values <- lipids %>%
  group_by(lipid) %>%
  filter(n_distinct(polarity) > 1) %>%
  ungroup()%>%
  arrange(lipid, sample, polarity)

print(filtered_values)

length(unique(filtered_values$lipid))
```

There are 50 lipids detected at both polarities. Perform a summarise function to add together values from both polarities for each lipid. 

```{r}
lipids<-lipids%>%
  select(sample, lipid, temperature, parent, type, polarity, formula, ontology, area_normalized)%>%
  group_by(sample, lipid, temperature, parent, type, formula, ontology)%>%
  summarize(area_normalized=sum(area_normalized, na.rm=TRUE))
```

Remove standard lipids - those with (d7) or (d9) in the lipid name.  

```{r}
lipid_d7 <- lipids %>%
  filter(str_detect(lipid, "\\(d7\\)"))%>%
  pull(lipid)%>%
  unique()

lipid_d9 <- lipids %>%
  filter(str_detect(lipid, "\\(d9\\)"))%>%
  pull(lipid)%>%
  unique()

lipids<-lipids%>%
  filter(!lipid %in% lipid_d7)%>%
  filter(!lipid %in% lipid_d9)
```

```{r}
length(unique(lipids$lipid))
```

We have 1548 lipids in our dataset.  

```{r}
test<-lipids%>%
  filter(area_normalized<0.05)

hist(test$area_normalized)
```

Finally, perform filtering to remove low presence lipids. Our treatment groups are a minimum of n=6 samples per group. Set a threshold that a lipid must be present at area_normalized>0.01 (non-zero values) in n=6 samples to be included. 
```{r}
lipids <- lipids %>%
  group_by(lipid) %>%
  filter(sum(area_normalized > 0.01) >= 6) %>%
  ungroup()

length(unique(lipids$lipid))
```
This reduced our data set to 1456.  

We are now ready to conduct analysis! 

Export the processed dataset. 

```{r}
write_csv(lipids, file="output/lipids_metabolites/lipids/processed_lipids.csv")
```

Remove the RIKEN annotated lipids for now, they are unannotated and do not have any ontology information that is relevant.  

```{r}
lipids<-lipids%>%
  filter(!str_detect(lipid, "RIKEN"))

length(unique(lipids$lipid))
```

There are 1237 annotated lipids outside of the RIKEN mouse lipids. 

# Unsupervised analysis 

Conduct a PCA and PERMANOVA to examine the effects of parent and temperature on the lipidome of coral larvae. 

Convert to wide format. 

```{r}
wide_data<-lipids%>%
  ungroup()%>%
  select(!formula)%>%
  select(!ontology)%>%
  select(!type)%>%
  pivot_wider(names_from=lipid, values_from=area_normalized)
```

```{r}
wide_data%>%
    select_if(~ any(is.na(.)))
```

No columns have NA's.  

```{r}
str(wide_data)

wide_data$temperature<-factor(wide_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

wide_data$parent<-factor(wide_data$parent, levels=c("Wildtype", "Bleached", "Nonbleached"))
```

All characteristics are renamed.  

Remove any column that have only 0 values. 

```{r}
wide_data <- wide_data[, colSums(wide_data != 0) > 0]
```
This retained 1237 lipids due to previous filtering steps. 

View scree plot. 

```{r}
scaled.pca<-prcomp(wide_data[c(4:1240)], scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)
```

Component 1 explains about 50% of variance with approx. 10% explained by component 2. Approx. 5% or less explained by following PCs.  

Prepare a PCA plot
```{r}
# scale data
vegan <- scale(wide_data[c(4:1240)])

# PerMANOVA 
permanova<-adonis2(vegan ~ parent*temperature, data = wide_data, method='eu')
permanova
```

No significant effect of parent or treatment. 

adonis2(formula = vegan ~ parent * temperature, data = wide_data, method = "eu")
                   Df SumOfSqs      R2      F Pr(>F)  
parent              2     4286 0.06378 1.7388  0.085 .
temperature         2     3518 0.05234 1.4270  0.165  
parent:temperature  4     3938 0.05859 0.7987  0.667  
Residual           45    55463 0.82529                
Total              53    67204 1.00000     

```{r}
pca1<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  geom_text(aes(x = PC1, y = PC2, label = sample), vjust = -0.5)+
  theme_classic()+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pca1
```

Sample 23 is a clear outlier. Remove this sample and plot again. 

```{r}
lipids<-lipids%>%
  filter(!sample=="23")

wide_data<-wide_data%>%
  filter(!sample=="23")
```

View scree plot. 

```{r}
scaled.pca<-prcomp(wide_data[c(4:1240)], scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)
```

Component 1 explains about 45% of variance with approx. 8% explained by component 2. Approx. 5% or less explained by following PCs.  

Prepare a PCA plot
```{r}
# scale data
vegan <- scale(wide_data[c(4:1240)])

# PerMANOVA 
permanova<-adonis2(vegan ~ parent*temperature, data = wide_data, method='eu')
permanova
```

Significant effect of parent and an effect of temperature. 

adonis2(formula = vegan ~ parent * temperature, data = wide_data, method = "eu")
                   Df SumOfSqs      R2      F Pr(>F)  
parent              2     4608 0.07164 2.0655  0.040 *
temperature         2     5437 0.08453 2.4373  0.021 *
parent:temperature  4     5199 0.08082 1.1652  0.257  
Residual           44    49080 0.76301                
Total              52    64324 1.00000     

```{r}
pca2<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca2

pca2b<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="temperature", loadings=FALSE,  colour="temperature", shape="parent", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_fill_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_shape_manual(name="Parental Phenotype", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca2b

pca_plots<-plot_grid(pca2, pca2b, ncol=2, nrow=1)

ggsave(pca_plots, filename="figures/lipids/pca_plots.jpeg", width=12, height=4)
```

View a PCA with treatment code information. 
```{r}
test_wide_data<-wide_data%>%
  mutate(code=paste(parent, temperature))

levels(as.factor(test_wide_data$code))

pca3<-ggplot2::autoplot(scaled.pca, data=test_wide_data, frame.colour="code", loadings=FALSE,  colour="code", shape="code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_fill_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_shape_manual(name="Group", values=c(19,17,15,19,17,15,19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca3

ggsave(pca3, filename="figures/lipids/pca_all_groups.jpeg", width=8, height=6)
```

# Supervised PLS-DA analysis  

Script modified from the following tutorial: https://mixomicsteam.github.io/Bookdown/plsda.html

## PLS-DA for the effect of parent 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- wide_data

levels(as.factor(X$parent))
levels(as.factor(X$temperature))

Y <- as.factor(X$parent) #select treatment names
Y

X<-X[4:1240] #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y, ncomp=2) # 1 Run the method with ncomp = groups -1
plotIndiv(MyResult.plsda)    # 2 Plot the samples

cols<-c("gray", "orange", "brown4") 

pdf("figures/lipids/PLSDA_Parent.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

View classification plot. 

```{r}
perf.plsda <- perf(MyResult.plsda, validation = 'Mfold', folds = 2, 
                  progressBar = FALSE,  # Set to TRUE to track progress
                  nrepeat = 50)         # We suggest nrepeat = 50

plot(perf.plsda, sd = TRUE, legend.position = 'horizontal')
```

Set model to determine VIPs.  

```{r, message=FALSE}
MyResult.plsda_parent <- plsda(X,Y, ncomp=2) 

#view plsda model again
plotIndiv(MyResult.plsda_parent, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Extract VIP scores 

View the lipids that are most highly differentiating lipids     

```{r}
#extract
parent_VIP <- PLSDA.VIP(MyResult.plsda_parent, graph=TRUE)

parent_VIP_DF <- as.data.frame(parent_VIP[["tab"]])
parent_VIP_DF

# Converting row names to column
parent_VIP_table <- rownames_to_column(parent_VIP_DF, var = "Lipid")

#filter for VIP > 1
parent_VIP_1 <- parent_VIP_table %>% 
  filter(VIP >= 1)

write_csv(parent_VIP_1, "output/lipids_metabolites/lipids/Overall_Parent_VIPs.csv")

#plot
parent_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Parent VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("figures/lipids/Parent_VIP.pdf", width=10, height=35)
parent_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Parent VIP > 1") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation between parent groups.  

Make a list of vips. 
```{r}
parent_vip_list<-parent_VIP_1%>%
  pull(Lipid)
```
There are 342 VIPs. 

Plot heatmap of z score of lipids across life stages.  

```{r}
# Filter data for VIP metabolites
parent_vip_data <- lipids %>% filter(lipid %in% parent_vip_list)

# Convert counts to Z-scores
parent_vip_data <- parent_vip_data %>% 
  group_by(lipid) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(parent, lipid)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- parent_vip_data %>% 
  dplyr::select(lipid, parent, z_score) %>%
  spread(key = parent, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "lipid"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = TRUE,
  row_split=6,
  row_title = "Lipid", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/lipids/VIP_heatmap_parent.pdf", width=4, height=6)
draw(heatmap)
dev.off()
```

## PLS-DA for the effect of temperature 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- wide_data

levels(as.factor(X$parent))
levels(as.factor(X$temperature))

Y <- as.factor(X$temperature) #select treatment names
Y

levels(Y)

X<-X[4:1240] #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y, ncomp=2) # 1 Run the method with ncomp = groups -1
plotIndiv(MyResult.plsda)    # 2 Plot the samples

cols<-c("blue", "orange", "red") 

pdf("figures/lipids/PLSDA_Temperature.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

View classification plot. 

```{r}
perf.plsda <- perf(MyResult.plsda, validation = 'Mfold', folds = 2, 
                  progressBar = FALSE,  # Set to TRUE to track progress
                  nrepeat = 50)         # We suggest nrepeat = 50

plot(perf.plsda, sd = TRUE, legend.position = 'horizontal')
```

Set model to determine VIPs.  

```{r, message=FALSE}
MyResult.plsda_temperature <- plsda(X,Y, ncomp=2) 

#view plsda model again
plotIndiv(MyResult.plsda_temperature, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Extract VIP scores 

View the lipids that are most highly differentiating lipids     

```{r}
#extract
temperature_VIP <- PLSDA.VIP(MyResult.plsda_temperature, graph=TRUE)

temperature_VIP_DF <- as.data.frame(temperature_VIP[["tab"]])
temperature_VIP_DF

# Converting row names to column
temperature_VIP_table <- rownames_to_column(temperature_VIP_DF, var = "Lipid")

#filter for VIP > 1
temperature_VIP_1 <- temperature_VIP_table %>% 
  filter(VIP >= 1)

write_csv(temperature_VIP_1, "output/lipids_metabolites/lipids/Overall_Temperature_VIPs.csv")

#plot
temperature_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Temperature VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("figures/lipids/Temperature_VIP.pdf", width=10, height=35)
temperature_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Temperature VIP > 1") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation between temperature groups.  

Make a list of vips. 
```{r}
temperature_vip_list<-temperature_VIP_1%>%
  pull(Lipid)
```
There are 405 VIPs. 

Plot heatmap of z score of lipids across temperature.  

```{r}
# Filter data for VIP metabolites
temperature_vip_data <- lipids %>% filter(lipid %in% temperature_vip_list)

# Convert counts to Z-scores
temperature_vip_data <- temperature_vip_data %>% 
  group_by(lipid) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(temperature, lipid)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

temperature_vip_data$temperature<-factor(temperature_vip_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- temperature_vip_data %>% 
  dplyr::select(lipid, temperature, z_score) %>%
  spread(key = temperature, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "lipid"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = TRUE,
  row_split=2,
  row_title = "Lipid", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/lipids/VIP_heatmap_temperature.pdf", width=4, height=6)
draw(heatmap)
dev.off()
```

## PLS-DA for the effect of parent x temperature 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- wide_data

levels(as.factor(X$parent))
levels(as.factor(X$temperature))

X$code<-paste(X$parent, X$temperature)

levels(as.factor(X$code))

Y <- as.factor(X$code) #select treatment names
Y

levels(Y)

X<-X[4:1240] #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y, ncomp=5) # 1 Run the method with ncomp = groups -1
plotIndiv(MyResult.plsda)    # 2 Plot the samples

cols<-c("orange", "orange3", "orange4", "brown", "brown2", "brown4", "gray", "lightgray", "darkgray") 

pdf("figures/lipids/PLSDA_interaction.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

View classification plot. 

```{r}
perf.plsda <- perf(MyResult.plsda, validation = 'Mfold', folds = 2, 
                  progressBar = FALSE,  # Set to TRUE to track progress
                  nrepeat = 50)         # We suggest nrepeat = 50

plot(perf.plsda, sd = TRUE, legend.position = 'horizontal')
```

Set model to determine VIPs.  

```{r, message=FALSE}
MyResult.plsda_interaction <- plsda(X,Y, ncomp=5) 

#view plsda model again
plotIndiv(MyResult.plsda_interaction, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent x Temperature", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Extract VIP scores 

View the lipids that are most highly differentiating lipids     

```{r}
#extract
interaction_VIP <- PLSDA.VIP(MyResult.plsda_interaction, graph=TRUE)

interaction_VIP_DF <- as.data.frame(interaction_VIP[["tab"]])
interaction_VIP_DF

# Converting row names to column
interaction_VIP_table <- rownames_to_column(interaction_VIP_DF, var = "Lipid")

#filter for VIP > 1
interaction_VIP_1 <- interaction_VIP_table %>% 
  filter(VIP >= 1)

write_csv(interaction_VIP_1, "output/lipids_metabolites/lipids/Overall_Interaction_VIPs.csv")

#plot
interaction_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Parent x Temperature VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("figures/lipids/Interaction_VIP.pdf", width=10, height=35)
interaction_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Interaction VIP > 1") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation between parent x temperature groups.  

Make a list of vips. 
```{r}
interaction_vip_list<-interaction_VIP_1%>%
  pull(Lipid)
```
There are 463 VIPs. 

Plot heatmap of z score of lipids across groups.   

```{r}
# Filter data for VIP metabolites
interaction_vip_data <- lipids %>% filter(lipid %in% interaction_vip_list)

# Convert counts to Z-scores
interaction_vip_data <- interaction_vip_data %>% 
  mutate(code=paste(parent, temperature))%>%
  group_by(lipid) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(code, lipid)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- interaction_vip_data %>% 
  dplyr::select(lipid, code, z_score) %>%
  spread(key = code, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "lipid"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = TRUE,
  row_split=6,
  row_title = "Lipid", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/lipids/VIP_heatmap_parentxtemperature.pdf", width=6, height=8)
draw(heatmap)
dev.off()
```

# Output lists for LION 

List of parental VIPS
```{r}
parent_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/lipids/parent_VIP_list.csv")
```

List of temperature VIPS
```{r}
temperature_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/lipids/temperature_VIP_list.csv")
```

List of interaction VIPS
```{r}
interaction_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/lipids/interaction_VIP_list.csv")
```

Full list of lipids
```{r}
full_lipid_list<-lipids%>%
  pull(lipid)%>%
  unique()%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/lipids/full_lipid_list.csv")
```




