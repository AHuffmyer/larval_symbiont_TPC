---
title: "Lipidomics analysis"
author: "Ariana S Huffmyer"
date: "2024"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

# Set Up    

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(purrr)
library(lubridate)
library(ggplot2)
library(broom)
library(cowplot)
library(mixOmics)
library(dplyr)
library(conflicted)
library(vegan)
library(factoextra)
library(ggfortify)
library(RVAideMemoire)
library(ComplexHeatmap)
library(circlize)
library(tibble)
library(viridis)
library(genefilter)
library(UpSetR)
library(emmeans)
library(car)
library(limma)

conflict_prefer("select", winner = "dplyr", quiet = FALSE)
conflict_prefer("filter", winner = "dplyr", quiet = FALSE)
conflict_prefer("rename", winner = "dplyr", quiet = FALSE)
```

# Data manipulation and preparations  

## Read in all files 

```{r}
metadata<-read_csv("data/lipids_metabolites/lipidomics/lipid_metadata_huffmyer_matthews.csv")%>%
  rename(sample=`Vial ID`, tube=`Sample ID`, temperature=Temperature, parent=Parent, type=Type, code=Code)

neg_values<-read_csv("data/lipids_metabolites/lipidomics/processed-data/negative/PeakValues_2_2024_09_19_13_01_19.csv")

neg_peaks<-read_csv("data/lipids_metabolites/lipidomics/processed-data/negative/PeakMaster_2_2024_09_19_13_01_19.csv")

pos_values<-read_csv("data/lipids_metabolites/lipidomics/processed-data/positive/PeakValues_3_2024_09_19_14_24_22.csv")

pos_peaks<-read_csv("data/lipids_metabolites/lipidomics/processed-data/positive/PeakMaster_3_2024_09_19_14_24_22.csv")

protein<-read_csv("data/lipids_metabolites/protein/protein_calculated.csv")
```

Add protein data to the metadata. 

```{r}
metadata$protein.ug<-protein$`Total Protein ug`[match(metadata$tube, protein$Sample)]
```

## Negative polarity 

How many peaks do we have?  

```{r}
length(neg_peaks$`Metabolite name`)
```

162 peaks. 

Reformat data set to be useful.  

```{r}
neg_peaks<-neg_peaks%>% 
  rename(peak=`Alignment ID`, lipid=`Metabolite name`, formula=Formula, ontology=Ontology)%>%
  select(peak, lipid, formula, ontology)%>%
  mutate(polarity=c("negative"))

neg_values<-neg_values%>%
  rename(peak=ID, file=File, group=Class, area=Area)%>%
  select(peak, file, group, area)%>%
  mutate(polarity=c("negative"))
```

The data frames now contain `peak` for a unique ID for each lipid detected. This number links the two files. Area represents the normalized area after internal standard normalization. We will further normalize this value below.  

Format the file names to correspond to sample IDs in the metadata sheet. 

```{r}
#first remove the test PBQCs ran at 5 and 10 uL loadings and keep the standard 20 uL loading 
neg_values<-neg_values%>%
  filter(!file=="20240423_Mcap_neg_PBQC1_5")%>%
  filter(!file=="20240423_Mcap_neg_PBQC1_10")%>%
  mutate(file = str_replace(file, "20240423_Mcap_neg_PBQC1_20", "20240423_Mcap_neg_PBQC1"))%>%
  mutate(sample = str_extract(file, "[^_]+$"))
```

Merge together all data from the metadata, values, and peak information to one data frame. 

```{r}
negative<-left_join(metadata, neg_values)

negative<-negative%>%
  select(sample, temperature, parent, type, peak, area, polarity, protein.ug)

negative<-left_join(negative, neg_peaks)
```

Next, add together the values for all peaks identified as the same metabolite for each sample.   

How many lipids have multiple peaks detected separately? 
```{r}
length(unique(neg_peaks$lipid))
```

There are 162 unique lipids and 162 peaks. 

Show an example of entries that have the same metabolite with multiple peak IDs. 
```{r}
filtered_values <- negative %>%
  group_by(lipid) %>%
  filter(n_distinct(peak) > 1) %>%
  ungroup()%>%
  arrange(lipid, sample, peak)

print(filtered_values)
```
No duplicates. 

Add together the values for each sample for each identified lipid. 
```{r}
negative<-negative%>%
  group_by(sample, lipid, temperature, parent, type, polarity, formula, ontology, protein.ug)%>%
  summarise(area=sum(area, na.rm=TRUE))
```

Remove PBQC's and Blanks. These were used for peak identification in MSDIAL and are not used downstream at this point. 
```{r}
negative<-negative%>%
  filter(!type=="PBQC")%>%
  filter(!type=="Blank")
```

Conduct internal standard normalization. 

Peak 16879 (PG) will be used as our internal standard for negative polarity. It was consistent across samples (low fold change), high signal:noise, and is mid-retention. 
```{r}
#pull out the name of the standard being used 
standard_neg<-neg_peaks%>%
  filter(peak=="16879")%>%
  pull(lipid)

#make a dataframe of standard values for each sample
standard_neg_value<-negative%>%
  filter(lipid %in% standard_neg)%>%
  group_by(sample)%>%
  summarise(area_standard=mean(area, na.rm=TRUE))

#add this value back into the master data frame for corrections. 
negative<-negative%>%
  left_join(.,standard_neg_value)
```

Remove sample 1, it did not have a signal for the internal standard. 

```{r}
negative<-negative%>%
  filter(!sample=="1")
```

Normalize to the standard. 
```{r}
negative<-negative%>%
   mutate(area_corrected=area/area_standard)
```

Finally, normalize corrected area to sample protein. This will generate units of area / ug protein. 
```{r}
negative<-negative%>%
  mutate(area_normalized=area_corrected/protein.ug)
```

Repeat for positive polarity.  

## Positive polarity 

How many peaks do we have?  

```{r}
length(pos_peaks$`Metabolite name`)
```

896 peaks 

Reformat data set to be useful.  

```{r}
pos_peaks<-pos_peaks%>% 
  rename(peak=`Alignment ID`, lipid=`Metabolite name`, formula=Formula, ontology=Ontology)%>%
  select(peak, lipid, formula, ontology)%>%
  mutate(polarity=c("positive"))

pos_values<-pos_values%>%
  rename(peak=ID, file=File, group=Class, area=Area)%>%
  select(peak, file, group, area)%>%
  mutate(polarity=c("positive"))
```

The data frames now contain `peak` for a unique ID for each lipid detected. This number links the two files. Area represents the normalized area after internal standard normalization. We will further normalize this value below.  

Format the file names to correspond to sample IDs in the metadata sheet. 

```{r}
pos_values<-pos_values%>%
  mutate(sample = str_extract(file, "[^_]+$"))
```

Merge together all data from the metadata, values, and peak information to one data frame. 

```{r}
positive<-left_join(metadata, pos_values)

positive<-positive%>%
  select(sample, temperature, parent, type, peak, area, polarity, protein.ug)

positive<-left_join(positive, pos_peaks)
```

Next, add together the values for all peaks identified as the same metabolite for each sample.   

How many lipids have multiple peaks detected separately? 
```{r}
length(unique(pos_peaks$lipid))
```

There are 896 unique lipids and 896 total peaks. 

Show an example of entries that have the same metabolite with multiple peak IDs. 
```{r}
filtered_values <- positive %>%
  group_by(lipid) %>%
  filter(n_distinct(peak) > 1) %>%
  ungroup()%>%
  arrange(lipid, sample, peak)

print(filtered_values)

levels(factor(filtered_values$lipid))
```

No duplicates

Remove PBQC's and blanks. These were used for peak identification in MSDIAL and are not used downstream at this point. 
```{r}
positive<-positive%>%
  filter(!type=="PBQC")%>%
  filter(!type=="Blank")
```

Conduct internal standard normalization. 

Peak 19029 (LPC) will be used as our internal standard for positive polarity. It was consistent across samples (low fold change), high signal:noise, and was the best representative from standards. 
```{r}
#pull out the name of the standard being used 
standard_pos<-pos_peaks%>%
  filter(peak=="19029")%>%
  pull(lipid)

#make a dataframe of standard values for each sample
standard_pos_value<-positive%>%
  filter(lipid %in% standard_pos)%>%
  group_by(sample)%>%
  summarise(area_standard=mean(area, na.rm=TRUE))

#add this value back into the master data frame for corrections. 
positive<-positive%>%
  left_join(.,standard_pos_value)
```

Remove sample 1, it did not have a signal for the internal standard for negative and therefore is being removed from the data analysis. 

```{r}
positive<-positive%>%
  filter(!sample=="1")
```

Normalize to the standard. 
```{r}
positive<-positive%>%
   mutate(area_corrected=area/area_standard)
```

Finally, normalize corrected area to sample protein. This will generate units of area / ug protein. 

```{r}
positive<-positive%>%
  mutate(area_normalized=area_corrected/protein.ug)
```

## Join polarities together 

Join positive and negative datasets.  

```{r}
length(negative$lipid)
length(positive$lipid)

lipids<-rbind(negative, positive)

length(lipids$lipid)
```

Select polarity for peaks in both polarity files. How many lipids are detected at both polarities? 

```{r}
filtered_values <- lipids %>%
  group_by(lipid) %>%
  filter(n_distinct(polarity) > 1) %>%
  ungroup()%>%
  arrange(lipid, sample, polarity)

print(filtered_values)

length(unique(filtered_values$lipid))
```

There are 40 lipids detected at both polarities. Select the polarity with the highest Area value for each lipid. 
```{r}
# Identify lipids with both polarities
lipids_with_both_polarities <- lipids %>%
  group_by(lipid) %>%
  filter(n_distinct(polarity) == 2)

# Filter lipids with both polarities to keep only the one with the highest area
filtered_lipids <- lipids_with_both_polarities %>%
  group_by(lipid) %>%
  filter(area == max(area)) %>%
  ungroup()

# Identify lipids that only have one entry (i.e., do not have both polarities)
single_entry_lipids <- lipids %>%
  group_by(lipid) %>%
  filter(n_distinct(polarity) == 1) %>%
  ungroup()

# Combine filtered lipids and single entry lipids
lipids_filtered <- bind_rows(filtered_lipids, single_entry_lipids)
```

How many lipids are detected at both polarities? 

```{r}
filtered_values <- lipids_filtered %>%
  group_by(lipid) %>%
  filter(n_distinct(polarity) > 1) %>%
  ungroup()%>%
  arrange(lipid, sample, polarity)

print(filtered_values)

length(unique(filtered_values$lipid))
```

Duplicates are now taken care of.  

View ontology categories available. 
```{r}
levels(as.factor(lipids_filtered$ontology))

ontology<-lipids_filtered%>%ungroup()%>%select(lipid, formula, ontology)%>%unique()
```
 [1] "AHexCAS"    "AHexCer"    "AHexCS"     "AHexSIS"    "ASM"        "BileAcid"   "BMP"       
 [8] "BRSE"       "CAR"        "CASE"       "CE"         "Cer_ADS"    "Cer_AP"     "Cer_AS"    
[15] "Cer_EOS"    "Cer_HDS"    "Cer_HS"     "Cer_NDS"    "Cer_NP"     "Cer_NS"     "CL"        
[22] "CoQ"        "DCAE"       "DEGSE"      "DG"         "DGDG"       "DMPE"       "EtherDG"   
[29] "EtherDGDG"  "EtherLPC"   "EtherLPE"   "EtherMGDG"  "EtherOxPC"  "EtherPC"    "EtherPE"   
[36] "EtherPI"    "EtherPS"    "EtherTG"    "FA"         "FAHFA"      "HBMP"       "HexCer_AP" 
[43] "HexCer_HS"  "HexCer_NDS" "KDCAE"      "KLCAE"      "LCAE"       "LPC"        "LPE"       
[50] "MG"         "MGDG"       "NAE"        "NAGly"      "NAGlySer"   "NAOrn"      "NATau"     
[57] "Others"     "OxFA"       "OxPC"       "OxPE"       "OxPI"       "OxTG"       "PA"        
[64] "PC"         "PE"         "PEtOH"      "PG"         "PI"         "PMeOH"      "PS"        
[71] "SHexCer"    "SISE"       "SL"         "SM"         "SSulfate"   "ST"         "TG"        
[78] "TG_EST"     "Unknown"    "VAE"  

```{r}
lipids_filtered<-lipids_filtered%>%
  select(sample, lipid, temperature, parent, type, polarity, formula, ontology, area_normalized)%>%
  group_by(sample, lipid, temperature, parent, type, formula, ontology)%>%
  summarize(area_normalized=sum(area_normalized, na.rm=TRUE))
```

Remove standard lipids - those with (d7) or (d9) in the lipid name.  

```{r}
lipid_d7 <- lipids_filtered %>%
  filter(str_detect(lipid, "\\(d7\\)"))%>%
  pull(lipid)%>%
  unique()

lipid_d9 <- lipids_filtered %>%
  filter(str_detect(lipid, "\\(d9\\)"))%>%
  pull(lipid)%>%
  unique()

lipids_filtered<-lipids_filtered%>%
  filter(!lipid %in% lipid_d7)%>%
  filter(!lipid %in% lipid_d9)
```

```{r}
length(unique(lipids_filtered$lipid))
```

We have 1009 lipids in our dataset.  

```{r}
hist(lipids_filtered$area_normalized)
```

Plot and remove outliers. 

```{r}
wide_data<-lipids_filtered%>%
  ungroup()%>%
  select(!formula)%>%
  select(!ontology)%>%
  select(!type)%>%
  pivot_wider(names_from=lipid, values_from=area_normalized)
```

```{r}
wide_data%>%
    select_if(~ any(is.na(.)))
```

Replace NA's with 0's. 

```{r}
wide_data[is.na(wide_data)] <- 0

wide_data%>%
    select_if(~ any(is.na(.)))
```

```{r}
str(wide_data)

wide_data$temperature<-factor(wide_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

wide_data$parent<-factor(wide_data$parent, levels=c("Wildtype", "Bleached", "Nonbleached"))
```

All characteristics are renamed.  

View scree plot. 

```{r}
scaled.pca<-prcomp(wide_data%>%select(where(is.numeric)), scale=TRUE, center=TRUE) 
```

```{r}
pca1<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  geom_text(aes(x = PC1, y = PC2, label = sample), vjust = -0.5)+
  theme_classic()+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pca1
```

Sample 23 and 48 are outliers, remove. 

```{r}
wide_data<-wide_data%>%
  filter(!sample=="23")%>%
  filter(!sample=="48")

lipids_filtered<-lipids_filtered%>%
  filter(!sample=="23")%>%
  filter(!sample=="48")
```

# Conduct filtering for relative standard deviation 

Make a dataframe that calculates the standard deviation of the lipid area within treatment relative to the mean (i.e., how "large" is the SD).  

The formula will be:  

(sd*100)/mean 

Calculate for each lipid in each treatment group. 
```{r}
test<-lipids_filtered%>%
  group_by(lipid, parent, temperature)%>%
  summarise(RSD=(sd(area_normalized)*100)/mean(area_normalized))

length(unique(test$lipid))

hist(test$RSD)
```
1009 lipids before 

Keep lipids with RSD <40 in all treatments.  
```{r}
test <- test %>%
  group_by(lipid, parent, temperature) %>%
  filter(all(RSD < 40))

length(unique(test$lipid))

keep_list<-c(unique(test$lipid))

hist(test$RSD)
```
843 metabolites after 

Filter the filtered dataset to include the selected metabolites after RSD filtering.  
```{r}
lipids_filtered<-lipids_filtered%>%
  filter(lipid %in% keep_list)
```

We are now ready to conduct analysis! 

Export the processed dataset. 

```{r}
write_csv(lipids_filtered, file="output/lipids_metabolites/lipids/processed_lipids.csv")
```

# Unsupervised analysis 

Conduct a PCA and PERMANOVA to examine the effects of parent and temperature on the lipidome of coral larvae. 

Convert to wide format. 

```{r}
wide_data<-lipids_filtered%>%
  ungroup()%>%
  select(!formula)%>%
  select(!ontology)%>%
  select(!type)%>%
  pivot_wider(names_from=lipid, values_from=area_normalized)
```

```{r}
wide_data%>%
    select_if(~ any(is.na(.)))
```

No columns have NA's.  

```{r}
str(wide_data)

wide_data$temperature<-factor(wide_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

wide_data$parent<-factor(wide_data$parent, levels=c("Wildtype", "Bleached", "Nonbleached"))
```

All characteristics are renamed.  

View scree plot. 

```{r}
scaled.pca<-prcomp(wide_data%>%select(where(is.numeric)), scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)
```

Prepare a PCA plot
```{r}
# scale data
vegan <- scale(wide_data%>%select(where(is.numeric)))

# PerMANOVA 
permanova<-adonis2(vegan ~ parent*temperature, data = wide_data, method='eu')
permanova
```

adonis2(formula = vegan ~ parent * temperature, data = wide_data, method = "eu")
                   Df SumOfSqs      R2      F Pr(>F)  
parent              2     3925 0.09312 2.5252  0.024 *
temperature         2     3346 0.07938 2.1525  0.050 *
parent:temperature  4     2238 0.05309 0.7198  0.703  
Residual           42    32642 0.77441                
Total              50    42150 1.00000      

```{r}
pca1<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  geom_text(aes(x = PC1, y = PC2, label = sample), vjust = -0.5)+
  theme_classic()+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pca1
```

```{r}
pca2<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca2

pca2b<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="temperature", loadings=FALSE,  colour="temperature", shape="parent", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_fill_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_shape_manual(name="Parental Phenotype", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca2b

pca_plots<-plot_grid(pca2, pca2b, ncol=2, nrow=1)

ggsave(pca_plots, filename="figures/lipids/pca_plots.jpeg", width=12, height=4)
```

View a PCA with treatment code information. 
```{r}
test_wide_data<-wide_data%>%
  mutate(code=paste(parent, temperature))

levels(as.factor(test_wide_data$code))

pca3<-ggplot2::autoplot(scaled.pca, data=test_wide_data, frame.colour="code", loadings=FALSE,  colour="code", shape="code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_fill_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_shape_manual(name="Group", values=c(19,17,15,19,17,15,19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca3

ggsave(pca3, filename="figures/lipids/pca_all_groups.jpeg", width=8, height=6)
```

Plot by each temperature colored by parent temperature. 

```{r}
pca4<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  facet_wrap(~temperature)+
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca4
```

# Supervised PLS-DA analysis:parent and temperature effects  

Script modified from the following tutorial: https://mixomicsteam.github.io/Bookdown/plsda.html

## PLS-DA for the effect of parent 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- wide_data

levels(as.factor(X$parent))
levels(as.factor(X$temperature))

Y <- as.factor(X$parent) #select treatment names
Y

X<-X%>%select(where(is.numeric)) #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y, ncomp=2) # 1 Run the method with ncomp = groups -1
plotIndiv(MyResult.plsda)    # 2 Plot the samples

cols<-c("gray", "orange", "brown4") 

pdf("figures/lipids/PLSDA_Parent.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

View classification plot. 

```{r}
perf.plsda <- perf(MyResult.plsda, validation = 'Mfold', folds = 2, 
                  progressBar = FALSE,  # Set to TRUE to track progress
                  nrepeat = 50)         # We suggest nrepeat = 50

plot(perf.plsda, sd = TRUE, legend.position = 'horizontal')
```

Set model to determine VIPs.  

```{r, message=FALSE}
MyResult.plsda_parent <- plsda(X,Y, ncomp=2) 

#view plsda model again
plotIndiv(MyResult.plsda_parent, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Extract VIP scores 

View the lipids that are most highly differentiating lipids     

```{r}
#extract
parent_VIP <- PLSDA.VIP(MyResult.plsda_parent, graph=TRUE)

parent_VIP_DF <- as.data.frame(parent_VIP[["tab"]])
parent_VIP_DF

# Converting row names to column
parent_VIP_table <- rownames_to_column(parent_VIP_DF, var = "Lipid")

#filter for VIP > 1
parent_VIP_1 <- parent_VIP_table %>% 
  filter(VIP >= 1)

write_csv(parent_VIP_1, "output/lipids_metabolites/lipids/Overall_Parent_VIPs.csv")

#plot
parent_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Parent VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("figures/lipids/Parent_VIP.pdf", width=10, height=35)
parent_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Parent VIP > 1") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation between parent groups.  

Make a list of vips. 
```{r}
parent_vip_list<-parent_VIP_1%>%
  pull(Lipid)
```
There are 237 VIPs. 

Plot heatmap of z score of VIP lipids across life stages.  

```{r}
# Filter data for VIP metabolites
parent_vip_data <- lipids_filtered %>% filter(lipid %in% parent_vip_list)

# Convert counts to Z-scores
parent_vip_data <- parent_vip_data %>% 
  group_by(lipid) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(parent, lipid)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- parent_vip_data %>% 
  dplyr::select(lipid, parent, z_score) %>%
  spread(key = parent, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "lipid"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = TRUE,
  #row_split=6,
  row_title = "Lipid", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/lipids/VIP_heatmap_parent.pdf", width=4, height=6)
draw(heatmap)
dev.off()
```

View a PCA of these VIPs. 

```{r}
vip_data_parent<-lipids_filtered%>%
  ungroup()%>%
  select(!formula)%>%
  select(!ontology)%>%
  select(!type)%>%
  filter(lipid %in% parent_vip_list)%>%
  pivot_wider(names_from=lipid, values_from=area_normalized)
```

```{r}
vip_data_parent%>%
    select_if(~ any(is.na(.)))
```

No columns have NA's.  

```{r}
vip_data_parent$temperature<-factor(vip_data_parent$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

vip_data_parent$parent<-factor(vip_data_parent$parent, levels=c("Wildtype", "Bleached", "Nonbleached"))
```

All characteristics are renamed.  

View scree plot. 

```{r}
scaled.pca<-prcomp(vip_data_parent%>%select(where(is.numeric)), scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)
```

Prepare a PCA plot
```{r}
# scale data
vegan <- scale(vip_data_parent%>%select(where(is.numeric)))

# PerMANOVA 
permanova<-adonis2(vegan ~ parent*temperature, data = vip_data_parent, method='eu')
permanova
```

adonis2(formula = vegan ~ parent * temperature, data = vip_data_parent, method = "eu")
                   Df SumOfSqs      R2      F Pr(>F)    
parent              2   2631.8 0.22209 7.0674  0.001 ***
temperature         2    874.1 0.07376 2.3472  0.031 *  
parent:temperature  4    524.0 0.04422 0.7035  0.753    
Residual           42   7820.1 0.65993                  
Total              50  11850.0 1.00000         

```{r}
pca_vip_parent1<-ggplot2::autoplot(scaled.pca, data=vip_data_parent, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca_vip_parent1

pca_vip_parent2<-ggplot2::autoplot(scaled.pca, data=vip_data_parent, frame.colour="temperature", loadings=FALSE,  colour="temperature", shape="parent", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_fill_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_shape_manual(name="Parental Phenotype", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca_vip_parent2

pca_plots_parent<-plot_grid(pca_vip_parent1, pca_vip_parent2, ncol=2, nrow=1)

ggsave(pca_plots_parent, filename="figures/lipids/pca_plots_parentVIP.jpeg", width=12, height=4)
```

View a PCA with treatment code information. 
```{r}
test_wide_data<-vip_data_parent%>%
  mutate(code=paste(parent, temperature))

levels(as.factor(test_wide_data$code))

pca_parent3<-ggplot2::autoplot(scaled.pca, data=test_wide_data, frame.colour="code", loadings=FALSE,  colour="code", shape="code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_fill_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_shape_manual(name="Group", values=c(19,17,15,19,17,15,19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca_parent3

ggsave(pca_parent3, filename="figures/lipids/pca_all_groups_parentVIP.jpeg", width=8, height=6)
```

## PLS-DA for the effect of temperature 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- wide_data

levels(as.factor(X$parent))
levels(as.factor(X$temperature))

Y <- as.factor(X$temperature) #select treatment names
Y

levels(Y)

X<-X%>%select(where(is.numeric)) #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y, ncomp=2) # 1 Run the method with ncomp = groups -1
plotIndiv(MyResult.plsda)    # 2 Plot the samples

cols<-c("blue", "orange", "red") 

pdf("figures/lipids/PLSDA_Temperature.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

View classification plot. 

```{r}
perf.plsda <- perf(MyResult.plsda, validation = 'Mfold', folds = 2, 
                  progressBar = FALSE,  # Set to TRUE to track progress
                  nrepeat = 50)         # We suggest nrepeat = 50

plot(perf.plsda, sd = TRUE, legend.position = 'horizontal')
```

Set model to determine VIPs.  

```{r, message=FALSE}
MyResult.plsda_temperature <- plsda(X,Y, ncomp=2) 

#view plsda model again
plotIndiv(MyResult.plsda_temperature, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Extract VIP scores 

View the lipids that are most highly differentiating lipids     

```{r}
#extract
temperature_VIP <- PLSDA.VIP(MyResult.plsda_temperature, graph=TRUE)

temperature_VIP_DF <- as.data.frame(temperature_VIP[["tab"]])
temperature_VIP_DF

# Converting row names to column
temperature_VIP_table <- rownames_to_column(temperature_VIP_DF, var = "Lipid")

#filter for VIP > 1
temperature_VIP_1 <- temperature_VIP_table %>% 
  filter(VIP >= 1)

write_csv(temperature_VIP_1, "output/lipids_metabolites/lipids/Overall_Temperature_VIPs.csv")

#plot
temperature_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Temperature VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("figures/lipids/Temperature_VIP.pdf", width=10, height=35)
temperature_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Lipid,VIP,sum))) +
  geom_point() +
  ylab("Lipid") +
  xlab("VIP Score") +
  ggtitle("Temperature VIP > 1") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation between temperature groups.  

Make a list of vips. 
```{r}
temperature_vip_list<-temperature_VIP_1%>%
  pull(Lipid)
```
There are 251 VIPs. 

Plot heatmap of z score of lipids across temperature.  

```{r}
# Filter data for VIP metabolites
temperature_vip_data <- lipids_filtered %>% filter(lipid %in% temperature_vip_list)

# Convert counts to Z-scores
temperature_vip_data <- temperature_vip_data %>% 
  group_by(lipid) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(temperature, lipid)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

temperature_vip_data$temperature<-factor(temperature_vip_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- temperature_vip_data %>% 
  dplyr::select(lipid, temperature, z_score) %>%
  spread(key = temperature, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "lipid"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = FALSE,
  show_column_names = TRUE,
  #row_split=6,
  row_title = "Lipid", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/lipids/VIP_heatmap_temperature.pdf", width=4, height=6)
draw(heatmap)
dev.off()
```

View a PCA of these VIPs. 

```{r}
vip_data_temperature<-lipids_filtered%>%
  ungroup()%>%
  select(!formula)%>%
  select(!ontology)%>%
  select(!type)%>%
  filter(lipid %in% temperature_vip_list)%>%
  pivot_wider(names_from=lipid, values_from=area_normalized)
```

```{r}
vip_data_temperature%>%
    select_if(~ any(is.na(.)))
```

No columns have NA's.  

```{r}
vip_data_temperature$temperature<-factor(vip_data_temperature$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

vip_data_temperature$parent<-factor(vip_data_temperature$parent, levels=c("Wildtype", "Bleached", "Nonbleached"))
```

All characteristics are renamed.  

View scree plot. 

```{r}
scaled.pca<-prcomp(vip_data_temperature%>%select(where(is.numeric)), scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)
```

Prepare a PCA plot
```{r}
# scale data
vegan <- scale(vip_data_temperature%>%select(where(is.numeric)))

# PerMANOVA 
permanova<-adonis2(vegan ~ parent*temperature, data = vip_data_temperature, method='eu')
permanova
```

adonis2(formula = vegan ~ parent * temperature, data = vip_data_temperature, method = "eu")
                   Df SumOfSqs      R2      F Pr(>F)  
parent              2   1228.1 0.09786 2.7436  0.018 *
temperature         2   1219.2 0.09715 2.7237  0.021 *
parent:temperature  4    702.6 0.05598 0.7848  0.681  
Residual           42   9400.1 0.74901                
Total              50  12550.0 1.00000          

```{r}
pca_vip_temperature1<-ggplot2::autoplot(scaled.pca, data=vip_data_temperature, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca_vip_temperature1

pca_vip_temperature2<-ggplot2::autoplot(scaled.pca, data=vip_data_temperature, frame.colour="temperature", loadings=FALSE,  colour="temperature", shape="parent", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_fill_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_shape_manual(name="Parental Phenotype", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca_vip_temperature2

pca_plots_temperature<-plot_grid(pca_vip_temperature1, pca_vip_temperature2, ncol=2, nrow=1)

ggsave(pca_plots_temperature, filename="figures/lipids/pca_plots_temperatureVIP.jpeg", width=12, height=4)
```

View a PCA with treatment code information. 
```{r}
test_wide_data<-vip_data_temperature%>%
  mutate(code=paste(parent, temperature))

levels(as.factor(test_wide_data$code))

pca_temperature3<-ggplot2::autoplot(scaled.pca, data=test_wide_data, frame.colour="code", loadings=FALSE,  colour="code", shape="code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_fill_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_shape_manual(name="Group", values=c(19,17,15,19,17,15,19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca_temperature3

ggsave(pca_temperature3, filename="figures/lipids/pca_all_groups_temperatureVIP.jpeg", width=8, height=6)
```

# limma Analysis 

Limma analysis will be used to run a linear model per lipid and conduct multiple comparison corrections. This will allow us to examine interactive effects more effectively than a PLSDA. 

```{r}
str(wide_data)
```

```{r}
# --- 1. Prepare expression matrix (lipids only, samples as columns) ---
expr_mat <- t(as.matrix(wide_data[ , -(1:3)]))  # transpose so rows = lipids, cols = samples
rownames(expr_mat) <- colnames(wide_data)[-(1:3)]   # lipid names
colnames(expr_mat) <- wide_data$sample              # sample IDs

# --- 2. Define factors ---
temperature <- factor(wide_data$temperature)
parent <- factor(wide_data$parent)

# --- 3. Build design matrix with interaction ---
design <- model.matrix(~ parent * temperature)

# Check design
print(colnames(design))

# --- 4. Fit limma model ---
fit <- lmFit(expr_mat, design)
fit <- eBayes(fit)

# --- 5. Extract results ---
# parent main effect(s)
res_parent <- topTable(fit, coef=grep("^parent", colnames(fit$coefficients)), number=Inf, adjust="BH")

# temperature main effect(s)
res_temperature <- topTable(fit, coef=grep("^temperature", colnames(fit$coefficients)), number=Inf, adjust="BH")

# interaction effect(s)
res_interaction <- topTable(fit, coef=grep("parent.*:temperature|temperature.*:parent", 
                                           colnames(fit$coefficients)), 
                            number=Inf, adjust="BH")

# --- 6. Optional: Combine into one summary table ---
results_summary <- tibble(
  lipid = rownames(expr_mat),
  logFC_parent = res_parent$logFC,
  FDR_parent   = res_parent$adj.P.Val,
  logFC_temp   = res_temperature$logFC,
  FDR_temp     = res_temperature$adj.P.Val,
  logFC_int    = res_interaction$logFC,
  FDR_int      = res_interaction$adj.P.Val
)

# View results
head(results_summary)
```

Subset lists of lipids significant by parent, temperature, and the interaction. 

Parent
```{r}
limma_parent<-results_summary%>%filter(FDR_parent<0.05)
dim(limma_parent)
```
77 lipids 

Temperature
```{r}
limma_temperature<-results_summary%>%filter(FDR_temp<0.05)
dim(limma_temperature)
```
65 lipids 

Interaction
```{r}
limma_int<-results_summary%>%filter(FDR_int<0.05)
dim(limma_int)
```
0 lipids 

```{r}
library(VennDiagram)

sig_parent <- rownames(res_parent)[res_parent$adj.P.Val < 0.05]
sig_temp <- rownames(res_temperature)[res_temperature$adj.P.Val < 0.05]
sig_int <- rownames(res_interaction)[res_interaction$adj.P.Val < 0.05]

venn.plot <- venn.diagram(
  x = list(Parent = sig_parent,
           Temperature = sig_temp,
           Interaction = sig_int),
  filename = NULL,
  fill = c("red", "blue", "green"),
  alpha = 0.5
)

grid::grid.draw(venn.plot)
```

There are 60 uniquely differential lipids by parent, 48 unique by temperature, and 17 shared as differential in both parent and temperature. There are no lipids significantly influenced by interactive effects. Suggests strong parental effects across temperatures with a conserved temperature response. 

Plot a heatmap of parental lipids. 

```{r}
# take lipids significant for parent 
top_lipids <- rownames(res_parent)[res_parent$adj.P.Val < 0.05]

# Subset expression matrix
mat_top <- expr_mat[top_lipids, ]

# Scale for visualization
mat_scaled <- t(scale(t(mat_top)))

# Heatmap (samples grouped by metadata)
pheatmap(mat_scaled,
         annotation_col = wide_data %>% select(parent, temperature),
         show_rownames = FALSE,
         main = "Differential Parent Lipids")
```

Plot a heatmap of temperature lipids. 

```{r}
# take lipids significant for parent 
top_lipids <- rownames(res_temperature)[res_temperature$adj.P.Val < 0.05]

# Subset expression matrix
mat_top <- expr_mat[top_lipids, ]

# Scale for visualization
mat_scaled <- t(scale(t(mat_top)))

# Heatmap (samples grouped by metadata)
pheatmap(mat_scaled,
         annotation_col = wide_data %>% select(parent, temperature),
         show_rownames = FALSE,
         main = "Differential Parent Lipids")
```

# Output lists for LION 

List of parental VIPS
```{r}
parent_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/lipids/parent_VIP_list.csv")
```

No significant enrichment of any terms on LION. 

List of temperature VIPS
```{r}
temperature_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/lipids/temperature_VIP_list.csv")
```

No significant enrichment of any terms on LION. 

List of interaction VIPS
```{r}
interaction_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/lipids/interaction_VIP_list.csv")
```

Full list of lipids
```{r}
full_lipid_list<-lipids_filtered%>%
  pull(lipid)%>%
  unique()%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/lipids/full_lipid_list.csv")
```

What is the overlap in these lists? Create an upset plot. 

```{r}
# Combine lists into a data frame indicating membership (1 = present, 0 = absent)
upset_data <- data.frame(
  Lipid = unique(c(parent_vip_list, temperature_vip_list, interaction_vip_list)),
  List1 = as.numeric(unique(c(parent_vip_list, temperature_vip_list, interaction_vip_list)) %in% parent_vip_list),
  List2 = as.numeric(unique(c(parent_vip_list, temperature_vip_list, interaction_vip_list)) %in% temperature_vip_list),
  List3 = as.numeric(unique(c(parent_vip_list, temperature_vip_list, interaction_vip_list)) %in% interaction_vip_list)
)

# Convert data to the format needed for the UpSetR plot
plot_data <- upset_data[, -1]
row.names(plot_data) <- upset_data$Lipid
names(plot_data) <- c("Parent", "Temperature", "PxT Group")

# Generate the UpSet plot
pdf("figures/lipids/upset_VIP_list_overlap.pdf", width=6, height=6)
upset(plot_data, sets = c("Parent", "Temperature", "PxT Group"), keep.order = TRUE)
dev.off()
```

# Compare height and area VIP lists 

Plot upset plot for each factor tested between height and area 

Parent VIP lists: 
```{r}
list1<-read_csv("output/lipids_metabolites/lipids/parent_VIP_list.csv")%>%pull(.)
list2<-read_csv("output/lipids_metabolites/lipids/parent_VIP_list_height.csv")%>%pull(.)

# Combine lists into a data frame indicating membership (1 = present, 0 = absent)
upset_data <- data.frame(
  Lipid = unique(c(list1, list2)),
  List1 = as.numeric(unique(c(list1, list2)) %in% list1),
  List2 = as.numeric(unique(c(list1, list2)) %in% list2))

# Convert data to the format needed for the UpSetR plot
plot_data <- upset_data[, -1]
row.names(plot_data) <- upset_data$Lipid
names(plot_data) <- c("Area", "Height")

# Generate the UpSet plot
upset(plot_data, sets = c("Area", "Height"), keep.order = TRUE)
```
218 shared, 31 unique to height, 19 unique to area data sets. 

Temperature VIP lists: 

```{r}
list1<-read_csv("output/lipids_metabolites/lipids/temperature_VIP_list.csv")%>%pull(.)
list2<-read_csv("output/lipids_metabolites/lipids/temperature_VIP_list_height.csv")%>%pull(.)

# Combine lists into a data frame indicating membership (1 = present, 0 = absent)
upset_data <- data.frame(
  Lipid = unique(c(list1, list2)),
  List1 = as.numeric(unique(c(list1, list2)) %in% list1),
  List2 = as.numeric(unique(c(list1, list2)) %in% list2))

# Convert data to the format needed for the UpSetR plot
plot_data <- upset_data[, -1]
row.names(plot_data) <- upset_data$Lipid
names(plot_data) <- c("Area", "Height")

# Generate the UpSet plot
upset(plot_data, sets = c("Area", "Height"), keep.order = TRUE)
```
213 shared, 38 unique to height, 38 unique to area data sets. 

Interaction VIP lists: 

```{r}
list1<-read_csv("output/lipids_metabolites/lipids/interaction_VIP_list.csv")%>%pull(.)
list2<-read_csv("output/lipids_metabolites/lipids/interaction_VIP_list_height.csv")%>%pull(.)

# Combine lists into a data frame indicating membership (1 = present, 0 = absent)
upset_data <- data.frame(
  Lipid = unique(c(list1, list2)),
  List1 = as.numeric(unique(c(list1, list2)) %in% list1),
  List2 = as.numeric(unique(c(list1, list2)) %in% list2))

# Convert data to the format needed for the UpSetR plot
plot_data <- upset_data[, -1]
row.names(plot_data) <- upset_data$Lipid
names(plot_data) <- c("Area", "Height")

# Generate the UpSet plot
upset(plot_data, sets = c("Area", "Height"), keep.order = TRUE)
```
266 shared, 39 unique to height, 36 unique to area data sets.

In each set, most lipids are shared by area and height data sets. 

# Plot enriched lipids in the group VIP data set 

Results from LION: 

- No enrichment in parent list 
- No enrichment in temperature list 
- fatty acids [FA], and fatty acids and conjugates [FA01] enriched in group specific list 

Ontology FA

Add in lipid ontology values. 

```{r}
lipids$ontology<-ontology$ontology[match(lipids$lipid, ontology$lipid)]
```

Plot a heatmap of the target ontologies in the group VIP list (parent x temperature). 

Fatty acids
```{r}
# Filter data for VIP metabolites
FA_data <- lipids %>% 
  filter(lipid %in% interaction_vip_list) %>% 
  filter(ontology=="FA") %>% 
  droplevels()

length(unique(FA_data$lipid))
#16 fatty acids in this data set 

# Convert counts to Z-scores
FA_data <- FA_data %>% 
  group_by(lipid) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(parent, temperature, lipid)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- FA_data %>% 
  mutate(code=paste(parent, temperature))%>%
  mutate(code=factor(code, levels=c("Bleached Ambient", "Bleached Moderate (+3)", "Bleached High (+6)", "Nonbleached Ambient", "Nonbleached Moderate (+3)", "Nonbleached High (+6)", "Wildtype Ambient", "Wildtype Moderate (+3)", "Wildtype High (+6)")))%>%
  dplyr::select(lipid, code, z_score) %>%
  spread(key = code, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "lipid"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  #row_split=split,
  #column_split=heatmap_data$code,
  row_title = "Fatty Acids", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/lipids/fatty_acids_VIP.pdf", width=6, height=8)
draw(heatmap)
dev.off()
```

# Perform ANOVAs of lipid concentration between groups 

Perform an ANOVA with FDR corrections for lipids to detect which lipids are different between groups. 

Run model for each lipid and apply FDR p value correction. 
```{r}
name_list<-c(unique(lipids_filtered$lipid))

#Create an empty data frame to store the results
results_table <- data.frame(Lipid = character(),
                            Effect = character(),
                            DF = numeric(),
                            SumSq = numeric(),
                            F_value = numeric(),
                            p_value = numeric())

#Loop over each compound in compound_list
for(compound in name_list){
  
  #Fit the linear mixed effect model for each compound
  model <- lipids_filtered%>%
    filter(lipid==compound)%>%
    
    aov(area_normalized ~ temperature * parent, data = .)

  #Extract the relevant coefficients for interaction of treatment x position
  anova_output <- anova(model)
  coef_summary <- tidy(anova_output)
  coef_summary <- as.data.frame(coef_summary)
  
  #Store the results in the results_table data frame
  results_table <- rbind(results_table, data.frame(Lipid = compound,
                                                   Effect = coef_summary["term"],
                                                   DF = coef_summary["df"],
                                                   SumSq = coef_summary["sumsq"],
                                                   F_value = coef_summary["statistic"],
                                                   p_value = coef_summary["p.value"]))
}


results_table<-results_table%>%
  filter(!term=="Residuals")

#apply a p value correction (FDR) for multiple comparisons 
results_table$adj_pvalues <- p.adjust(results_table$p.value, method = "fdr")

#view only p<0.05
results_table_sign<-results_table%>%
  filter(adj_pvalues<=0.05)

head(results_table_sign)

write.csv(results_table, file="output/lipids_metabolites/lipids/anova_full_results.csv")
```

# View concentrations of lipids by class 

Summarize lipid concentration by class for each sample. 

```{r}
classes<-lipids_filtered%>%
  ungroup()%>%
  select(!type)%>%
  select(!formula)%>%
  group_by(sample, temperature, parent, ontology)%>%
  summarise(class_area=sum(area_normalized))
```

Run model for each ontology. 

```{r}
ontology_list<-c(unique(classes$ontology))

#Create an empty data frame to store the results
results_table <- data.frame(Ontology = character(),
                            Effect = character(),
                            DF = numeric(),
                            SumSq = numeric(),
                            F_value = numeric(),
                            p_value = numeric())

#Loop over each compound in compound_list
for(class in ontology_list){
  
  #Fit the linear mixed effect model for each compound
  model <- classes%>%
    filter(ontology==class)%>%
    
    aov(class_area ~ temperature * parent, data = .)
  
  qqPlot(residuals(model))

  #Extract the relevant coefficients for interaction of treatment x position
  anova_output <- anova(model)
  coef_summary <- tidy(anova_output)
  coef_summary <- as.data.frame(coef_summary)
  
  #Store the results in the results_table data frame
  results_table <- rbind(results_table, data.frame(Ontology = class,
                                                   Effect = coef_summary["term"],
                                                   DF = coef_summary["df"],
                                                   SumSq = coef_summary["sumsq"],
                                                   F_value = coef_summary["statistic"],
                                                   p_value = coef_summary["p.value"]))
}


results_table<-results_table%>%
  filter(!term=="Residuals")

#apply a p value correction (FDR) for multiple comparisons 
results_table$adj_pvalues <- p.adjust(results_table$p.value, method = "fdr")

#view only p<0.05
results_table_sign<-results_table%>%
  filter(adj_pvalues<=0.05)

results_table_sign
```

   Ontology        term df        sumsq statistic      p.value  adj_pvalues
1  BileAcid temperature  2 7.800681e-06  8.327628 8.990615e-04 0.0277424700
2        CL      parent  2 1.387019e-04 13.694806 2.636644e-05 0.0014237878
3   Cer_ADS      parent  2 1.960034e-04 10.344704 2.224116e-04 0.0080068191
4 EtherDGDG temperature  2 1.485662e-06 10.393233 2.153021e-04 0.0080068191
5 EtherMGDG      parent  2 7.278373e-06 14.517823 1.611506e-05 0.0011602844
6      LCAE      parent  2 1.187502e-05 16.440865 5.325273e-06 0.0007800822
7        SL      parent  2 5.213944e-04 15.901355 7.222983e-06 0.0007800822

This does mask some of the differences in individual lipids that we saw above.  

Plot total class concentration for these classes.  

```{r}
plot_c1<-classes%>%
  filter(ontology %in% c("CL", "Cer_ADS", "EtherMGDG", "LCAE", "SL"))%>%
  
  
  ggplot(aes(x=paste(parent), y=class_area, color=parent))+
  facet_wrap(~ontology, scales="free")+
  geom_boxplot(outliers=FALSE)+
  geom_point()+
  theme_classic()+
  scale_color_manual(values=c("orange", "darkred", "darkgray"))+
  #scale_x_discrete(limits=c("Bleached Ambient", "Bleached Moderate (+3)", "Bleached High (+6)", "Nonbleached Ambient", "Nonbleached Moderate (+3)", "Nonbleached High (+6)", "Wildtype Ambient", "Wildtype Moderate (+3)", "Wildtype High (+6)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1));plot_c1

ggsave(plot_c1, filename="figures/lipids/sign_classes_parent.jpeg", width=8, height=8)
```

```{r}
plot_c2<-classes%>%
  filter(ontology %in% c("BileAcid", "EtherDGDG"))%>%
  
  
  ggplot(aes(x=paste(temperature), y=class_area, color=temperature))+
  facet_wrap(~ontology, scales="free")+
  geom_boxplot(outliers=FALSE)+
  geom_point()+
  theme_classic()+
  scale_color_manual(values=c("blue", "red", "orange"))+
  scale_x_discrete(limits=c("Ambient", "Moderate (+3)", "High (+6)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1));plot_c2

ggsave(plot_c2, filename="figures/lipids/sign_classes_temperature.jpeg", width=6, height=6)
```

# View total lipids 

Add up total lipids - add up all classes

```{r}
totals<-classes%>%
  group_by(sample, temperature, parent)%>%
  summarise(total_area=sum(class_area))
```

View total lipids by treatment group. 

```{r}
plot_t1<-totals%>%
  
  ggplot(aes(x=paste(parent, temperature), y=total_area, color=parent))+
  geom_boxplot(outliers=FALSE)+
  geom_point()+
  theme_classic()+
  scale_color_manual(values=c("orange", "darkred", "darkgray"))+
  scale_x_discrete(limits=c("Bleached Ambient", "Bleached Moderate (+3)", "Bleached High (+6)", "Nonbleached Ambient", "Nonbleached Moderate (+3)", "Nonbleached High (+6)", "Wildtype Ambient", "Wildtype Moderate (+3)", "Wildtype High (+6)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1));plot_t1

ggsave(plot_t1, filename="figures/lipids/total_lipids.jpeg", width=8, height=8)
```

Run a model to analyze total lipids. 

```{r}
model<-totals%>%
  
  aov(total_area ~ temperature * parent, data=.)

summary(model)
```
No effect on total lipids, almost an effect of temperature but not quite.  

# View class composition as percentage of total lipids 

Calculate lipid proportion of each class as a function of the total lipids. 

```{r}
classes<-left_join(classes, totals)

classes$prop_class<-(classes$class_area/classes$total_area)*100
```

Most lipids (50-70%) are fatty acids. 

View percent lipids for each class. 

Fatty acids
```{r}
plot_t2<-classes%>%
  filter(ontology=="FA")%>%
  
  ggplot(aes(x=paste(parent, temperature), y=prop_class, color=parent))+
  facet_wrap(~ontology)+
  geom_boxplot(outliers=FALSE)+
  geom_point()+
  theme_classic()+
  scale_color_manual(values=c("orange", "darkred", "darkgray"))+
  scale_x_discrete(limits=c("Bleached Ambient", "Bleached Moderate (+3)", "Bleached High (+6)", "Nonbleached Ambient", "Nonbleached Moderate (+3)", "Nonbleached High (+6)", "Wildtype Ambient", "Wildtype Moderate (+3)", "Wildtype High (+6)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1));plot_t2

```

TGs
```{r}
plot_t2<-classes%>%
  filter(ontology=="TG")%>%
  
  ggplot(aes(x=paste(parent, temperature), y=prop_class, color=parent))+
  facet_wrap(~ontology)+
  geom_boxplot(outliers=FALSE)+
  geom_point()+
  theme_classic()+
  scale_color_manual(values=c("orange", "darkred", "darkgray"))+
  scale_x_discrete(limits=c("Bleached Ambient", "Bleached Moderate (+3)", "Bleached High (+6)", "Nonbleached Ambient", "Nonbleached Moderate (+3)", "Nonbleached High (+6)", "Wildtype Ambient", "Wildtype Moderate (+3)", "Wildtype High (+6)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1));plot_t2

```

Plot stacked bar plot by sample.  
```{r}
plot_t3<-classes%>%
  
  ggplot(aes(x=paste(sample), y=prop_class, fill=ontology))+
  geom_bar(stat="identity")+
  theme_classic()+
  #scale_x_discrete(limits=c("Bleached Ambient", "Bleached Moderate (+3)", "Bleached High (+6)", "Nonbleached Ambient", "Nonbleached Moderate (+3)", "Nonbleached High (+6)", "Wildtype Ambient", "Wildtype Moderate (+3)", "Wildtype High (+6)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1));plot_t3
```

Run a model
```{r}
model<-classes%>%
  filter(ontology=="FA")%>%
  
  aov(prop_class ~ temperature*parent, data=.)

summary(model)
```

```{r}
model<-classes%>%
  filter(ontology=="TG")%>%
  
  aov(prop_class ~ temperature*parent, data=.)

summary(model)
```

Run model for each ontology. 

```{r}
ontology_list<-c(unique(classes$ontology))

#Create an empty data frame to store the results
results_table <- data.frame(Ontology = character(),
                            Effect = character(),
                            DF = numeric(),
                            SumSq = numeric(),
                            F_value = numeric(),
                            p_value = numeric())

#Loop over each compound in compound_list
for(class in ontology_list){
  
  #Fit the linear mixed effect model for each compound
  model <- classes%>%
    filter(ontology==class)%>%
    
    aov(prop_class ~ temperature * parent, data = .)
  
  qqPlot(residuals(model))

  #Extract the relevant coefficients for interaction of treatment x position
  anova_output <- anova(model)
  coef_summary <- tidy(anova_output)
  coef_summary <- as.data.frame(coef_summary)
  
  #Store the results in the results_table data frame
  results_table <- rbind(results_table, data.frame(Ontology = class,
                                                   Effect = coef_summary["term"],
                                                   DF = coef_summary["df"],
                                                   SumSq = coef_summary["sumsq"],
                                                   F_value = coef_summary["statistic"],
                                                   p_value = coef_summary["p.value"]))
}


results_table<-results_table%>%
  filter(!term=="Residuals")

#apply a p value correction (FDR) for multiple comparisons 
results_table$adj_pvalues <- p.adjust(results_table$p.value, method = "fdr")

#view only p<0.05
results_table_sign<-results_table%>%
  filter(adj_pvalues<=0.05)

results_table_sign

list<-c(results_table_sign$Ontology)
```

     Ontology        term df        sumsq statistic      p.value  adj_pvalues
1     AHexCAS temperature  2 0.0003345747 10.147535 2.539264e-04 5.484810e-03
2      AHexCS      parent  2 0.0185438708 10.286411 2.312780e-04 5.484810e-03
3          CL      parent  2 0.0218972383 28.010323 1.864517e-08 2.013678e-06
4     Cer_ADS      parent  2 0.0276896801 17.926508 2.352073e-06 1.270119e-04
5        DGDG      parent  2 0.0459064060  6.965348 2.441071e-03 3.882885e-02
6    EtherLPE      parent  2 0.0012377785 13.205228 3.553554e-05 1.096525e-03
7   EtherMGDG      parent  2 0.0008023878 21.970836 2.950905e-07 2.124652e-05
8  HexCer_NDS      parent  2 0.0003765059  6.924754 2.516684e-03 3.882885e-02
9        LCAE      parent  2 0.0018770011 12.765934 4.661772e-05 1.258678e-03
10        LPC      parent  2 0.0273479293  9.198133 4.864331e-04 9.551778e-03
11       OxFA      parent  2 0.0960743056 14.724233 1.426868e-05 5.313635e-04
12       SISE      parent  2 0.0001306493  8.984493 5.646436e-04 1.016358e-02
13         SL      parent  2 0.0516161870 43.822892 5.251806e-11 1.134390e-08
14         ST      parent  2 0.0060952440 14.666678 1.476010e-05 5.313635e-04

Plot AHexCAS (sign by temperature) - higher at high temperature.  

```{r}
plot_sign1<-classes%>%
  filter(ontology=="AHexCAS")%>%
  
  ggplot(aes(x=paste(temperature), y=prop_class, color=temperature))+
  facet_wrap(~ontology)+
  geom_boxplot(outliers=FALSE)+
  geom_point()+
  theme_classic()+
  ggtitle("Sterol Lipids")+
  scale_color_manual(values=c("blue", "red", "orange"))+
  scale_x_discrete(limits=c("Ambient", "Moderate (+3)", "High (+6)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1));plot_sign1
```

- AHexCAS = other class of sterol lipids (acylhexosyl campesterol); higher at +6C temperature

```{r}
plot_sign2<-classes%>%
  filter(ontology %in% list)%>%
  filter(!ontology=="AHexCAS")%>%
  
  ggplot(aes(x=paste(parent), y=prop_class, color=parent))+
  facet_wrap(~ontology, scales="free")+
  geom_boxplot(outliers=FALSE)+
  geom_point()+
  theme_classic()+
  scale_color_manual(values=c("orange", "darkred", "darkgray"))+
  #scale_x_discrete(limits=c("Bleached Ambient", "Bleached Moderate (+3)", "Bleached High (+6)", "Nonbleached Ambient", "Nonbleached Moderate (+3)", "Nonbleached High (+6)", "Wildtype Ambient", "Wildtype Moderate (+3)", "Wildtype High (+6)"))+
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1));plot_sign2
```

https://systemsomicslab.github.io/compms/msdial/lipidnomenclature.html

- AHexCS = other class of sterol lipids (acylhexosyl cholesterol); lower in bleached 
- Cer_ADS = Ceramides Sphinogolipids (ceramide alpha-hydroxy fatty acid-dihydrosphingosine); lower in bleached 
- CL = glycerophospholipids (cardiolipin); lower in bleached 
- DGDG = glycerolipids (digalactosyldiacylglycerol); higher in bleached
- EtherLPE = Glycerophospholipids (Ether-linked lysophosphatidylethanolamine); higher in bleached
- EtherMGDG = Glycerolipids (Ether-linked monogalactosyldiacylglycerol); higher in bleached
- HexCer_NDS = Sphingolipids, neutral glycosphingolipids (Hexosylceramide non-hydroxyfatty acid-dihydrosphingosine); higher in bleached 
- LCAE = fatty acid (long-chain aliphatic ester); lower in bleached 
- LPC = Glycerophospholipid (Lysophophatidylcholine); lower in bleached 
- OxFA = Oxidized fatty acids; lower in wildtype, similar in bleached/non bleached
- SISE = Sterol lipids (Sitosterol ester); higher in wiltyp, similar in bleached/non bleached
- SL = Sphingolipids (sulfonolipid); higher in bleached, lowest in wildtype
- ST = Sterol lipids; lower in bleached



