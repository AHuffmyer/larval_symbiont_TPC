---
title: "Metabolomics analysis"
author: "Ariana S Huffmyer"
date: "2024"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

ASK JEN ABOUT METADATA AND UNITS FOR DATA 

# Set Up    

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(purrr)
library(lubridate)
library(ggplot2)
library(broom)
library(cowplot)
library(mixOmics)
library(dplyr)
library(conflicted)
library(vegan)
library(factoextra)
library(ggfortify)
library(RVAideMemoire)
library(ComplexHeatmap)
library(circlize)
library(tibble)
library(viridis)
library(genefilter)

conflict_prefer("select", winner = "dplyr", quiet = FALSE)
conflict_prefer("filter", winner = "dplyr", quiet = FALSE)
conflict_prefer("rename", winner = "dplyr", quiet = FALSE)
```

# Data manipulation and preparations  

## Read in all files 

```{r}
metadata<-read_csv("data/lipids_metabolites/metabolomics/Metabolite_Metadata_Huffmyer_Matthews.csv")%>%rename(tube=`Sample ID`, type=Type, temperature=Temperature, parent=Symbiont)

metabolites<-read_xlsx("data/lipids_metabolites/metabolomics/metabolite_data.xlsx")

protein<-read_csv("data/lipids_metabolites/protein/protein_calculated.csv")
```

Add protein data to the metadata. 

```{r}
metadata$protein.ug<-protein$`Total Protein ug`[match(metadata$tube, protein$Sample)]
```

## Format data and conduct protein normalization 

Format the metabolite data frame in long format to obtain sample names and normalize to total protein. 

```{r}
metabolites<-metabolites%>%
  pivot_longer(names_to = "file", values_to = "area", cols=c(2:74))%>%
  mutate(tube = str_extract(file, "(?<=_)[^_]+(?=_)"))%>%
  mutate(tube = str_remove_all(tube, "M"))

levels(as.factor(metabolites$tube))
levels(as.factor(metadata$tube))
```

Merge in metadata. 
```{r}
metadata<-metadata%>%
  select(tube, type, temperature, parent, protein.ug)

metabolites<-left_join(metabolites, metadata)%>%select(!file)
```

Replace NA's with 0's in the metabolite data frame. 

```{r}
metabolites %>%
  filter(is.na(area)) %>%
  nrow()
# there are many NA's, which need to be replaced with 0

metabolites <- metabolites %>%
  mutate(area = replace_na(area, 0))

metabolites %>%
  filter(is.na(area)) %>%
  nrow()
```

Keep only metabolites that are present in the PBQC samples. 

```{r}
length(unique(metabolites$Name))
#626 metabolites present before filtering 

metabolites <- metabolites %>%
  group_by(Name) %>%
  filter(sum(area[type == "PBQC"]) > 0) %>%
  ungroup()

length(unique(metabolites$Name))
#292 metabolites are present in the PBQC samples 
```

There are 292 out of 626 metabolites present in the PBQC's that will be kept. 

Now filter out PBQC samples. 
```{r}
metabolites<-metabolites%>%
  filter(!type=="PBQC")
```

Now perform blank corrections. 

```{r}
blanks<-metabolites%>%
  filter(type=="Blank")%>%
  group_by(Name)%>%
  summarise(mean_blank=mean(area, na.rm=TRUE))

#add this value back into the master data frame for corrections. 
metabolites<-metabolites%>%
  filter(!type=="Blank")%>%
  left_join(.,blanks)
```

Subtract blank value from each sample's peak value for each metabolite and if the value is negative, replace with 0. 
```{r}
metabolites<-metabolites%>%
  mutate(area_corrected=area-mean_blank)%>%
  mutate(area_corrected = if_else(area_corrected < 0, 0, area_corrected))
  
```

```{r}
test<-metabolites%>%
  filter(area>0)
length(test$area)

#7685 before 

test<-metabolites%>%
  filter(area_corrected>0)
length(test$area_corrected)

#5414 after
```

We now have performed blank correction. 

Normalize corrected area to sample protein. This will generate units of area / ug protein. 

```{r}
metabolites<-metabolites%>%
  mutate(area_normalized=area_corrected/protein.ug)
```

```{r}
test<-metabolites%>%
  filter(area_normalized<.01)

hist(test$area_normalized)

quantile(metabolites$area_normalized)
```

Finally, perform filtering to remove low presence lipids. Our treatment groups are a minimum of n=6 samples per group. Set a threshold that a metabolite must be present at area_normalized>0.01 (non-zero values) in n=6 samples to be included. 
```{r}
metabolites <- metabolites %>%
  group_by(Name) %>%
  filter(sum(area_normalized > 0.01) >= 6) %>%
  ungroup()

length(unique(metabolites$Name))
```
This reduced our data set to 231 metabolites. 

```{r}
hist(metabolites$area_normalized)
quantile(metabolites$area_normalized)
```

We are now ready for anaylsis! 

# Unsupervised analysis 

Conduct a PCA and PERMANOVA to examine the effects of parent and temperature on the metabolome of coral larvae. 

Convert to wide format. 

```{r}
wide_data<-metabolites%>%
  ungroup()%>%
  select(!type)%>%
  select(!protein.ug)%>%
  select(!mean_blank)%>%
  select(!area_corrected)%>%
  select(!area)%>%
  pivot_wider(names_from=Name, values_from=area_normalized)
```

```{r}
wide_data%>%
    select_if(~ any(is.na(.)))
```

No columns have NA's.  

```{r}
wide_data$temperature<-factor(wide_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

wide_data$parent<-factor(wide_data$parent, levels=c("Wildtype", "Bleached", "Nonbleached"))
```

All characteristics are renamed.  

Remove any column that has only 0 values. 

```{r}
wide_data <- wide_data[, colSums(wide_data != 0) > 0]
```
This retained 234/234 metabolites that have non zero values. 

View scree plot. 

```{r}
scaled.pca<-prcomp(wide_data[c(4:234)], scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)
```

Component 1 explains about 20% of variance with approx. <10% explained by components 2+. 

Prepare a PCA plot
```{r}
# scale data
vegan <- scale(wide_data[c(4:234)])

# PerMANOVA 
permanova<-adonis2(vegan ~ parent*temperature, data = wide_data, method='eu')
permanova
```

No significant effect of parent or treatment. 

adonis2(formula = vegan ~ parent * temperature, data = wide_data, method = "eu")
                   Df SumOfSqs      R2      F Pr(>F)
parent              2    544.0 0.03653 0.9663  0.515
temperature         2    536.3 0.03601 0.9526  0.573
parent:temperature  4   1146.3 0.07697 1.0181  0.398
Residual           45  12666.4 0.85050              
Total              53  14893.0 1.00000    

```{r}
pca1<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  geom_text(aes(x = PC1, y = PC2, label = tube), vjust = -0.5)+
  theme_classic()+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pca1
```

Sample L107 and L85 are clear outliers. Remove these sample and plot again. 

```{r}
metabolites<-metabolites%>%
  filter(!tube=="L107")%>%
  filter(!tube=="L85")

wide_data<-wide_data%>%
  filter(!tube=="L107")%>%
  filter(!tube=="L85")

wide_data <- wide_data[, colSums(wide_data != 0) > 0]
```
This kept 234/234 metabolites. 

View scree plot. 

```{r}
scaled.pca<-prcomp(wide_data[c(4:234)], scale=TRUE, center=TRUE) 

fviz_eig(scaled.pca)
```

Component 1 explains about 15% of variance. 

Prepare a PCA plot
```{r}
# scale data
vegan <- scale(wide_data[c(4:234)])

# PerMANOVA 
permanova<-adonis2(vegan ~ parent*temperature, data = wide_data, method='eu')
permanova
```

adonis2(formula = vegan ~ parent * temperature, data = wide_data, method = "eu")
                   Df SumOfSqs      R2      F Pr(>F)
parent              2    532.9 0.03732 0.9414  0.617
temperature         2    517.4 0.03624 0.9140  0.739
parent:temperature  4   1058.5 0.07413 0.9350  0.731
Residual           43  12171.1 0.85232              
Total              51  14280.0 1.00000     

```{r}
pca2<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="parent", loadings=FALSE,  colour="parent", shape="temperature", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_fill_manual(name="Parental Phenotype", values=c("Wildtype"="gray", "Bleached"="orange", "Nonbleached"="brown4"))+
  scale_shape_manual(name="Temperature", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca2

pca2b<-ggplot2::autoplot(scaled.pca, data=wide_data, frame.colour="temperature", loadings=FALSE,  colour="temperature", shape="parent", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_fill_manual(name="Temperature", values=c("blue", "orange", "red"))+
  scale_shape_manual(name="Parental Phenotype", values=c(19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca2b

pca_plots<-plot_grid(pca2, pca2b, ncol=2, nrow=1)

ggsave(pca_plots, filename="figures/metabolites/pca_plots.jpeg", width=12, height=4)
```

View a PCA with treatment code information. 
```{r}
test_wide_data<-wide_data%>%
  mutate(code=paste(parent, temperature))

levels(as.factor(test_wide_data$code))

pca3<-ggplot2::autoplot(scaled.pca, data=test_wide_data, frame.colour="code", loadings=FALSE,  colour="code", shape="code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=4) + 
  scale_color_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_fill_manual(name="Group", values=c("orange", "orange", "orange", "brown4", "brown4", "brown4", "gray", "gray", "gray"))+
  scale_shape_manual(name="Group", values=c(19,17,15,19,17,15,19,17,15))+
  theme_classic()+
   theme(legend.text = element_text(size=14), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=14, face="bold"), 
        axis.text = element_text(size=14), 
        axis.title = element_text(size=14,  face="bold"));pca3

ggsave(pca3, filename="figures/metabolites/pca_all_groups.jpeg", width=8, height=6)
```

# Supervised PLS-DA analysis  

Script modified from the following tutorial: https://mixomicsteam.github.io/Bookdown/plsda.html

## PLS-DA for the effect of parent 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- wide_data

levels(as.factor(X$parent))
levels(as.factor(X$temperature))

Y <- as.factor(X$parent) #select treatment names
Y

X<-X[4:234] #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y, ncomp=2) # 1 Run the method with ncomp = groups -1
plotIndiv(MyResult.plsda)    # 2 Plot the samples

cols<-c("gray", "orange", "brown4") 

pdf("figures/metabolites/PLSDA_Parent.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

View classification plot. 

```{r}
perf.plsda <- perf(MyResult.plsda, validation = 'Mfold', folds = 2, 
                  progressBar = FALSE,  # Set to TRUE to track progress
                  nrepeat = 50)         # We suggest nrepeat = 50

plot(perf.plsda, sd = TRUE, legend.position = 'horizontal')
```

Set model to determine VIPs.  

```{r, message=FALSE}
MyResult.plsda_parent <- plsda(X,Y, ncomp=2) 

#view plsda model again
plotIndiv(MyResult.plsda_parent, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Extract VIP scores 

View the lipids that are most highly differentiating lipids     

```{r}
#extract
parent_VIP <- PLSDA.VIP(MyResult.plsda_parent, graph=TRUE)

parent_VIP_DF <- as.data.frame(parent_VIP[["tab"]])
parent_VIP_DF

# Converting row names to column
parent_VIP_table <- rownames_to_column(parent_VIP_DF, var = "Metabolite")

#filter for VIP > 1
parent_VIP_1 <- parent_VIP_table %>% 
  filter(VIP >= 1)

write_csv(parent_VIP_1, "output/lipids_metabolites/metabolites/Overall_Parent_VIPs.csv")

#plot
parent_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Parent VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("figures/metabolites/Parent_VIP.pdf", width=10, height=15)
parent_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Parent VIP > 1") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation between parent groups.  

Make a list of vips. 
```{r}
parent_vip_list<-parent_VIP_1%>%
  pull(Metabolite)
```
There are 89 VIPs. 

Plot heatmap of z score of lipids across life stages.  

```{r}
# Filter data for VIP metabolites
parent_vip_data <- metabolites %>% filter(Name %in% parent_vip_list)

# Convert counts to Z-scores
parent_vip_data <- parent_vip_data %>% 
  group_by(Name) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(parent, Name)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- parent_vip_data %>% 
  dplyr::select(Name, parent, z_score) %>%
  spread(key = parent, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "Name"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_split=6,
  row_title = "Metabolite", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/metabolites/VIP_heatmap_parent.pdf", width=8, height=15)
draw(heatmap)
dev.off()
```

## PLS-DA for the effect of temperature 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- wide_data

levels(as.factor(X$parent))
levels(as.factor(X$temperature))

Y <- as.factor(X$temperature) #select treatment names
Y

levels(Y)

X<-X[4:234] #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y, ncomp=2) # 1 Run the method with ncomp = groups -1
plotIndiv(MyResult.plsda)    # 2 Plot the samples

cols<-c("blue", "orange", "red") 

pdf("figures/metabolites/PLSDA_Temperature.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

View classification plot. 

```{r}
perf.plsda <- perf(MyResult.plsda, validation = 'Mfold', folds = 2, 
                  progressBar = FALSE,  # Set to TRUE to track progress
                  nrepeat = 50)         # We suggest nrepeat = 50

plot(perf.plsda, sd = TRUE, legend.position = 'horizontal')
```

Set model to determine VIPs.  

```{r, message=FALSE}
MyResult.plsda_temperature <- plsda(X,Y, ncomp=2) 

#view plsda model again
plotIndiv(MyResult.plsda_temperature, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Extract VIP scores 

View the lipids that are most highly differentiating lipids     

```{r}
#extract
temperature_VIP <- PLSDA.VIP(MyResult.plsda_temperature, graph=TRUE)

temperature_VIP_DF <- as.data.frame(temperature_VIP[["tab"]])
temperature_VIP_DF

# Converting row names to column
temperature_VIP_table <- rownames_to_column(temperature_VIP_DF, var = "Metabolite")

#filter for VIP > 1
temperature_VIP_1 <- temperature_VIP_table %>% 
  filter(VIP >= 1)

write_csv(temperature_VIP_1, "output/lipids_metabolites/metabolites/Overall_Temperature_VIPs.csv")

#plot
temperature_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Temperature VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("figures/metabolites/Temperature_VIP.pdf", width=7, height=14)
temperature_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Temperature VIP > 1") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation between temperature groups.  

Make a list of vips. 
```{r}
temperature_vip_list<-temperature_VIP_1%>%
  pull(Metabolite)
```
There are 92 VIPs. 

Plot heatmap of z score of metabolites across temperature.  

```{r}
# Filter data for VIP metabolites
temperature_vip_data <- metabolites %>% filter(Name %in% temperature_vip_list)

# Convert counts to Z-scores
temperature_vip_data <- temperature_vip_data %>% 
  group_by(Name) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(temperature, Name)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

temperature_vip_data$temperature<-factor(temperature_vip_data$temperature, levels=c("Ambient", "Moderate (+3)", "High (+6)"))

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- temperature_vip_data %>% 
  dplyr::select(Name, temperature, z_score) %>%
  spread(key = temperature, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "Name"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_split=4,
  row_title = "Metabolite", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/metabolites/VIP_heatmap_temperature.pdf", width=8, height=15)
draw(heatmap)
dev.off()
```

## PLS-DA for the effect of parent x temperature 

Generate a PLS-DA and plot.  
```{r, results=FALSE}
#assigning datasets 
X <- wide_data

levels(as.factor(X$parent))
levels(as.factor(X$temperature))

X$code<-paste(X$parent, X$temperature)

levels(as.factor(X$code))

Y <- as.factor(X$code) #select treatment names
Y

levels(Y)

X<-X[4:234] #pull only data columns

# run PLSDA 
MyResult.plsda <- plsda(X,Y, ncomp=5) # 1 Run the method with ncomp = groups -1
plotIndiv(MyResult.plsda)    # 2 Plot the samples

cols<-c("orange", "orange3", "orange4", "brown", "brown2", "brown4", "gray", "lightgray", "darkgray") 

pdf("figures/metabolites/PLSDA_interaction.pdf", width=9, height=6)
plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
dev.off() 

plotIndiv(MyResult.plsda, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Temperature", ellipse = FALSE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

View classification plot. 

```{r}
perf.plsda <- perf(MyResult.plsda, validation = 'Mfold', folds = 2, 
                  progressBar = FALSE,  # Set to TRUE to track progress
                  nrepeat = 50)         # We suggest nrepeat = 50

plot(perf.plsda, sd = TRUE, legend.position = 'horizontal')
```

Set model to determine VIPs.  

```{r, message=FALSE}
MyResult.plsda_interaction <- plsda(X,Y, ncomp=5) 

#view plsda model again
plotIndiv(MyResult.plsda_interaction, col=cols, ind.names = FALSE, legend=TRUE, legend.title = "Parent x Temperature", ellipse = TRUE, title="", style = "graphics", centroid=FALSE, point.lwd = 2, cex=2)
```

Extract VIP scores 

View the metabolites that are most highly differentiating metabolites     

```{r}
#extract
interaction_VIP <- PLSDA.VIP(MyResult.plsda_interaction, graph=TRUE)

interaction_VIP_DF <- as.data.frame(interaction_VIP[["tab"]])
interaction_VIP_DF

# Converting row names to column
interaction_VIP_table <- rownames_to_column(interaction_VIP_DF, var = "Metabolite")

#filter for VIP > 1
interaction_VIP_1 <- interaction_VIP_table %>% 
  filter(VIP >= 1)

write_csv(interaction_VIP_1, "output/lipids_metabolites/metabolites/Overall_Interaction_VIPs.csv")

#plot
interaction_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Parent x Temperature VIP") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))


pdf("figures/metabolites/Interaction_VIP.pdf", width=10, height=35)
interaction_VIP_1 %>%
  arrange(VIP) %>%
  ggplot( aes(x = VIP, y = reorder(Metabolite,VIP,sum))) +
  geom_point() +
  ylab("Metabolite") +
  xlab("VIP Score") +
  ggtitle("Interaction VIP > 1") +
  theme_bw() + theme(panel.border = element_rect(linetype = "solid", color = "black"), panel.grid.major = element_blank(), #Makes background theme white
                     panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
dev.off() 
```

These lists represent VIPs that drive separation between parent x temperature groups.  

Make a list of vips. 
```{r}
interaction_vip_list<-interaction_VIP_1%>%
  pull(Metabolite)
```
There are 100 VIPs. 

Plot heatmap of z score of lipids across groups.   

```{r}
# Filter data for VIP metabolites
interaction_vip_data <- metabolites %>% filter(Name %in% interaction_vip_list)

# Convert counts to Z-scores
interaction_vip_data <- interaction_vip_data %>% 
  mutate(code=paste(parent, temperature))%>%
  group_by(Name) %>% 
  mutate(z_score = scale(area_normalized)) %>% 
  group_by(code, Name)%>%
  summarise(z_score = mean(z_score, na.rm=TRUE))%>%
  ungroup()

# Pivot data to have metabolites as rows and lifestage as columns
heatmap_data <- interaction_vip_data %>% 
  dplyr::select(Name, code, z_score) %>%
  spread(key = code, value = z_score)

# Convert to matrix and set rownames
heatmap_matrix <- as.matrix(column_to_rownames(heatmap_data, var = "Name"))

# Create the heatmap
heatmap <- Heatmap(
  heatmap_matrix,
  name = "Z-score",
  col = inferno(10),
  cluster_rows = TRUE,
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = TRUE,
  row_split=6,
  row_title = "Lipid", 
  column_names_gp =  gpar(fontsize = 12, border=FALSE),
  column_names_rot = 45,
  row_gap = unit(1, "mm"), 
  border = TRUE,
  row_names_gp = gpar(fontsize = 12, alpha = 0.75, border = FALSE)
)

# Draw the heatmap
draw(heatmap)

dev.off()
pdf("figures/metabolites/VIP_heatmap_parentxtemperature.pdf", width=10, height=15)
draw(heatmap)
dev.off()
```

# Output lists for Metaboanalyst 

List of parental VIPS
```{r}
parent_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/metabolites/parent_VIP_list.csv")
```

List of temperature VIPS
```{r}
temperature_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/metabolites/temperature_VIP_list.csv")
```

List of interaction VIPS
```{r}
interaction_vip_list%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/metabolites/interaction_VIP_list.csv")
```

Full list of lipids
```{r}
full_metabolite_list<-metabolites%>%
  pull(Name)%>%
  unique()%>%
  as.data.frame()%>%
  write_csv(., file="output/lipids_metabolites/metabolites/full_metabolite_list.csv")
```




