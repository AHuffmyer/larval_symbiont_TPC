---
title: "Larval PI Curve Plotting and Analysis - Hawaii 2023" 
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

QC all plots, check all blanks for every run 

Need to bootstrap for model fit and for parameter estimates 

# Setup  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("scales" %in% rownames(installed.packages()) == 'FALSE') install.packages('scales') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("effects" %in% rownames(installed.packages()) == 'FALSE') install.packages('effects') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 
if ("rTPC" %in% rownames(installed.packages()) == 'FALSE') remotes::install_github("padpadpadpad/rTPC")
if ("ggstatsplot" %in% rownames(installed.packages()) == 'FALSE') remotes::install_github("IndrajeetPatil/ggstatsplot")
if ("nls.multstart" %in% rownames(installed.packages()) == 'FALSE') install.packages('nls.multstart')
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom')
if ("boot" %in% rownames(installed.packages()) == 'FALSE') install.packages('boot')

#load packages
library("ggplot2")
library("tidyverse")
library('car')
library('lme4')
library('lmerTest')
library('scales')
library('cowplot')
library('rTPC')
library('ggstatsplot')
library('nls.multstart')
library('broom')
library('boot')
```

# Data visualization and manipulation  

Load data from LoLinR.    
```{r, warning=FALSE, message=FALSE}
pi_data<-read.csv("output/larval_pi_curves/PIcurves_calculated_normalized_photo_rates.csv") #load data
```

Format data. 
```{r, warning=FALSE, message=FALSE}
#remove all rows of wells that did not have samples or blanks
pi_data<-pi_data[!is.na(pi_data$Type),]

#format columns
pi_data$Symbiont<-as.factor(pi_data$Symbiont)
pi_data$SDR<-as.factor(pi_data$SDR)
pi_data$Plate<-as.factor(pi_data$Plate)
```

Look for outliers in the data.  

```{r}
boxplot(pi_data$nmol.org.min)

boxplot(pi_data$nmol.org.min~pi_data$Light_Value)
```

Replace any net negative value with 0, since this indicates no photosynthesis. 
```{r}
pi_data<-pi_data%>%
  mutate(nmol.org.min=if_else(nmol.org.min<0 & Light_Value>0, 0, nmol.org.min)) 
```

View data. Remove outliers. 
```{r}
boxplot(pi_data$nmol.org.min~pi_data$Light_Value)

#pi_data<-pi_data%>%filter(nmol.org.min<0.06)

#boxplot(pi_data$P.nmol.org.min~pi_data$PAR)
```

Log transform the data.
```{r}
pi_data<-pi_data%>%
  mutate(nmol.org.min=log10(nmol.org.min+1))

boxplot(pi_data$nmol.org.min~pi_data$Light_Value)
```

Calculate mean temperature values for each run.    

```{r}
pi.temps<-read.csv("output/larval_pi_curves/mean_temperature_by_plate_and_light_interval.csv")

pi.temps$Plate <- as.integer(sub("(?i)^plate", "", pi.temps$Plate, perl = TRUE))  # removes leading "Plate"
```

Add temperature data to master data frame.  
```{r}
pi_data$Plate<-as.integer(as.character(pi_data$Plate))
pi.temps$SDR<-as.factor(pi.temps$SDR)

str(pi_data)
str(pi.temps)

pi_data<-left_join(pi_data,pi.temps)

#round to 0.1°C 
pi_data<-pi_data%>%
  mutate(Temp.C=round(Mean_T_internal_C,1))
```

# Plot photosynthesis over PAR treatments  

Plot data with means   
```{r}
pi_plot1<-pi_data %>%
    group_by(Light_Value, Symbiont)%>%
    dplyr::summarise(mean=mean(nmol.org.min, na.rm=TRUE), sd=sd(nmol.org.min, na.rm=TRUE), N=length(nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = as.factor(Light_Value), y = mean, group=interaction(PAR, Symbiont))) +
    geom_hline(yintercept=0, linetype="dashed", color="black", linewidth=0.75)+
    geom_point(aes(group=interaction(Light_Value, Symbiont), colour=Symbiont), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(Light_Value, Symbiont)), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Light") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_plot1

ggsave("figures/larval_pi_curves/pi_means.png", pi_plot1, dpi=300, w=7, h=5, units="in")
```

Display with plate. 
```{r}
pi_plot1a<-pi_data %>%
    group_by(Light_Value, Symbiont, Plate)%>%
    dplyr::summarise(mean=mean(nmol.org.min, na.rm=TRUE), sd=sd(nmol.org.min, na.rm=TRUE), N=length(nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = as.factor(Light_Value), y = mean, group=interaction(Light_Value, Symbiont))) +
    facet_wrap(~Plate)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(Light_Value, Symbiont), colour=Symbiont), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(Light_Value, Symbiont)), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Light (PAR)") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_plot1a
```

Plot data with a loess line   
```{r}
pi_plot2<-pi_data %>%
    
    ggplot(., aes(x = as.factor(Light_Value), y = nmol.org.min, group=Symbiont)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_smooth(aes(color=Symbiont, group=Symbiont), method="loess", alpha=0.4, se=FALSE)+
    xlab("Light (PAR)") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_plot2

ggsave("figures/larval_pi_curves/pi_loess.png", pi_plot2, dpi=300, w=7, h=5, units="in")
```

View by plate. 
```{r}
pi_plot2b<-pi_data %>%
    
    ggplot(., aes(x = as.factor(Light_Value), y = nmol.org.min, group=Symbiont)) +
    facet_wrap(~Plate)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_smooth(aes(color=Symbiont, group=Symbiont), method="loess", alpha=0.4, se=FALSE)+
    xlab("Light (PAR)") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_plot2b
```

Similar curves between plates, proceed with using average of the two plates. 

# View respiration 

View by plate. 
```{r}
pi_plot3<-pi_data %>%
    group_by(Light_Value, Symbiont)%>%
    filter(Light_Value=="0")%>%
    dplyr::summarise(mean=mean(nmol.org.min, na.rm=TRUE)*-1, sd=sd(nmol.org.min, na.rm=TRUE), N=length(nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = as.factor(Light_Value), y = mean, group=interaction(PAR, Symbiont))) +
    #facet_wrap(~Plate)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(Light_Value, Symbiont), colour=Symbiont), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(Light_Value, Symbiont)), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Light (PAR)") + 
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    #ylim(0, 0.05)+
    theme_classic() + 
    theme(
      legend.position="right",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12)
      ); pi_plot3
```

Run anova on values 
```{r}
model<-aov(nmol.org.min~as.factor(Light_Value)*Symbiont, data=pi_data)
summary(model)

library("emmeans")

emm<-emmeans(model, ~ Symbiont | Light_Value)
pairs(emm)
```
PAR is significant, symbiont is just barely not significant. 

# Apply PI curve calculations and models 

## Fitting PI Curves 

Scripts for this section based on E5 PI curve analysis in the time series repository. 

Define data 
```{r}
#specify data
pi_data$Light_Value <- as.numeric(pi_data$Light_Value)
pi_data$Pc <- as.numeric(pi_data$nmol.org.min)
```

Define PI curve function as a nonlinear Least Squares regression of a quadratic fit, test nls fit

Aquatic Photosynthesis, Falkowski   
Pmax = max photosynthesis (Am from Bayesian script)  
alpha = quantum yeild (AQY from Bayesian script)  
I/E = irradiance (PAR from Bayesian script)  
Rd = dark respiration   
Ik = saturating irradiance 

Next run NLS models.

Using fixed initial values (not using, but keeping for reference):  

```{r}
#nest <- nest_legacy
#unnest <- unnest_legacy

#nls_data <- pi_data %>% 
#   mutate(new_Pc=Pc+1)%>%
#   group_by(Tank) %>%
#   nest(-Tank) %>%
#   mutate(model1 = map(data, ~ 
#                        nls(new_Pc ~ (Am*((AQY*PAR)/(sqrt(Am^2 + (AQY*PAR)^2)))-Rd), data=., start=list(Am=0.05,  AQY=0.001, Rd=-0.02)) %>%
#                             tidy %>%
#                             dplyr::select(term, estimate) %>% 
#                             spread(term, estimate))) %>%
#  unnest(model1) %>%
#  mutate(Ik = Am/AQY) 
```

Using flexible initial values based on input data:

```{r}
nest <- nest_legacy
unnest <- unnest_legacy

#pi_data<-pi_data%>%
  #mutate(new_Pc=Pc+1)

nls_data <- pi_data %>% 
   group_by(Symbiont) %>%
   nest(-Symbiont) %>%
   mutate(model1 = map(data, ~ 
                         nls(Pc ~ (Am*((AQY*Light_Value)/(sqrt(Am^2 + (AQY*Light_Value)^2)))-Rd), data=., start=list(Am=(max(.$Pc)-min(.$Pc)),  AQY=0.001, Rd=-min(.$Pc)), trace=TRUE) %>%
                              tidy %>%
                              dplyr::select(term, estimate) %>% 
                              spread(term, estimate))) %>%
  unnest(model1) %>%
  mutate(Ik = Am/AQY) %>%
  mutate(Ic=(Am*Rd)/(AQY*(sqrt(Am^2-Rd^2))))

#save 
pi_results<-nls_data

pi_results
```

Plot curve over data points.  
```{r}
augmented <- pi_data %>% 
  nest(-Symbiont) %>% 
  mutate(
    fit = map(data, ~ nls(Pc ~ (Am*((AQY*Light_Value)/(sqrt(Am^2 + (AQY*Light_Value)^2)))-Rd), data=., start=list(Am=0.5,  AQY=0.001, Rd=.4))),
    augmented = map(fit, augment),
  ) %>% 
  unnest(augmented)

#all together
curve_plot1<-augmented %>%
  group_by(Symbiont)%>%
  qplot(Light_Value, Pc, data = ., geom = 'point', colour = Symbiont, alpha=I(0.2)) +
  geom_line(aes(y=.fitted), size=2)+
  scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
  theme(legend.position="right")+
  xlab("Light (PAR)")+
  ylab(expression(P[MAX]))+
  ggtitle("")+
  theme_classic()+
  #ylim(-0.005, 0.01)+ 
    theme(legend.position="none", 
        text=element_text(size=14, color="black"), 
        axis.title=element_text(size=14, color="black"), 
        axis.text.x=element_text(size=14, color="black", angle=45, hjust=1, vjust=1),
        axis.text.y=element_text(size=14, color="black"),
        title = element_text(size=14, color="black"));curve_plot1

ggsave("figures/larval_pi_curves/nls_curves_all.png", width=6, height=6, dpi=500)
```

View separated by individual. 
```{r}
#view individual plots
curve_plot2<-augmented %>%
  ggplot() +
  facet_wrap(~Symbiont)+
          geom_point(aes(Light_Value, Pc, group=Symbiont, color=Symbiont)) + 
          geom_line(aes(y=.fitted, x=Light_Value), size=2) + 
          scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
          theme_classic()+
          labs(x = expression(paste('Light (', mu, "mol photons m"^-2, 's'^-1,")")),
               y = expression(paste('Photosynthetic rate (nmol larva'^-1, 'min'^-1,")")));curve_plot2

ggsave("figures/larval_pi_curves/nls_curves_individual.png", width=10, height=6, dpi=500)
```

Plot PI curve metrics. 

```{r}
metrics_plot1<-pi_results%>%
  pivot_longer(values_to="Value", names_to="Parameter", cols=c(Am:Ic))%>%
  filter(Parameter %in% c("Ik", "Ic"))%>%
  
  ggplot(aes(x=Symbiont, y=Value, color=Symbiont))+
    facet_wrap(~Parameter)+
    geom_point(aes(), size=4) +
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    theme_classic()+
    theme(legend.position="none");metrics_plot1

metrics_plot1a<-pi_results%>%
  pivot_longer(values_to="Value", names_to="Parameter", cols=c(Am:Ic))%>%
  filter(!Parameter=="Ik")%>%
  filter(!Parameter=="Ic")%>%
  
  ggplot(aes(x=Symbiont, y=Value, color=Symbiont))+
    facet_wrap(~Parameter)+
    geom_point(aes(), size=4) +
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    theme_classic();metrics_plot1a

metrics_plot<-plot_grid(metrics_plot1, metrics_plot1a, nrow=1, ncol=2, rel_widths=c(0.8,1))

ggsave("figures/larval_pi_curves/parameters.png", metrics_plot, width=10, height=6, dpi=300)
```

# Apply PI curve to each individual well

```{r}
# Nest by Symbiont and unique replicate
test <- pi_data %>%
  group_by(Symbiont, unique) %>%
  nest() %>%
  mutate(
    model = map(data, ~ {
      tryCatch(
        nls(
          Pc ~ (Am * ((AQY * Light_Value) / sqrt(Am^2 + (AQY * Light_Value)^2)) - Rd),
          data = .x,
          start = list(
            Am = max(.x$Pc, na.rm = TRUE) - min(.x$Pc, na.rm = TRUE),
            AQY = 0.001,
            Rd = -min(.x$Pc, na.rm = TRUE)
          ),
          trace = FALSE
        ),
        error = function(e) NULL
      )
    }),
    tidied = map(model, ~ if (!is.null(.x)) tidy(.x) else NULL)
  ) %>%
  filter(!map_lgl(tidied, is.null)) %>%
  unnest(tidied) %>%
  select(!c(std.error, statistic, p.value))%>%
  pivot_wider(names_from = term, values_from = estimate) %>%
  mutate(
    Ik = Am / AQY,
    Ic = (Am * Rd) / (AQY * sqrt(Am^2 - Rd^2))
  )

head(test)
```

Now plot parameters based on individual well calculations.  

Check for outliers. 
```{r}
hist(test$Am) #remove <0
hist(test$AQY) 
hist(test$Rd)
hist(test$Ik) #remove one upper outliers 
hist(test$Ic) #remove upper and lower outlier
```

Remove outliers
```{r}
test<-test%>%
  mutate(
    Am = ifelse(Am > 0, Am, NA),
    Ik = ifelse(Ik < 100, Ik, NA),
    Ic = ifelse(Ic < 50 & Ic > 0, Ic, NA)
  )

hist(test$Am) 
hist(test$AQY) 
hist(test$Rd)
hist(test$Ik)  
hist(test$Ic) 
```

```{r}
metrics_plot2<-test%>%
  pivot_longer(cols=c(Am:Ic), names_to="Parameter", values_to="value")%>%
  
  mutate(Symbiont = fct_recode(Symbiont,
                               Bleached = "C",
                               Nonbleached = "MIX",
                               Wildtype = "WT"))%>%
  
  ggplot(aes(x=Symbiont, y=value, color=Symbiont))+
    facet_wrap(~Parameter, scales="free", ncol=3, nrow=2)+
      geom_boxplot()+
    geom_point(aes(), size=1) +
    #geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1)+
    scale_color_manual(name="Symbiont", values=c("orange","brown4", "gray"))+
    theme_classic()+
  ggtitle("B")+
    ylab("Parameter Value")+
    xlab("")+
    theme(legend.position="none", 
          axis.text.x=element_blank());metrics_plot2

ggsave("figures/larval_pi_curves/parameters_individual_wells.png", metrics_plot2, width=6, height=5, dpi=300)
```

Test for significance in parameters. 

```{r}
anova_results <- test %>%
  pivot_longer(cols=c(Am:Ic), names_to="Parameter", values_to="value")%>%
  group_by(Parameter) %>%
  dplyr::summarise(
    anova = list(aov(value ~ Symbiont, data = cur_data())),
    tidy_anova = list(broom::tidy(aov(value ~ Symbiont, data = cur_data())))
  ) %>%
  unnest(tidy_anova) %>%
  filter(term == "Symbiont") 

anova_results
```

No differences in PI curve values. 

Now plot PI curves with error bars for individuals.  

```{r}
augmented <- pi_data %>%
  group_by(Symbiont, unique) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ tryCatch(
      nls(Pc ~ (Am * ((AQY * Light_Value) / sqrt(Am^2 + (AQY * Light_Value)^2)) - Rd),
          data = .x,
          start = list(Am = 0.5, AQY = 0.001, Rd = 0.4)),
      error = function(e) NULL
    )),
    augmented = map2(fit, data, ~ if (!is.null(.x)) augment(.x, newdata = .y) else NULL)
  ) %>%
  filter(!map_lgl(augmented, is.null)) %>%
  unnest(augmented)
```

```{r}
curve_plot1 <- ggplot(augmented, aes(x = Light_Value, y = Pc, group = unique, color = Symbiont)) +
  geom_point(alpha = 0.2) +
  geom_line(aes(y = .fitted), size = 1) +
  scale_color_manual(name = "Symbiont", values = c("orange", "brown4", "gray")) +
  theme_classic() +
  labs(x = "Light (PAR)", y = expression(P[MAX])) +
  ylim(-0.005, 0.01) +
  theme(
    legend.position = "right",
    text = element_text(size = 14, color = "black"),
    axis.title = element_text(size = 14, color = "black"),
    axis.text.x = element_text(size = 14, color = "black", angle = 45, hjust = 1, vjust = 1),
    axis.text.y = element_text(size = 14, color = "black"),
    legend.title = element_text(size = 14)
  );curve_plot1
```

Now view a mean plot for each symbiont type with error bars. 

```{r}

# 1. Create a PAR sequence for prediction
par_seq <- pi_data$Light_Value

# 2. Get model parameters per replicate
param_df <- pi_data %>%
  group_by(Symbiont, unique) %>%
  nest() %>%
  mutate(
    fit = map(data, ~ tryCatch(
      nls(Pc ~ (Am * ((AQY * Light_Value) / sqrt(Am^2 + (AQY * Light_Value)^2)) - Rd),
          data = .x,
          start = list(Am = 0.5, AQY = 0.001, Rd = 0.4)),
      error = function(e) NULL
    ))
  ) %>%
  filter(!map_lgl(fit, is.null)) %>%
  mutate(
    params = map(fit, ~ broom::tidy(.x) %>% select(term, estimate) %>% pivot_wider(names_from = term, values_from = estimate))
  ) %>%
  unnest(params)

# 3. Predict fitted curves from each replicate
predicted_curves <- param_df %>%
  mutate(preds = pmap(list(Am, AQY, Rd), function(Am, AQY, Rd) {
    tibble(
      Light_Value = par_seq,
      Pc_fit = Am * ((AQY * par_seq) / sqrt(Am^2 + (AQY * par_seq)^2)) - Rd
    )
  })) %>%
  select(Symbiont, unique, preds) %>%
  unnest(preds)%>%
  unique()

# 4. Summarize mean and SE
summary_curves <- predicted_curves %>%
  group_by(Symbiont, Light_Value) %>%
  dplyr::summarise(
    fit_mean = mean(Pc_fit, na.rm = TRUE),
    fit_se = sd(Pc_fit, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

str(summary_curves)

# run model on PI curves# run model on PI curves
model<-aov(fit_mean ~ Symbiont * Light_Value, data=summary_curves)
summary(model)

emm<-emmeans(model, ~Symbiont)
pairs(emm)

str(summary_curves)

# 5. Plot mean ± SE ribbon
curves_plot<-ggplot(summary_curves, aes(x = Light_Value, y = fit_mean, color = Symbiont, fill = Symbiont)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = fit_mean - fit_se, ymax = fit_mean + fit_se), alpha = 0.3, linetype = 0) +
  scale_color_manual(values = c("orange", "brown4", "gray")) +
  scale_fill_manual(values = c("orange", "brown4", "gray")) +
  theme_classic() +
  ylim(-0.005, 0.01) +
    scale_color_manual(name="Parent", labels=c("Bleached", "Nonbleached", "Wildtype"), values = c("orange", "brown4", "gray")) +
  scale_fill_manual(name="Parent", labels=c("Bleached", "Nonbleached", "Wildtype"), values = c("orange", "brown4", "gray")) +
  labs(x = expression(paste('PAR (', mu, "mol photons m"^-2, 's'^-1,")")),
               y = expression(paste('Photosynthetic rate (nmol larva'^-1, 'min'^-1,")")))+
  ggtitle("A")+
  theme(
    text = element_text(size = 14),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.position = "right"
  );curves_plot
  
ggsave("figures/larval_pi_curves/pi_curves_individual_wells.png", curves_plot, width=6, height=5, dpi=300)
```
