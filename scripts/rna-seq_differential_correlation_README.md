# RNAseq Differential Correlation/Network Analysis

## Overview

This script (`rna-seq_differential_correlation.Rmd`) performs differential correlation and network analysis on RNAseq data to identify gene hubs and clusters characteristic of each parent/phenotype and how these change in response to temperature.

## Purpose

Traditional differential expression analysis identifies genes whose mean expression levels change between conditions. However, it misses important regulatory changes where gene relationships (correlations) change without significant changes in mean expression. This analysis:

- Identifies gene pairs or modules whose correlation structure changes between phenotypes or temperature treatments
- Detects subtle regulatory shifts beyond mean expression changes
- Reveals which pathways are rewired under thermal stress
- Identifies hub genes that are central to regulatory networks

## Method

The script uses **DGCA (Differential Gene Correlation Analysis)** to:
1. Calculate gene-gene correlations in different conditions (e.g., 27°C vs 33°C)
2. Statistically test whether correlations differ between conditions
3. Identify gene pairs with significant correlation changes
4. Build network diagrams showing regulatory rewiring
5. Identify hub genes with many differential correlations

## Requirements

### Input Files
Generated by `rna-seq_DEG.Rmd`:
- `output/rna_seq/all_genes.csv` - VST-normalized gene count matrix
- `data/rna_seq/sample_rnaseq_metadata.csv` - Sample metadata

### R Packages
Install required packages:
```r
# BiocManager packages
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("DGCA")

# CRAN packages
install.packages(c("tidyverse", "pheatmap", "igraph", 
                   "ggraph", "viridis", "gridExtra", "RColorBrewer"))
```

## Analysis Workflow

### 1. Data Preparation
- Loads VST-normalized gene counts from `all_genes.csv`
- Filters genes by coefficient of variation (CV > 0.1)
- Selects top 5000 most variable genes for analysis
  - This makes computation manageable while focusing on biologically relevant genes

### 2. Differential Correlation Analysis

The script performs multiple comparisons:

#### By Parent Phenotype at Each Temperature
- Nonbleached vs Wildtype at 27°C
- Nonbleached vs Bleached at 27°C
- Nonbleached vs Wildtype at 33°C
- Nonbleached vs Bleached at 33°C

#### By Temperature within Each Phenotype
- Wildtype: 27°C vs 33°C
- Bleached: 27°C vs 33°C
- Nonbleached: 27°C vs 33°C

### 3. Visualization

#### Differential Network Diagrams
Shows gene networks with edges (correlations) colored by type:
- **Blue**: Edges gained (correlation appears in second condition)
- **Red**: Edges lost (correlation disappears in second condition)
- **Orange**: Edges changed (correlation present in both but different)

Generated for each phenotype comparing 27°C vs 33°C.

#### Correlation Difference Heatmaps (Δr)
Shows the magnitude of correlation changes between conditions for top hub genes.

Generated for each phenotype comparing 27°C vs 33°C.

#### Hub Gene Plots
Bar charts showing genes with the most differential correlations, indicating key regulatory nodes.

## Outputs

### Figures
All saved to `figures/rna_seq/`:

**Network Diagrams:**
- `diff_network_wildtype_27v33.pdf/png`
- `diff_network_bleached_27v33.pdf/png`
- `diff_network_nonbleached_27v33.pdf/png`

**Correlation Heatmaps:**
- `diff_corr_heatmap_wildtype_27v33.pdf/png`
- `diff_corr_heatmap_bleached_27v33.pdf/png`
- `diff_corr_heatmap_nonbleached_27v33.pdf/png`

**Hub Gene Comparison:**
- `hub_genes_comparison.pdf/png`

### Data Files
All saved to `output/rna_seq/differential_correlation/`:

**Temperature Comparisons:**
- `dgca_wildtype_27v33.csv`
- `dgca_bleached_27v33.csv`
- `dgca_nonbleached_27v33.csv`

**Parent Comparisons:**
- `dgca_NB_vs_WT_27C.csv`
- `dgca_NB_vs_B_27C.csv`
- `dgca_NB_vs_WT_33C.csv`
- `dgca_NB_vs_B_33C.csv`

**Hub Genes:**
- `hub_genes_wildtype_27v33.csv`
- `hub_genes_bleached_27v33.csv`
- `hub_genes_nonbleached_27v33.csv`

## Interpretation

### What the Results Tell You

1. **Significant Differential Correlations**: Gene pairs whose relationship changes between conditions
   - Indicates regulatory rewiring
   - May reveal stress response mechanisms

2. **Hub Genes**: Genes appearing in many differential correlations
   - Central regulatory nodes
   - Potential targets for further investigation
   - May be key to phenotype-specific thermal responses

3. **Network Changes**:
   - **Edges Gained**: New regulatory relationships at high temperature
   - **Edges Lost**: Regulatory relationships that break down under stress
   - **Edges Changed**: Altered strength or direction of regulation

4. **Phenotype Differences**: 
   - Different hub genes between phenotypes suggest distinct regulatory strategies
   - More differential correlations may indicate greater regulatory plasticity

## Running the Script

1. Ensure you have run `rna-seq_DEG.Rmd` first to generate required input files
2. Install required R packages (see above)
3. Open `rna-seq_differential_correlation.Rmd` in RStudio
4. Run chunks sequentially or knit the entire document
5. Check `figures/rna_seq/` and `output/rna_seq/differential_correlation/` for results

## Computational Considerations

- **Runtime**: Analysis may take 30-60 minutes depending on your system
  - Most time spent on permutation testing (nPerm = 100)
- **Memory**: Requires ~4-8 GB RAM
- **Filtering**: Script uses top 5000 genes to balance:
  - Biological relevance (high variation genes)
  - Computational feasibility
  - Statistical power

## Customization

You can modify the script to:

1. **Change gene filtering**:
   - Adjust CV threshold (line ~78)
   - Change number of top genes (line ~84)

2. **Adjust statistical stringency**:
   - Modify p-value threshold (currently 0.05)
   - Change number of permutations (currently 100, increase for more robust results)

3. **Visualization parameters**:
   - Number of edges shown in network (top_n parameter)
   - Number of genes in heatmap (top_genes parameter)

## References

- McKenzie, A.T. et al. (2016) DGCA: A comprehensive R package for Differential Gene Correlation Analysis. *BMC Systems Biology* 10:106
- Zhang, B. & Horvath, S. (2005) A general framework for weighted gene co-expression network analysis. *Statistical Applications in Genetics and Molecular Biology* 4:17

## Contact

For questions about this analysis, contact the Putnam Lab or open an issue in the repository.
